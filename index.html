<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silhouette Diagnostic Consultants</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
         
        :root {
            --primary: #0e4a7c;
            --primary-light: #1565a0;
            --accent: #14b8a6;
            --accent-light: #2dd4bf;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --sidebar-bg: #1a3d5c;
        }

        html.dark-mode {
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --sidebar-bg: #0f172a;
        }

        /* Color theme palettes */
        /* Blue Theme (default) */
        html.theme-blue {
            --primary: #0e4a7c;
            --primary-light: #1565a0;
            --accent: #14b8a6;
            --accent-light: #2dd4bf;
        }

        /* Skyblue Theme */
        html.theme-skyblue {
            --primary: #0369a1;
            --primary-light: #0284c7;
            --accent: #06b6d4;
            --sidebar-bg: #0369a1;
            --accent-light: #22d3ee;
        }

        /* Gray Theme */
        html.theme-gray {
            --primary: #374151;
            --primary-light: #4b5563;
            --accent: #6b7280;
            --accent-light: #9ca3af;
            --sidebar-bg: #374151;
        }

        /* Brown Theme */
        html.theme-brown {
            --primary: #92400e;
            --primary-light: #b45309;
            --accent: #a16207;
            --accent-light: #ca8a04;
            --sidebar-bg: #92400e;
        }

        /* Green Theme */
        html.theme-green {
            --primary: #166534;
            --primary-light: #15803d;
            --accent: #059669;
            --accent-light: #10b981;
            --sidebar-bg: #166534;
        }

        /* Purple Theme */
        html.theme-purple {
            --primary: #6b21a8;
            --primary-light: #7e22ce;
            --accent: #9333ea;
            --accent-light: #a855f7;
            --sidebar-bg: #6b21a8;
        }

* {
            --tw-bg-opacity: 1;
            --tw-text-opacity: 1;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Added comprehensive animation keyframes */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .animate-slide-in {
            animation: slideInLeft 0.5s ease-out;
        }

        .animate-slide-up {
            animation: slideInUp 0.5s ease-out;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-pop {
            animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-secondary);
            padding: 0.5rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: var(--background);
        }

        .card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* Added card hover animation */
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 2rem 2rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            transition: all 0.3s;
        }
        

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-role {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-left: 1rem;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.95rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .quick-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .quick-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .quick-card.accent {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 1.5rem 1rem;
            overflow-y: auto;
            transition: width 0.3s, transform 0.3s;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 1.25rem;
            font-weight: 700;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .sidebar-logo {
            opacity: 0;
            visibility: hidden;
            width: 0;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
            text-decoration: none;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nav-item-icon {
            font-size: 1.25rem;
            min-width: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-label {
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .nav-item-label {
            opacity: 0;
            visibility: hidden;
            width: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-container {
            margin-left: 280px;
            transition: margin-left 0.3s;
        }

        .main-container.sidebar-collapsed {
            margin-left: 80px;
        }

        .main-content {
            padding: 0 2rem 2rem 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 74, 124, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background-color: var(--background);
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .table tr:hover {
            background-color: var(--background);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .badge-primary {
            background-color: rgba(14, 74, 124, 0.1);
            color: var(--primary);
        }

        .wizard-step {
            margin-bottom: 2rem;
        }

        .wizard-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .step-number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .step-indicator.active .step-number {
            background-color: var(--primary);
            color: white;
        }

        .step-indicator.completed .step-number {
            background-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .step-indicator.active .step-label {
            color: var(--primary);
        }

        .step-indicator.completed .step-label {
            color: var(--success);
        }

        .section-container {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .stat-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(14, 74, 124, 0.2);
        }

        .stat-box.accent {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .responsive-table-wrapper {
            overflow-x: auto;
        }

        /* Added payment method styles */
        .payment-method {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .payment-option {
            flex: 1;
            min-width: 150px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: var(--surface);
        }

        .payment-option:hover {
            border-color: var(--primary);
            background-color: rgba(14, 74, 124, 0.05);
        }

        .payment-option.active {
            border-color: var(--primary);
            background-color: rgba(14, 74, 124, 0.1);
            font-weight: 600;
        }

        /* Added payment status badge styles */
        .badge-full {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-installment {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* Added chart bar animation */
        .chart-bar {
            transition: all 0.3s ease;
            border-radius: 0.25rem;
        }

        .chart-bar:hover {
            opacity: 0.8;
            filter: brightness(1.1);
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .chart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chart-label {
            min-width: 200px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .chart-bar-container {
            flex: 1;
            height: 40px;
            background-color: var(--background);
            border-radius: 0.25rem;
            overflow: hidden;
            position: relative;
        }

        .chart-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Added filter section styles */
        .filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
        }

        .filter-group button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .filter-group button:hover {
            background-color: var(--primary-light);
        }

        /* Added theme option styles */
        .theme-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--surface);
        }

        .theme-option:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 74, 124, 0.1);
        }

        .theme-option.active {
            border-color: var(--primary);
            background-color: rgba(14, 74, 124, 0.05);
        }

        .theme-preview {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
        }

        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: var(--background);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .mode-toggle-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            background-color: transparent;
            color: var(--text-secondary);
        }

        .mode-toggle-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .color-swatch {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-swatch.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        .settings-card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: slideInUp 0.5s ease-out;
        }

        .settings-card-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-area, #printable-area * {
                visibility: visible;
            }
            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        .autocomplete-box {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  max-height: 220px;
  overflow-y: auto;
  z-index: 999;
  display: none;
}

.autocomplete-item {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 14px;
}

.autocomplete-item:hover {
  background: #f3f4f6;
}

    
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ====== APPLICATION STATE & MOCK DATA ======
        const appState = {
            currentUser: null,
            currentView: 'login',
            drafts: [], // To store billing drafts
            billingStep: 1,
            sidebarCollapsed: false,
            showAddPRForm: false, // State for PR form visibility
            showAddInventoryForm: false, // State for Inventory form visibility
            showAddStaffForm: false, // State for Staff form visibility
            editingPRId: null, // To track which PR is being edited
            viewingOrderId: null, // To track which order is being viewed in detail
            editingInventoryId: null, // To track which inventory item is being edited
            inventorySearchQuery: '', // To hold the search query for the inventory page
            showFullDailyRecord: false, // For PR daily records
            dailyRecordViewDate: new Date(), // For PR daily records
            companyProfile: {
                name: 'Silhouette Diagnostic Consultants'
,
                address: 'No.12 Kudang street off monrovia street wuse2, opp Banex plaza, Abuja, Nigeria',
                email: 'contact@silhouettediagnostics.com',
                contact: '+234-903-000-2653',
                logo: 'company icon.png' // Default logo/icon
            },
            theme: 'light', // light or dark
            colorTheme: 'blue', // blue, skyblue, gray, brown, green, purple
            billingData: {
                patientName: '',
                pid: '',
                contact: '',
                referredBy: '',
                staffName: '', // Added staff name field
                selectedServices: [],
                // When VIP mode is enabled, selectedServices items may include an `overridePrice` field
                discount: 0,
                total: 0,
                paymentMethod: 'cash',
                amountPaid: 0, // For installment payments
                balance: 0, // For installment payments
                paymentStatus: 'full' // Added payment status field (full/installment)
                ,
                splitPayments: { cash: 0, pos: 0, transfer: 0 }            },
            vipMode: false,
            recordFilters: { // Added record filter state
                date: '',
                month: '',
                year: '',
                time: ''
,
                filterType: 'all'
                ,
                searchQuery: '', // For patient name/PID search
                dailySummaryDate: new Date(),
                prManagementSearchQuery: '',
                searchAllRecords: false // To toggle between daily and all-time record search
            }
        }; 
        appState.analyticsDateRange = {
            start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
            end: new Date().toISOString().split('T')[0]
        };

        appState.showFullDailyTestRecord = false;
        appState.dailyTestRecordViewDate = new Date();
        appState.showFullDailyCommissionReport = false;
        appState.dailyCommissionViewDate = new Date();
        appState.historySearchQuery = '';
        appState.recordsViewDate = new Date(); // Add this for the records page pagination
        appState.recordsViewDate = new Date();
        appState.historyFilters = { // Added history filter state
            user: '',
            action: '',
            startDate: '',
            endDate: ''
        };

        // VIP form mode to allow manual price overrides for selected services
        // NOTE: stored on appState so render() can pick it up
        // (we'll use `appState.vipMode` elsewhere)
        // add below to keep object shape consistent
        // (this will be moved into the main object in the next patch if needed)

        // Add pagination state for analytics tables
        appState.analytics = {
            prPerformancePage: 0,
            historyPage: 0
        };

        // Selected month for hospital performance (type: Date). Defaults to current month.
        appState.hospitalPerformanceMonth = new Date();

        // Users - Initially empty; to be managed by admin in production
        let users = [];

        // Mock Data - PR List (Original Contacts)
        let prList = [
            { id: 1, name: 'Dr Abdulraheem Arewa', phone: '0906 499 8324' },
            { id: 2, name: 'Dr Abdulraheem Wdh', phone: '0807 573 2276' },
            { id: 3, name: 'Dr Abdulsalem Wdh', phone: '0806 895 4927' },
            { id: 4, name: 'Dr Abduseli Fmc', phone: '0903 324 0160' },
            { id: 5, name: 'Dr Abegunde Babatunde', phone: '0703 800 9824' },
            { id: 6, name: 'Dr Abel (Daughter Of Charity)', phone: '0909 511 0075' },
            { id: 7, name: 'Dr Abiodun ( Chem Health)', phone: '0907 188 3711' },
            { id: 8, name: 'Dr Abioye Ferepod', phone: '0815 272 3205' },
            { id: 9, name: 'Dr Abubakar', phone: '0809 966 5102' },
            { id: 10, name: 'Dr Abubakar (Mbph)', phone: '0706 834 6935' },
            { id: 11, name: 'Dr Abubakar Fmc', phone: '0812 933 3737' },
            { id: 12, name: 'Dr Abubakar H GGH', phone: '0809 444 9487' },
            { id: 13, name: 'Dr Abubakar Mdh', phone: '0817 574 4430' },
            { id: 14, name: 'Dr Abubakar Wdh', phone: '0806 003 4307' },
            { id: 15, name: 'Dr Adamu GGH', phone: '+234 903 400 3357' },
            { id: 16, name: 'Dr Adamu (A&E) Mdh', phone: '0806 820 9054' },
            { id: 17, name: 'Dr Adaobi FMC', phone: '0814 756 6233' },
            { id: 18, name: 'Dr Adedeji Cardiologist', phone: '+234 803 760 1383' },
            { id: 19, name: 'Dr Adejumo Wdh', phone: '0803 723 3550' },
            { id: 20, name: 'Dr Ademola Fmc', phone: '0803 451 9091' },
            { id: 21, name: 'Dr Adeola (FMC)', phone: '0806 453 7707' },
            { id: 22, name: 'Dr AHMED Angelic Care', phone: '+234 703 074 6003' },
            { id: 23, name: 'Dr Ainakhu Mdh', phone: '0818 776 8921' },
            { id: 24, name: 'Dr Ainedo', phone: '0809 156 0055' },
            { id: 25, name: 'Dr Aire (La Vida Hospital)', phone: '0805 257 3345' },
            { id: 26, name: 'Dr Aisha ( Custom)', phone: '0808 793 2063' },
            { id: 27, name: 'Dr Aisha Abdulkadir Mdh Sopd', phone: '0708 455 3122' },
            { id: 28, name: 'Dr Aisha Aminu mdh', phone: '0903 580 1170' },
            { id: 29, name: 'Dr Aisha Diwko Internal Medicine FMC', phone: '0803 595 6257' },
            { id: 30, name: 'Dr Aisha FMC', phone: '0803 866 4816' },
            { id: 31, name: 'Dr Aisha Mdh', phone: '0803 466 2980' },
            { id: 32, name: 'Dr Aisha Mu\'azu Fmc', phone: '0806 692 7182' },
            { id: 33, name: 'Dr Aisha Samiwadata', phone: '0808 507 3144' },
            { id: 34, name: 'Dr Aisha Mari (Mdh)', phone: '0816 035 4691' },
            { id: 35, name: 'Dr Aisha. H Mdh', phone: '0806 580 9497' },
            { id: 36, name: 'Dr Ajibola (A&E)', phone: '0803 845 2296' },
            { id: 37, name: 'Dr Ajibola (Mdh)', phone: '0803 845 2296' },
            { id: 38, name: 'Dr Akila Mdh', phone: '0806 200 6013' },
            { id: 39, name: 'Dr Akuma MDH A&E', phone: '+234 811 201 8458' },
            { id: 40, name: 'Dr Aliu', phone: '0803 045 9295' },
            { id: 41, name: 'Dr Aliyu (Mdh)', phone: '0803 821 7000' },
            { id: 42, name: 'Dr Amarachi( Federal Road Safety)', phone: '0803 478 6238' },
            { id: 43, name: 'Dr Amina ( Kano)', phone: '0816 983 0844' },
            { id: 44, name: 'Dr Amina (MDH)', phone: '+234 814 160 6236' },
            { id: 45, name: 'Dr Amina Bello (Mdh)', phone: '0909 817 5000' },
            { id: 46, name: 'Dr Amina Isah Wdh', phone: '0905 664 0075' },
            { id: 47, name: 'Dr Amina Stephen ( Zankli)', phone: '0813 165 2676' },
            { id: 48, name: 'Dr Amina Zankli', phone: '0813 165 2676' },
            { id: 49, name: 'Dr Aminu Mohammed', phone: '0803 649 1499' },
            { id: 50, name: 'Dr Amira Alliance', phone: '0905 446 5967' },
            { id: 51, name: 'Dr Anachebe (Gopd) Fmc', phone: '0803 744 2779' },
            { id: 52, name: 'Dr Anachebe Amara Mdh', phone: '0803 347 1430' },
            { id: 53, name: 'Dr Andrew Mdh', phone: '0813 061 9363' },
            { id: 54, name: 'Dr Andrew Wdh', phone: '0803 831 6688' },
            { id: 55, name: 'Dr Ansa Wdh', phone: '0903 467 4330' },
            { id: 56, name: 'Dr Anyaike Mdh', phone: '0803 346 6806' },
            { id: 57, name: 'Dr Ashe.A Mdh', phone: '0806 003 4307' },
            { id: 58, name: 'Dr Asmau', phone: '0803 050 9700' },
            { id: 59, name: 'Dr Asmau Fmc', phone: '0805 777 4444' },
            { id: 60, name: 'Dr Asmau Sdc', phone: '0806 910 9494' },
            { id: 61, name: 'Dr Asst Manager. Goodness', phone: '0701 565 4444' },
            { id: 62, name: 'Dr Audu', phone: '0806 600 4480' },
            { id: 63, name: 'Dr Ayeni (Ushafa)', phone: '0806 088 8899' },
            { id: 64, name: 'Dr Azeezat Fmc', phone: '0818 013 0081' },
            { id: 65, name: 'Dr B. C Udo (Joyland Med Center)', phone: '0803 623 3929' },
            { id: 66, name: 'Dr Badijo GGH', phone: '0707 284 9596' },
            { id: 67, name: 'Dr Bajowa NH', phone: '0705 118 8389' },
            { id: 68, name: 'Dr Bakari GGH', phone: '0806 352 9563' },
            { id: 69, name: 'Dr Bako Mdh', phone: '0818 830 7314' },
            { id: 70, name: 'Dr Bala FMC', phone: '0803 431 8388' },
            { id: 71, name: 'Dr Bala Laila Adh', phone: '0803 208 2208' },
            { id: 72, name: 'Dr Balogun Wdh', phone: '0809 142 8700' },
            { id: 73, name: 'Dr Barachel FMC', phone: '0816 728 0310' },
            { id: 74, name: 'Dr Barry Fmc Keffi', phone: '0703 114 0682' },
            { id: 75, name: 'Dr Barsisa Police Hospital', phone: '0807 816 9845' },
            { id: 76, name: 'Dr Bashir Wdh', phone: '0803 768 6616' },
            { id: 77, name: 'Dr Basi ( Fmc)', phone: '0703 892 7393' },
            { id: 78, name: 'Dr Bassey NH', phone: '0803 677 7585' },
            { id: 79, name: 'Dr Bello B (Gwarimpa)', phone: '0806 580 5543' },
            { id: 80, name: 'Dr Bello Nisa', phone: '0803 452 7954' },
            { id: 81, name: 'Dr Binta', phone: '0818 200 4872' },
            { id: 82, name: 'Dr Chinedu Mdh', phone: '0814 809 1467' },
            { id: 83, name: 'Dr Chinenye (FMC)', phone: '0901 327 2341' },
            { id: 84, name: 'Dr Chinomso FMC', phone: '0805 508 3305' },
            { id: 85, name: 'Dr Chinwe (NH) ENT, Alliance', phone: '0806 134 0193' },
            { id: 86, name: 'Dr Chinyere Wdh', phone: '0813 775 0464' },
            { id: 87, name: 'Dr Chioma (Mopd) Asokoro', phone: '0818 284 8813' },
            { id: 88, name: 'Dr Chioma amasike FMC', phone: '0803 646 4457' },
            { id: 89, name: 'Dr Chioma Fertil Aid Clinic', phone: '0706 359 0667' },
            { id: 90, name: 'Dr Chisom Wdh', phone: '0901 836 0060' },
            { id: 91, name: 'Dr Chiwa Wdh', phone: '0815 520 6243' },
            { id: 92, name: 'Dr Chomia Egimike Fmc', phone: '0803 604 0554' },
            { id: 93, name: 'Dr Chris Ibe FMC', phone: '0907 145 9839' },
            { id: 94, name: 'Dr Christabel Adh', phone: '0904 733 9060' },
            { id: 95, name: 'Dr Clement', phone: '0703 400 3719' },
            { id: 96, name: 'Dr David', phone: '0803 615 6060' },
            { id: 97, name: 'Dr David (MDH)', phone: '0803 615 6060' },
            { id: 98, name: 'Dr Dolapo (A&E) Mdh', phone: '0812 434 4235' },
            { id: 99, name: 'Dr Donald', phone: '0809 546 5111' },
            { id: 100, name: 'Dr Douglas ( Sopd) FMC', phone: '0812 461 1270' },
            { id: 101, name: 'Dr Ebi', phone: '0703 880 2688' },
            { id: 102, name: 'Dr Ebi 2', phone: '+252 61 0702357' },
            { id: 103, name: 'Dr Eboigbe MDH', phone: '0814 573 2609' },
            { id: 104, name: 'Dr Ebruke Fmc', phone: '0906 358 8892' },
            { id: 105, name: 'Dr Ebube (WDH)', phone: '0803 780 2004' },
            { id: 106, name: 'Dr Ebuka FMC', phone: '0805 801 0352' },
            { id: 107, name: 'Dr Earnest Ekekweme Uath', phone: '0803 855 0077' },
            { id: 108, name: 'Dr Ebenezer FMC', phone: '0803 593 2635' },
            { id: 109, name: 'Dr Ebeniza', phone: '0703 929 7657' },
            { id: 110, name: 'Dr Ebis Sister', phone: '0812 202 3987' },
            { id: 111, name: 'Dr Egbe Wdh', phone: '0806 728 5062' },
            { id: 112, name: 'Dr Enejo (FMC)', phone: '0803 490 2920' },
            { id: 113, name: 'Dr Essan Wdh', phone: '0803 357 7479' },
            { id: 114, name: 'Dr Essien U. (NH)', phone: '0806 785 4639' },
            { id: 115, name: 'Dr Esther', phone: '0902 591 1424' },
            { id: 116, name: 'Dr Esther ( St Mary\'s)', phone: '0814 127 2514' },
            { id: 117, name: 'Dr Esther Mdh', phone: '0803 738 3199' },
            { id: 118, name: 'Dr Evie Fmc', phone: '0803 065 6599' },
            { id: 119, name: 'Dr Eze Mdh', phone: '0803 803 5133' },
            { id: 120, name: 'Dr F.N Zankli', phone: '0803 707 9898' },
            { id: 121, name: 'Dr Faith', phone: '0803 400 1373' },
            { id: 122, name: 'Dr Faruk Mdh', phone: '0803 301 7064' },
            { id: 123, name: 'Dr Fatima (Mdh)', phone: '0813 183 9109' },
            { id: 124, name: 'Dr Fatima Mohammed', phone: '0810 551 2927' },
            { id: 125, name: 'Dr Fatima Wdh', phone: '0803 617 8000' },
            { id: 126, name: 'Dr Funmi (Fmc)', phone: '0803 400 0081' },
            { id: 127, name: 'Dr Funmi Mdh', phone: '0803 325 5650' },
            { id: 128, name: 'Dr Gabriel (Mdh)', phone: '0803 394 6500' },
            { id: 129, name: 'Dr Gaya Sdc', phone: '0803 707 4307' },
            { id: 130, name: 'Dr Gimba (Fmc)', phone: '0803 607 7077' },
            { id: 131, name: 'Dr Godiya', phone: '0803 531 3330' },
            { id: 132, name: 'Dr Goodness', phone: '0701 565 4444' },
            { id: 133, name: 'Dr Hassan GGH', phone: '0803 073 6867' },
            { id: 134, name: 'Dr Hauwa (Nh)', phone: '0803 306 9621' },
            { id: 135, name: 'Dr Hauwa Wdh', phone: '0803 503 6296' },
            { id: 136, name: 'Dr Henry Peter(Multi Ray)', phone: '0803 284 1483' },
            { id: 137, name: 'Dr Henry Wdh', phone: '0803 322 2946' },
            { id: 138, name: 'Dr Homa GGH', phone: '0903 248 9877' },
            { id: 139, name: 'Dr Hussaina. M.kufuti', phone: '0906 143 6130' },
            { id: 140, name: 'Dr Hyginus', phone: '0805 274 5328' },
            { id: 141, name: 'Dr Ibe 2', phone: '0808 840 4286' },
            { id: 142, name: 'Dr Ibiteye', phone: '0802 774 8642' },
            { id: 143, name: 'Dr Ibraheem Mdh', phone: '0810 462 8580' },
            { id: 144, name: 'Dr Ibrahim ( Police Hospital)', phone: '0810 564 2276' },
            { id: 145, name: 'Dr Ibrahim Aisha Mdh', phone: '0803 529 9408' },
            { id: 146, name: 'Dr Ibrahim Aramide Mdh', phone: '0803 437 5748' },
            { id: 147, name: 'Dr Ibrahim B.A Wdh', phone: '0803 624 3804' },
            { id: 148, name: 'Dr Ibrahim Fmc', phone: '0803 454 4496' },
            { id: 149, name: 'Dr Ibrahim I. K. Mdh', phone: '0803 624 3804' },
            { id: 150, name: 'Dr Idika. K. Mdh', phone: '0803 451 9897' },
            { id: 151, name: 'Dr Idowu (Mdh)', phone: '0803 700 8782' },
            { id: 152, name: 'Dr Idrisa Mdh', phone: '0803 668 5225' },
            { id: 153, name: 'Dr Ifeanyi (Hoc)', phone: '0803 703 6176' },
            { id: 154, name: 'Dr Ifeanyi Mdh', phone: '0813 103 0783' },
            { id: 155, name: 'Dr Ifeanyi Onuoha Mdh', phone: '0803 474 8153' },
            { id: 156, name: 'Dr Ifeanyi Wdh', phone: '0803 474 8153' },
            { id: 157, name: 'Dr Ijeoma (Mdh)', phone: '0703 677 7566' },
            { id: 158, name: 'Dr Ijere (Uath)', phone: '0803 701 9831' },
            { id: 159, name: 'Dr Ijezie NH', phone: '0803 775 8899' },
            { id: 160, name: 'Dr Ikwesi', phone: '0803 455 1297' },
            { id: 161, name: 'Dr Imana Mdh', phone: '0803 540 8596' },
            { id: 162, name: 'Dr Innocent (A&E) Mdh', phone: '0803 361 0262' },
            { id: 163, name: 'Dr Innocent (Wdh)', phone: '0803 502 0270' },
            { id: 164, name: 'Dr Israel (Faith Mediolex)', phone: '0915 736 7399' },
            { id: 165, name: 'Dr Israel GGH', phone: '0806 003 0939' },
            { id: 166, name: 'Dr Israel Mdh', phone: '0903 459 1260' },
            { id: 167, name: 'Dr Istifanus Defense', phone: '0703 639 0017' },
            { id: 168, name: 'Dr Isu-igwu Mdh', phone: '2348030613057' },
            { id: 169, name: 'Dr Isyaka Ibrahim (Wdh)', phone: '0911 427 9611' },
            { id: 170, name: 'Dr Isyaka Wdh', phone: '0707 096 8098' },
            { id: 171, name: 'Dr Itepu (Faith Mediplex)', phone: '0813 121 4949' },
            { id: 172, name: 'Dr Itoandon Fmc', phone: '0805 929 4481' },
            { id: 173, name: 'Dr Itua Mdh', phone: '0810 466 8593' },
            { id: 174, name: 'Dr IVie WDh', phone: '0814 808 1848' },
            { id: 175, name: 'Dr Ivy Omaagabe (Adh)', phone: '0706 896 9318' },
            { id: 176, name: 'Dr Jato Fmc', phone: '0813 284 3239' },
            { id: 177, name: 'Dr Jeff Mdh', phone: '0803 923 6537' },
            { id: 178, name: 'Dr Kachi( FMC)', phone: '0811 734 4287' },
            { id: 179, name: 'Dr Kadija FMC ( Orthopedic', phone: '0808 313 3682' },
            { id: 180, name: 'Dr Kadija Fmc Sopd', phone: '0706 997 4897' },
            { id: 181, name: 'Dr Kadijah. S FMC', phone: '0806 758 9999' },
            { id: 182, name: 'Dr Kadiya GGH', phone: '0805 450 7715' },
            { id: 183, name: 'Dr Laja Mdh', phone: '0805 413 5440' },
            { id: 184, name: 'Dr Lucky Edego Mdh', phone: '0803 331 4627' },
            { id: 185, name: 'Dr Martha Mdh', phone: '0803 405 8431' },
            { id: 186, name: 'Dr Mathew (Uath)', phone: '0803 928 2062' },
            { id: 187, name: 'Dr Max Wdh', phone: '0803 460 3381' },
            { id: 188, name: 'Dr Mike (Gwarimpa Hosp)', phone: '0806 000 7064' },
            { id: 189, name: 'Dr Minji (General Hosp Gwarimpa)', phone: '0803 705 4811' },
            { id: 190, name: 'Dr Momoh Razak. FMC', phone: '0703 465 6166' },
            { id: 191, name: 'Dr Momoh Wdh Mdh', phone: '0916 405 5914' },
            { id: 192, name: 'Dr Momudu', phone: '0807 106 5001' },
            { id: 193, name: 'Dr Monica Alitor', phone: '0802 329 4984' },
            { id: 194, name: 'Dr Morah Wdh', phone: '0803 068 6102' },
            { id: 195, name: 'Dr Moses (Sure Link)', phone: '0703 429 8094' },
            { id: 196, name: 'Dr Obinna Wdh', phone: '0803 193 8280' },
            { id: 197, name: 'Dr Ojah ( Rapha Con)', phone: '0806 024 8584' },
            { id: 198, name: 'Dr Ojah Regina', phone: '0802 080 6700' },
            { id: 199, name: 'Dr Oje Adh', phone: '0705 418 5651' },
            { id: 200, name: 'Dr Oje Cynthia MDH', phone: '0816 186 1151' },
            { id: 201, name: 'Dr Ojo(Min Of Works)', phone: '0802 308 2873' },
            { id: 202, name: 'Dr Okafor NH', phone: '0806 672 8042' },
            { id: 203, name: 'Dr Okafor Spring Bloom', phone: '0803 450 0221' },
            { id: 204, name: 'Dr Okang ( Zankli)', phone: '0806 435 5768' },
            { id: 205, name: 'Dr Okeke (Nscdc)', phone: '0803 824 6644' },
            { id: 206, name: 'Dr Okeme Emmanuel Lafia', phone: '0813 627 7345' },
            { id: 207, name: 'Dr Okereke Mdh', phone: '0703 555 0241' },
            { id: 208, name: 'Dr Okewu Cecilia Adh', phone: '0803 646 8613' },
            { id: 209, name: 'Dr Okoro', phone: '0803 888 7709' },
            { id: 210, name: 'Dr Okoro (NH)', phone: '0803 888 7709' },
            { id: 211, name: 'Dr Olakunle (MDH)', phone: '0803 717 6400' },
            { id: 212, name: 'Dr Oladipo (Mdh)', phone: '0803 586 1989' },
            { id: 213, name: 'Dr Olaniyan (NH)', phone: '0703 056 9414' },
            { id: 214, name: 'Dr Olufemi (Mdh)', phone: '0803 331 6356' },
            { id: 215, name: 'Dr Oluromade( Asokoro)', phone: '0704 302 2669' },
            { id: 216, name: 'Dr Olusegun Adeyemi Nisa', phone: '0706 545 1261' },
            { id: 217, name: 'Dr Olusegun Stella MDH', phone: '0703 253 2877' },
            { id: 218, name: 'Dr Olusegun Zankli CMD', phone: '0803 566 8422' },
            { id: 219, name: 'Dr Omachi FMC', phone: '0903 693 5692' },
            { id: 220, name: 'Dr Omego (ANC) Fmc', phone: '0812 923 7987' },
            { id: 221, name: 'Dr Omotunde', phone: '0803 591 5862' },
            { id: 222, name: 'Dr Omotunde Wdh', phone: '0803 591 5862' },
            { id: 223, name: 'Dr Onuoha Mdh', phone: '0803 379 2378' },
            { id: 224, name: 'Dr Oseni Mdh', phone: '0803 358 1282' },
            { id: 225, name: 'Dr Osita Mdh', phone: '0803 746 4482' },
            { id: 226, name: 'Dr Owolabi (NH)', phone: '0806 828 0080' },
            { id: 227, name: 'Dr Paul (MDH)', phone: '0803 700 8448' },
            { id: 228, name: 'Dr Paul (NH)', phone: '0703 514 8352' },
            { id: 229, name: 'Dr Paulina (FMC)', phone: '0803 574 7793' },
            { id: 230, name: 'Dr Pete (Mdh)', phone: '0803 355 2426' },
            { id: 231, name: 'Dr Pete Keffi', phone: '0803 355 2426' },
            { id: 232, name: 'Dr Peter', phone: '0803 400 1373' },
            { id: 233, name: 'Dr Peter (Nisa)', phone: '0803 599 0760' },
            { id: 234, name: 'Dr Peter GGH', phone: '0803 777 5013' },
            { id: 235, name: 'Dr Peter NH', phone: '0803 400 1373' },
            { id: 236, name: 'Dr Peter Uath', phone: '0803 903 5988' },
            { id: 237, name: 'Dr Philemon Mdh', phone: '0803 704 6013' },
            { id: 238, name: 'Dr Phillip (Mdh)', phone: '0803 787 5683' },
            { id: 239, name: 'Dr Philip NH', phone: '0803 787 5683' },
            { id: 240, name: 'Dr Pitan (Mdh)', phone: '0803 392 6404' },
            { id: 241, name: 'Dr Polycarp (UATH)', phone: '0806 597 0212' },
            { id: 242, name: 'Dr Prisca (MDH)', phone: '0803 703 9132' },
            { id: 243, name: 'Dr Prisca Mdh', phone: '0803 703 9132' },
            { id: 244, name: 'Dr Princess Mdh', phone: '0803 356 0004' },
            { id: 245, name: 'Dr Queen', phone: '0803 400 1373' },
            { id: 246, name: 'Dr R.M Jato', phone: '0803 646 0451' },
            { id: 247, name: 'Dr R.M Jato Fmc', phone: '0803 646 0451' },
            { id: 248, name: 'Dr Rabiu (Asokoro)', phone: '0703 040 1085' },
            { id: 249, name: 'Dr Rakiya (FMC)', phone: '0803 599 3757' },
            { id: 250, name: 'Dr Raliat', phone: '0803 351 0500' },
            { id: 251, name: 'Dr Ransome Wdh', phone: '0803 381 0544' },
            { id: 252, name: 'Dr Raph (Wdh)', phone: '0803 605 9180' },
            { id: 253, name: 'Dr Raph Uath', phone: '0803 605 9180' },
            { id: 254, name: 'Dr Rebecca (Mdh)', phone: '0803 590 4403' },
            { id: 255, name: 'Dr Reuben Uath', phone: '0803 585 0008' },
            { id: 256, name: 'Dr Richard (Mdh)', phone: '0803 349 2244' },
            { id: 257, name: 'Dr Risikat', phone: '0806 828 0080' },
            { id: 258, name: 'Dr Risikat (Wdh)', phone: '0806 828 0080' },
            { id: 259, name: 'Dr Rotimi (Nisa)', phone: '0803 353 3835' },
            { id: 260, name: 'Dr Rufai FMC ( Paed)', phone: '0806 099 2174' },
            { id: 261, name: 'Dr Ruth', phone: '0803 400 1373' },
            { id: 262, name: 'Dr Salako', phone: '0803 593 6445' },
            { id: 263, name: 'Dr Samson O (A&E) Mdh', phone: '0803 474 4452' },
            { id: 264, name: 'Dr Sarah (Wdh)', phone: '0803 718 1111' },
            { id: 265, name: 'Dr Sarah Mdh', phone: '0703 055 2164' },
            { id: 266, name: 'Dr Sekular FMC', phone: '0806 565 0777' },
            { id: 267, name: 'Dr Senusi (Asokoro) A& E', phone: '0703 799 3264' },
            { id: 268, name: 'Dr Seun Medimike', phone: '0802 907 1507' },
            { id: 269, name: 'Dr Shagaya (NH)', phone: '0818 427 6466' },
            { id: 270, name: 'Dr Shaibu (sugery) FMC', phone: '0805 544 4122' },
            { id: 271, name: 'Dr Shaibu T. (Mdh)', phone: '0803 821 7899' },
            { id: 272, name: 'Dr Simon Mdh', phone: '0813 930 7919' },
            { id: 273, name: 'Dr Sophia Mdh', phone: '0803 429 2707' },
            { id: 274, name: 'Dr Stephen (Keffi)', phone: '0803 594 7799' },
            { id: 275, name: 'Dr Stephen Mdh', phone: '0803 400 1373' },
            { id: 276, name: 'Dr T.H Adamu Fmc', phone: '0803 596 6656' },
            { id: 277, name: 'Dr T.H Adamu Fmc 2', phone: '0803 596 6656' },
            { id: 278, name: 'Dr Temi Wdh', phone: '0806 205 3816' },
            { id: 279, name: 'Dr Thelma (Mdh)', phone: '0803 589 8089' },
            { id: 280, name: 'Dr Tola (Mdh)', phone: '0803 451 4473' },
            { id: 281, name: 'Dr Tolani', phone: '0803 613 0667' },
            { id: 282, name: 'Dr Tony (Mdh)', phone: '0803 666 4381' },
            { id: 283, name: 'Dr Tony (Uath)', phone: '0803 666 4381' },
            { id: 284, name: 'Dr Tony FMC', phone: '0803 888 7709' },
            { id: 285, name: 'Dr Tunde Wdh', phone: '0803 506 6378' },
            { id: 286, name: 'Dr Uche Mdh', phone: '0803 746 4482' },
            { id: 287, name: 'Dr Uche (Wdh)', phone: '0803 703 6176' },
            { id: 288, name: 'Dr Uchenna FMC', phone: '0803 361 0262' },
            { id: 289, name: 'Dr Uchenna Mdh', phone: '0803 746 4482' },
            { id: 290, name: 'Dr Ugo (NH)', phone: '0803 300 1198' },
            { id: 291, name: 'Dr Umma GGH', phone: '0803 969 9999' },
            { id: 292, name: 'Dr Umar Mdh', phone: '0803 867 0747' },
            { id: 293, name: 'Dr Usen (Mdh)', phone: '0803 421 8234' },
            { id: 294, name: 'Dr Usen (Wdh)', phone: '0803 421 8234' },
            { id: 295, name: 'Dr V. O Wdh', phone: '0703 919 0649' },
            { id: 296, name: 'Dr Victor Mdh', phone: '0915 892 4548' },
            { id: 297, name: 'Dr Victor Ovouh', phone: '0818 592 6507' },
            { id: 298, name: 'Dr Victor Pediatric (FMC)', phone: '0810 576 2982' },
            { id: 299, name: 'Dr Victor Tabansi Ggh', phone: '2347063350651' },
            { id: 300, name: 'Dr Victoria O Adh', phone: '0802 841 2330' },
            { id: 301, name: 'Dr Victoria Primuse Specialist', phone: '+234 813 553 7780' },
            { id: 302, name: 'Dr Vivian Lagos', phone: '0703 147 8887' },
            { id: 303, name: 'Dr Wusa Sdc', phone: '0803 686 9051' },
            { id: 304, name: 'Dr Yusuf Mdh', phone: '0803 702 4323' },
            { id: 305, name: 'Dr Yusuff (A&E) Fmc', phone: '0806 597 2200' },
            { id: 306, name: 'Dr Yusuff Mdh', phone: '0803 325 5650' },
            { id: 307, name: 'Dr Zeenat', phone: '0803 958 0707' },
            { id: 308, name: 'Dr Zira (Mdh)', phone: '0803 596 6656' },
            { id: 309, name: 'Dr Zira Mdh', phone: '0803 596 6656' },
            { id: 310, name: 'Mdh Pediatrics Dr', phone: '0812 923 3698' },
            { id: 311, name: 'Dr Orisah Goodness', phone: '+375 25 758-77-41' },
            { id: 312, name: '2nd Dr Hamza Wdh', phone: '0802 691 6636' },
            { id: 313, name: 'Barrister Dr Chioma Abuja', phone: '0703 838 9624' }
        ];

        // Inventory populated from provided master list (grouped by category)
        let inventory = [
            { id: 1, name: 'FULL BLOOD COUNT', category: 'LAB', price: 10000 },
            { id: 2, name: 'ERYTHROCYTE SEDIMENTATION RATE (ESR)', category: 'LAB', price: 7000 },
            { id: 3, name: 'HB GENOTYPE', category: 'LAB', price: 10000 },
            { id: 4, name: 'BLOOD GROUPING (ABO)', category: 'LAB', price: 10000 },
            { id: 5, name: 'RETICULOCYTE COUNT', category: 'LAB', price: 8000 },
            { id: 6, name: 'CLOTTING PROFILE', category: 'LAB', price: 30000 },
            { id: 7, name: 'CLOTTING TIME', category: 'LAB', price: 10000 },
            { id: 8, name: 'BLEEDING TIME', category: 'LAB', price: 10000 },
            { id: 9, name: 'PROTHROMBIN TIME', category: 'LAB', price: 10000 },
            { id: 10, name: 'PTTK', category: 'LAB', price: 10000 },
            { id: 11, name: 'INR (INTERNATIONAL NORMALIZED RATIO)', category: 'LAB', price: 10000 },
            { id: 12, name: 'HB GENOTYPING', category: 'LAB', price: 80000 },
            { id: 13, name: 'BLOOD FILM', category: 'LAB', price: 5000 },
            { id: 14, name: 'PCV', category: 'LAB', price: 5000 },
            { id: 15, name: 'PLATELET COUNT', category: 'LAB', price: 8000 },
            { id: 16, name: 'VON WILLEBRAND ANTIGEN', category: 'LAB', price: null },
            { id: 17, name: 'COMB TEST (ICT, DCT)', category: 'LAB', price: null },
            { id: 18, name: 'G6PD', category: 'LAB', price: 45000 },
            { id: 19, name: 'FIBRINOGEN', category: 'LAB', price: 70000 },
            { id: 20, name: 'C-PEPTIDE', category: 'LAB', price: 40000 },
            { id: 21, name: 'AUTOIMMUNE TEST', category: 'LAB', price: 150000 },
            { id: 22, name: 'FBS', category: 'LAB', price: 5000 },
            { id: 23, name: 'RBS', category: 'LAB', price: 5000 },
            { id: 24, name: 'OGTT', category: 'LAB', price: 35000 },
            { id: 25, name: '2HPP', category: 'LAB', price: 12000 },
            { id: 26, name: 'E/U/C', category: 'LAB', price: 20000 },
            { id: 27, name: 'SODIUM', category: 'LAB', price: 10000 },
            { id: 28, name: 'POTASSIUM', category: 'LAB', price: 8000 },
            { id: 29, name: 'CHLORIDE', category: 'LAB', price: 8000 },
            { id: 30, name: 'BICARBONATE', category: 'LAB', price: 8000 },
            { id: 31, name: 'UREA', category: 'LAB', price: 8000 },
            { id: 32, name: 'CREATININE', category: 'LAB', price: 8000 },
            { id: 33, name: 'LIVER FUNCTION TEST (LFT)', category: 'LAB', price: 20000 },
            { id: 34, name: 'TOTAL BILIRUBIN', category: 'LAB', price: 7000 },
            { id: 35, name: 'DIRECT BILIRUBIN', category: 'LAB', price: 7000 },
            { id: 36, name: 'ALKALINE PHOSPHATASE', category: 'LAB', price: 6500 },
            { id: 37, name: 'ASAT', category: 'LAB', price: 6000 },
            { id: 38, name: 'ALAT', category: 'LAB', price: 6000 },
            { id: 39, name: 'GGT', category: 'LAB', price: 6000 },
            { id: 40, name: 'TOTAL PROTEIN', category: 'LAB', price: 6000 },
            { id: 41, name: 'CALCIUM', category: 'LAB', price: 8500 },
            { id: 42, name: 'ALBUMIN', category: 'LAB', price: 8000 },
            { id: 43, name: 'URIC ACID', category: 'LAB', price: 10000 },
            { id: 44, name: 'BLOOD UREA NITROGEN', category: 'LAB', price: 25000 },
            { id: 45, name: 'FASTING LIPID PROFILE', category: 'LAB', price: 20000 },
            { id: 46, name: 'TOTAL CHOLESTEROL', category: 'LAB', price: 20000 },
            { id: 47, name: 'TRIGLYCERIDES', category: 'LAB', price: 8000 },
            { id: 48, name: 'HDL', category: 'LAB', price: 8000 },
            { id: 49, name: 'LDH', category: 'LAB', price: 8000 },
            { id: 50, name: 'URINALYSIS', category: 'LAB', price: 5000 },
            { id: 51, name: 'GLYCATED HAEMOGLOBIN (HBA1C)', category: 'LAB', price: 30000 },
            { id: 52, name: 'UREA BREATH TEST', category: 'LAB', price: 50000 },
            { id: 53, name: 'RHEUMATOID FACTOR', category: 'LAB', price: 30000 },
            { id: 54, name: 'C-REACTIVE PROTEIN', category: 'LAB', price: 30000 },
            { id: 55, name: 'PREGNANCY TEST', category: 'LAB', price: 3500 },
            { id: 56, name: 'HORMONAL PROFILE', category: 'LAB', price: 65000 },
            { id: 57, name: 'PROGESTERONE', category: 'LAB', price: 20000 },
            { id: 58, name: 'LUITINIZING HORMONE', category: 'LAB', price: 20000 },
            { id: 59, name: 'FOLLICLE STIMULATING HORMONE', category: 'LAB', price: 20000 },
            { id: 60, name: 'PROLACTIN', category: 'LAB', price: 20000 },
            { id: 61, name: 'ESTRADIOL', category: 'LAB', price: 20000 },
            { id: 62, name: 'TESTOSTERONE', category: 'LAB', price: 20000 },
            { id: 63, name: 'PSA', category: 'LAB', price: 20000 },
            { id: 64, name: 'THYROID MARKERS (T3,T4,TSH)', category: 'LAB', price: 60000 },
            { id: 65, name: 'CA-125', category: 'LAB', price: 30000 },
            { id: 66, name: 'CA 15-3', category: 'LAB', price: 30000 },
            { id: 67, name: 'CA 19-9', category: 'LAB', price: 30000 },
            { id: 68, name: 'CALPROTECTIN', category: 'LAB', price: 40000 },
            { id: 69, name: 'CEA', category: 'LAB', price: 25000 },
            { id: 70, name: 'CK-MB', category: 'LAB', price: 30000 },
            { id: 71, name: 'CORTISOL', category: 'LAB', price: 30000 },
            { id: 72, name: 'CRP', category: 'LAB', price: 35000 },
            { id: 73, name: 'HS-CRP', category: 'LAB', price: 40000 },
            { id: 74, name: 'CYSTATIN-C', category: 'LAB', price: 40000 },
            { id: 75, name: 'D-DIMER', category: 'LAB', price: 30000 },
            { id: 76, name: 'ALPHA-FETO PROTEIN', category: 'LAB', price: 25000 },
            { id: 77, name: 'FERRATIN', category: 'LAB', price: 30000 },
            { id: 78, name: 'FOB (QUALITATIVE)', category: 'LAB', price: 15000 },
            { id: 79, name: 'BETA-HCG', category: 'LAB', price: 20000 },
            { id: 80, name: 'INSULIN', category: 'LAB', price: 40000 },
            { id: 81, name: 'IGE', category: 'LAB', price: 20000 },
            { id: 82, name: 'MICROALBUMIN', category: 'LAB', price: 50000 },
            { id: 83, name: 'MYOGLOBULIN', category: 'LAB', price: 40000 },
            { id: 84, name: 'PROCALCITONIN', category: 'LAB', price: 50000 },
            { id: 85, name: 'TROPONIN-1', category: 'LAB', price: 30000 },
            { id: 86, name: 'TROPONIN-T', category: 'LAB', price: 35000 },
            { id: 87, name: 'STOOL M/C/S', category: 'LAB', price: 10000 },
                        { id: 88, name: 'BLOOD CULTURE', category: 'LAB', price: 50000 },
                        { id: 89, name: 'URINE M/C/S', category: 'LAB', price: 10000 },
                        { id: 90, name: 'SWAB', category: 'LAB', price: 10000 },
                        { id: 91, name: 'SPUTUM M/C/S', category: 'LAB', price: 10000 },
                        { id: 92, name: 'AFB MICROSCOPY 3', category: 'LAB', price: 45000 },
                        { id: 93, name: 'MP', category: 'LAB', price: 5000 },
                        { id: 94, name: 'WIDAL', category: 'LAB', price: 10000 },
                        { id: 95, name: 'PAP SMEAR', category: 'LAB', price: 40000 },
                        { id: 96, name: 'HIV I&II', category: 'LAB', price: 10000 },
                        { id: 97, name: 'HEPATITIS A', category: 'LAB', price: 10000 },
                        { id: 98, name: 'HBSAG', category: 'LAB', price: 10000 },
                        { id: 99, name: 'HCV', category: 'LAB', price: 10000 },
                        { id: 100, name: 'VDRL', category: 'LAB', price: 10000 },
                        { id: 101, name: 'HEPATITIS B PROFILE', category: 'LAB', price: 20000 },
                        { id: 102, name: 'CSF ANALYSIS', category: 'LAB', price: 15000 },
                        { id: 103, name: 'H. PYLORI', category: 'LAB', price: 6000 },
                        { id: 104, name: 'OCCULT BLOOD', category: 'LAB', price: 20000 },
                        { id: 105, name: 'URINE MICROSCOPY', category: 'LAB', price: 10000 },
                        { id: 106, name: 'STOOL MICROSCOPY', category: 'LAB', price: 10000 },
                        { id: 107, name: 'HELICOBACTER PYLORI IGM/IGA/IGG', category: 'LAB', price: 60000 },
                        { id: 108, name: 'RHEUMATOID FACTOR', category: 'LAB', price: 25000 },
                        { id: 109, name: 'GRAM STAIN', category: 'LAB', price: 2000 },
                        { id: 110, name: 'ASO', category: 'LAB', price: 30000 },
                        { id: 111, name: 'CHLAMYDIA IGM/IGG', category: 'LAB', price: 80000 },
                        { id: 112, name: 'MICROFILARIA', category: 'LAB', price: 15000 },
                        { id: 113, name: 'HEPATITIS B VIRUS PROFILE', category: 'LAB', price: 15000 },
                        { id: 114, name: 'TORCH PANEL', category: 'LAB', price: 200000 },
                        { id: 115, name: 'RUBELLA IGM/IGG', category: 'LAB', price: 90000 },
                        { id: 116, name: 'TOXOPLASMA IGG/IGM', category: 'LAB', price: 90000 },
                        { id: 117, name: 'HSV IGM/IGG', category: 'LAB', price: 90000 },
                        { id: 118, name: 'SEMEN ANALYSIS & M/C/S', category: 'LAB', price: 30000 },
                        { id: 119, name: 'SEMEN ANALYSIS', category: 'LAB', price: 15000 },
                        { id: 120, name: 'HIV VIRAL LOAD & DRUG RESISTANCE', category: 'LAB', price: 187000 },
                        { id: 121, name: 'HEPATITIS B VIRAL LOAD', category: 'LAB', price: 50000 },
                        { id: 122, name: 'HCV GENOTYPE', category: 'LAB', price: 120000 },
                        { id: 123, name: 'ANA SCREENING', category: 'LAB', price: 40000 },
                        { id: 124, name: 'ANCA', category: 'LAB', price: 40000 },


            { id: 125, name: 'PELVIC ULTRASOUND', category: 'SCAN', price: 12000 },
            { id: 126, name: 'ABDOMINOPELVIC SCAN', category: 'SCAN', price: 15000 },
            { id: 127, name: 'OBSTETRICS SCAN', category: 'SCAN', price: 10000 },
            { id: 128, name: 'THYROID SCAN', category: 'SCAN', price: 18000 },
            { id: 129, name: 'BREAST SCAN', category: 'SCAN', price: 18000 },
            { id: 130, name: 'TESTICULAR/SCROTAL/PROSTATE', category: 'SCAN', price: 18000 },
            { id: 131, name: 'DOPPLER SCAN (DOUBLE LIMB)', category: 'SCAN', price: 100000 },
            { id: 132, name: 'TRANSCRANIAL DOPPLER', category: 'SCAN', price: 50000 },
            { id: 133, name: 'TESTICULAR SCAN', category: 'SCAN', price: 15000 },
            { id: 134, name: 'RENAL SCAN', category: 'SCAN', price: 15000 },
            { id: 135, name: 'ANOMALY SCAN', category: 'SCAN', price: 25000 },
            { id: 136, name: 'TROSS (TRANSRECTAL ULTRASOUND)', category: 'SCAN', price: 20000 },
            { id: 137, name: 'SONOURETHROGRAM (RCUG)', category: 'SCAN', price: 80000 },
            { id: 138, name: 'ANTERIOR FONTANELLE', category: 'SCAN', price: 20000 },
            { id: 139, name: 'FOLLICULAR TRACKING (3 VISIT)', category: 'SCAN', price: 60000 },
            { id: 140, name: 'TRANSVAGINAL SCAN', category: 'SCAN', price: 18000 },
            { id: 141, name: 'NECK ULTRASOUND', category: 'SCAN', price: 18000 },
            { id: 142, name: 'SOFT TISSUE ULTRASOUND', category: 'SCAN', price: 15000 },
            { id: 143, name: 'SMALL PARTS ULTRASOUND', category: 'SCAN', price: 15000 },
            { id: 144, name: 'PENILE DOPPLER', category: 'SCAN', price: 250000 },
            { id: 144, name: 'PENILE DOPPLER', category: 'SCAN', price: 250000 },

                        { id: 145, name: 'HAND X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 146, name: 'WRIST X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 147, name: 'FOREARM X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 148, name: 'HUMERUS X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 149, name: 'SHOULDER X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 150, name: 'SCAPULAR X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 151, name: 'FOOT X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 152, name: 'TIBIA/FIBULA X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 153, name: 'FEMUR (AP/LAT)', category: 'X-RAY', price: 15000 },
                        { id: 154, name: 'PELVIC (AP/LAT)', category: 'X-RAY', price: 15000 },
                        { id: 155, name: 'BOTH HIP JOINTS (AP/LAT)', category: 'X-RAY', price: 30000 },
                        { id: 156, name: 'CHEST (AP)', category: 'X-RAY', price: 15000 },
                        { id: 157, name: 'CHEST (AP/LAT)', category: 'X-RAY', price: 15000 },
                        { id: 158, name: 'SKULL X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 159, name: 'PARANASAL SINUSES', category: 'X-RAY', price: 15000 },
                        { id: 160, name: 'MANDIBLE (JAW)', category: 'X-RAY', price: 15000 },
                        { id: 161, name: 'MAMMOGRAM', category: 'X-RAY', price: 55000 },
                        { id: 162, name: 'NASOPHARYNX', category: 'X-RAY', price: 15000 },
                        { id: 163, name: 'THORACIC SPINE (AP/LAT)', category: 'X-RAY', price: 15000 },
                        { id: 164, name: 'LUMBAR SACRAL (AP/LAT)', category: 'X-RAY', price: 15000 },
                        { id: 165, name: 'KNEE X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 166, name: 'CERVICAL X-RAY', category: 'X-RAY', price: 15000 },
                        { id: 167, name: 'THORACIC INLET', category: 'X-RAY', price: 15000 },
                        { id: 168, name: 'LOPOGRAM', category: 'X-RAY', price: 85000 },
                        { id: 169, name: 'POST NASAL SPACE', category: 'X-RAY', price: 15000 },
                        { id: 170, name: 'ABDOMINAL X-RAY', category: 'X-RAY', price: 18000 },
                        { id: 171, name: 'SKELETAL SURVEY', category: 'X-RAY', price: 60000 },
                        { id: 172, name: 'PITUITARY FOSSA', category: 'X-RAY', price: 15000 },
                        { id: 173, name: 'MASTOIDS', category: 'X-RAY', price: 20000 },
                        { id: 174, name: 'BARIUM SWALLOW', category: 'X-RAY', price: 80000 },
                        { id: 175, name: 'BARIUM FOLLOW THROUGH', category: 'X-RAY', price: 80000 },
                        { id: 176, name: 'BARIUM MEAL', category: 'X-RAY', price: 80000 },
                        { id: 177, name: 'BARIUM ENEMA', category: 'X-RAY', price: 80000 },
                        { id: 178, name: 'HSG', category: 'X-RAY', price: 65000 },
                        { id: 179, name: 'RCUG', category: 'X-RAY', price: 80000 },
                        { id: 180, name: 'MCUG', category: 'X-RAY', price: 80000 },
                        { id: 181, name: 'FISTULOGRAM', category: 'X-RAY', price: 80000 },
            
            { id: 182, name: 'EEG', category: 'EEG', price: 70000 },

            { id: 183, name: 'ECHOCARDIOGRAPHY (CHILDREN)', category: 'ECHO', price: 70000 },
            { id: 184, name: 'ECHOCARDIOGRAPHY (ADULT)', category: 'ECHO', price: 50000 },

            { id: 185, name: 'ECG', category: 'ECG', price: 10000 },

            { id: 186, name: '24 HOURS HOLTER ECG', category: '24 HOURS HOLTER ECG', price: 100000 },

            { id: 187, name: 'COLONOSCOPY', category: 'COLONOSCOPY', price: 205000 },

            { id: 188, name: 'GASTROSCOPY', category: 'GASTROSCOPY', price: 195000 },

            { id: 189, name: 'PHARYNGOSCOPY', category: 'PHARYNGOSCOPY', price: 185000 },

            { id: 190, name: 'ESOPHAGOSCOPY', category: 'ESOPHAGOSCOPY', price: 185000 },

            { id: 191, name: 'MEDICAL EXAMINATION', category: 'MEDICAL EXAMINATION', price: 50000 },

            { id: 192, name: 'CT BRAIN/HEAD', category: 'CT SCAN', price: 80000 },
            { id: 193, name: 'CT BRAIN + CERVICAL SPINE', category: 'CT SCAN', price: 160000 },
            { id: 194, name: 'CT ABDOMEN WITH CONTRAST', category: 'CT SCAN', price: 95000 },
            { id: 195, name: 'CT ABDOMEN/PELVIS WITH CONTRAST', category: 'CT SCAN', price: 100000 },
            { id: 196, name: 'CT CHEST/ABDOMEN/PELVIS', category: 'CT SCAN', price: 180000 },
            { id: 197, name: 'CT UROGRAM', category: 'CT SCAN', price: 105000 },
            { id: 198, name: 'CT CHEST WITH CONTRAST', category: 'CT SCAN', price: 90000 },
            { id: 199, name: 'CT PARANASAL SINUSES', category: 'CT SCAN', price: 80000 },
            { id: 200, name: 'CT THORACIC SPINE', category: 'CT SCAN', price: 80000 },
            { id: 201, name: 'CT NECK', category: 'CT SCAN', price: 85000 },
            { id: 202, name: 'CT LUMBOSACRAL', category: 'CT SCAN', price: 80000 },
            { id: 203, name: 'CT GUIDED BIOPSY', category: 'CT SCAN', price: 200000 },
            { id: 204, name: 'CT THORACOLUMBAR', category: 'CT SCAN', price: 170000 },
            { id: 205, name: 'CT CRANIOFACIAL', category: 'CT SCAN', price: 85000 },
            { id: 206, name: 'CT FEMUR', category: 'CT SCAN', price: 85000 },
            { id: 207, name: 'CT KNEE', category: 'CT SCAN', price: 85000 },
            { id: 208, name: 'TRIPHASIC LIVER CT', category: 'CT SCAN', price: 100000 },

            { id: 209, name: 'MRI ANKLE', category: 'MRI', price: 170000 },
            { id: 210, name: 'MRI ABDOMEN/PELVIS', category: 'MRI', price: 250000 },
            { id: 211, name: 'MRI BRAIN', category: 'MRI', price: 160000 },
            { id: 212, name: 'MRI BREAST', category: 'MRI', price: 180000 },
            { id: 213, name: 'MRI C-SPINE', category: 'MRI', price: 160000 },
            { id: 214, name: 'MRI L-SPINE', category: 'MRI', price: 160000 },
            { id: 215, name: 'MRI LEG', category: 'MRI', price: 170000 },
            { id: 216, name: 'MRI ABDOMEN', category: 'MRI', price: 230000 },
            { id: 217, name: 'MRI FOOT', category: 'MRI', price: 170000 },
            { id: 218, name: 'MRI HAND', category: 'MRI', price: 170000 },
            { id: 219, name: 'MRI RENAL', category: 'MRI', price: 170000 },
            { id: 220, name: 'MRI NECK', category: 'MRI', price: 170000 },
            { id: 221, name: 'MRI ORBIT', category: 'MRI', price: 185000 },
            { id: 222, name: 'MRI PELVIS', category: 'MRI', price: 200000 },
            { id: 223, name: 'MRI PROSTATE', category: 'MRI', price: 195000 },
            { id: 224, name: 'MRI SHOULDER', category: 'MRI', price: 170000 },
            { id: 225, name: 'MRI HIP', category: 'MRI', price: 170000 },
            { id: 226, name: 'MRI BOTH KNEES', category: 'MRI', price: 340000 },
            { id: 227, name: 'MRI WHOLE BODY', category: 'MRI', price: 650000 },
            { id: 228, name: 'MRI WHOLE SPINE', category: 'MRI', price: 480000 }
        ];

        let orders = [];

        // Mock Data - Audit Log
        let auditLog = [];

        // ====== UTILITY FUNCTIONS (SAFE VERSION) ======

// Clean data before storing (Fix A)
function prepareForSave(data) {
    try {
        // Converts to plain JSON, removing any circular refs, methods, DOM objects, etc.
        return JSON.parse(JSON.stringify(data));
    } catch (error) {
        console.error("Error sanitizing data before save:", error);
        return {};
    }
}

// Debounced Auto-Save (prevents saving too often)
let saveTimeout;

// Debounce timer for inventory suggestions to smooth typing
let inventorySuggestTimeout = null;

// Debounce timer for split payment inputs to smooth typing
let splitPaymentTimeout = null;

// Debounce timer for records search suggestions
let recordsSuggestTimeout = null;

// Debounce timer for history suggestions
let historySuggestTimeout = null;

function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveData();
    }, 500); // Save 0.5s after last change
}


async function saveData() {
    recoverUI();
    clearAllEventListeners();
    if (window.electronAPI) {

        // Build data object
        const rawData = {
            users,
            prList,
            inventory,
            drafts: appState.drafts,
            orders,
            auditLog,
            companyProfile: appState.companyProfile
        };

        // Sanitize before saving
        const cleanData = prepareForSave(rawData);

        // Send to backend
        await window.electronAPI.saveData(cleanData);
        // Post-save sanity check: if inputs remain disabled after save, attempt recovery
        setTimeout(() => {
            const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
            if (disabledEls.length > 0) {
                console.warn('Post-save check: found disabled elements, attempting recoverUI');
                recoverUI();
                clearAllEventListeners();
                // Re-render to re-attach event listeners
                try { renderApp(); } catch(e) { console.error(e); }
            }
        }, 120);
    }
}

async function loadData() {
    if (window.electronAPI) {
        const loadedData = await window.electronAPI.loadData();

        if (loadedData) {

            users = loadedData.users || [];
            prList = loadedData.prList || prList;
            inventory = loadedData.inventory || inventory;
            // Normalize saved drafts so older saves or malformed entries don't break the billing flow
            appState.drafts = (loadedData.drafts || []).map(d => ensureBillingDataShape(d));

            // Rehydrate orders
            orders = (loadedData.orders || []).map(order => ({
                ...order,
                date: new Date(order.date)
            }));

            // Rehydrate audit logs
            auditLog = (loadedData.auditLog || []).map(log => ({
                ...log,
                timestamp: new Date(log.timestamp)
            }));

            // Restore company settings
            appState.companyProfile = loadedData.companyProfile || appState.companyProfile;
        }
    }
}

        // ====== DRAFT FUNCTIONS ======
        function saveDraft() {
            // Only save if there's a patient name
            if (!appState.billingData.patientName) return;

            const existingDraftIndex = appState.drafts.findIndex(d => d.pid === appState.billingData.pid);
            const draftData = {
                ...JSON.parse(JSON.stringify(appState.billingData)), // Deep copy
                lastSaved: new Date(),
                billingStep: appState.billingStep
            };

            if (existingDraftIndex > -1) {
                appState.drafts[existingDraftIndex] = draftData;
            } else {
                appState.drafts.push(draftData);
            }
            logAction('SAVE_DRAFT', `Saved draft for '${draftData.patientName}'.`);
            autoSave();

            // Post-draft save recovery check
            setTimeout(() => {
                const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                if (disabledEls.length > 0) {
                    console.warn('Post-draft-save check: found disabled elements, attempting recoverUI');
                    recoverUI();
                    clearAllEventListeners();
                    try { renderApp(); } catch(e) { console.error(e); }
                }
            }, 120);
        }

        // Ensure billing data has required fields and sensible defaults (used when loading drafts)
        function ensureBillingDataShape(data) {
            const defaults = {
                patientName: '', pid: '', contact: '', referredBy: '', referringHospital: '', staffName: appState.currentUser ? appState.currentUser.fullName : '',
                selectedServices: [], discount: 0, total: 0, paymentMethod: 'cash', amountPaid: 0, balance: 0, paymentStatus: 'full',
                splitPayments: { cash: 0, pos: 0, transfer: 0 }
            };

            const normalized = Object.assign({}, defaults, data || {});
            // Ensure selectedServices is an array
            if (!Array.isArray(normalized.selectedServices)) normalized.selectedServices = [];
            // Ensure splitPayments has required keys
            normalized.splitPayments = Object.assign({}, defaults.splitPayments, normalized.splitPayments || {});
            // Numeric coercions
            normalized.discount = parseFloat(normalized.discount) || 0;
            normalized.amountPaid = parseFloat(normalized.amountPaid) || 0;
            normalized.balance = parseFloat(normalized.balance) || 0;

            return normalized;
        }

        // Reset billing data to defaults and clear step
        function resetBillingData() {
            appState.billingData = ensureBillingDataShape({});
            appState.billingStep = 1;
        }

        // Determine whether the billing form appears to have unsaved content
        function hasUnsavedBilling() {
            const b = appState.billingData || {};
            if (!b) return false;
            const hasContent = Boolean((b.patientName && b.patientName.trim()) || (b.selectedServices && b.selectedServices.length > 0) || b.discount > 0 || b.amountPaid > 0 || b.splitPayments && (b.splitPayments.cash || b.splitPayments.pos || b.splitPayments.transfer) || appState.billingStep > 1);
            return hasContent;
        }

        // Show a navigation confirmation modal offering Save / Discard / Cancel
        function showNavigateAwayModal(targetView) {
            appState.modal = {
                type: 'navConfirm',
                target: targetView,
                title: 'Unsaved Billing',
                message: 'You have an in-progress billing. Would you like to save it as a draft before leaving?'
            };
            renderApp();
        }

        // Show a cancel confirmation specifically for the Cancel button on billing
        function showCancelBillingModal() {
            appState.modal = {
                type: 'cancelBilling',
                title: 'Cancel Billing',
                message: 'Are you sure you want to cancel this billing? You can save it as a draft or discard changes.'
            };
            renderApp();
        }

        function handleNavConfirmSave() {
            if (!appState.modal) return;
            if (appState.modal.type === 'navConfirm') {
                // Ensure we have a patient name before saving a draft
                if (!appState.billingData.patientName || !appState.billingData.patientName.trim()) {
                    showModal('Cannot save draft: patient name is required to save a draft.', 'warning');
                    return;
                }
                saveDraft();
                const target = appState.modal.target;
                appState.modal = null;
                appState.currentView = target;
                appState.billingStep = 1;
                // Keep the draft and reset the current billing form
                resetBillingData();
                renderApp();
            } else if (appState.modal.type === 'cancelBilling') {
                if (!appState.billingData.patientName || !appState.billingData.patientName.trim()) {
                    showModal('Cannot save draft: patient name is required to save a draft.', 'warning');
                    return;
                }
                // Save draft and keep user on billing (but reset the current form)
                saveDraft();
                appState.modal = null;
                resetBillingData();
                renderApp();
            }
        }

        function handleNavConfirmDiscard() {
            if (appState.modal && (appState.modal.type === 'navConfirm' || appState.modal.type === 'cancelBilling')) {
                const target = appState.modal.target || null;
                appState.modal = null;
                // discard changes and either navigate (if target) or stay on billing but reset
                resetBillingData();
                if (target) {
                    appState.currentView = target;
                }
                renderApp();
            }
        }

        function handleNavConfirmCancel() {
            // Close the modal and do nothing
            appState.modal = null;
            renderApp();
        }

        // Public cancel function attached to Cancel buttons
        function cancelBilling() {
            showCancelBillingModal();
        }
        

        function generatePID() {
            return 'P' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(Number(amount))) return 'N/A';
            return '' + Number(amount).toLocaleString('en-NG', { minimumFractionDigits: 2 });
        }

        // Safely escape text for inclusion in HTML fragments
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str).replace(/[&<>"]+/g, function (s) {
                switch (s) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    default: return s;
                }
            });
        }

        function calculateDiscount(total, discountAmount) {
            return Math.max(0, Math.min(total, discountAmount));
        }

        function logAction(action, details) {
            auditLog.unshift({ // unshift to add to the beginning for easy sorting
                id: auditLog.length + 1,
                timestamp: new Date(),
                user: appState.currentUser.fullName,
                role: appState.currentUser.role,
                action: action,
                details: details
            });
            autoSave(); // Save after every action
        }

        function getOrderStats() {
            const stats = {
                totalRevenue: orders.reduce((sum, order) => order.status === 'PAID' ? sum + order.total : sum, 0),
                pendingBalance: orders.reduce((sum, order) => order.status === 'PENDING' ? sum + order.total : sum, 0),
                totalOrders: orders.length,
                paidOrders: orders.filter(o => o.status === 'PAID').length
            };
            return stats;
        }

        function getTodaysRevenue() {
            const todayString = new Date().toISOString().split('T')[0];
            return orders
                .filter(order => new Date(order.date).toISOString().split('T')[0] === todayString)
                .reduce((sum, order) => sum + order.total, 0);
        }

        function getTodaysDiscounts() {
            const todayString = new Date().toISOString().split('T')[0];
            return orders
                .filter(order => new Date(order.date).toISOString().split('T')[0] === todayString)
                .reduce((sum, order) => sum + (order.discount || 0), 0);
        }


        function getFilteredStats() {
            const { start, end } = appState.analyticsDateRange;
            const startDate = new Date(start);
            const endDate = new Date(end);

            const filteredOrders = orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= startDate && orderDate <= endDate;
            });

            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total, 0);
            const totalDiscounts = filteredOrders.reduce((sum, order) => sum + (order.discount || 0), 0);
            return { totalRevenue, orderCount: filteredOrders.length, totalDiscounts };
        }

        function getTopTests() {
            const testCount = {};
            orders.forEach(order => {
                order.services.forEach(service => {
                    const name = (typeof service === 'string') ? service : (service && service.name ? service.name : 'Unknown');
                    testCount[name] = (testCount[name] || 0) + 1;
                });
            });
            return Object.entries(testCount)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
        }

        function getFilteredTopTests() {
            const { start, end } = appState.analyticsDateRange;
            const startDate = new Date(start);
            const endDate = new Date(end);

            const testCount = {};
            orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= startDate && orderDate <= endDate;
            }).forEach(order => {
                order.services.forEach(service => {
                    const name = (typeof service === 'string') ? service : (service && service.name ? service.name : 'Unknown');
                    testCount[name] = (testCount[name] || 0) + 1;
                });
            });
            return Object.entries(testCount)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
        }

        function getPRPerformance() {
    const prStats = {};
    orders.forEach(order => {
        if (!prStats[order.referredBy]) {
            prStats[order.referredBy] = { orders: 0, revenue: 0 };
        }
        prStats[order.referredBy].orders += 1;
        prStats[order.referredBy].revenue += order.total;
    });

    return Object.entries(prStats)
        .map(([name, stats]) => ({
            name,
            orders: stats.orders,
            revenue: stats.revenue
        }))
        .sort((a, b) => b.revenue - a.revenue);
}


        function getPaymentStats() {
            const stats = {
                fullPayment: orders.filter(o => o.paymentStatus === 'full').length,
                installment: orders.filter(o => o.paymentStatus === 'installment').length
            };
            return stats;
        }

       function getFilteredPRPerformance() {
    const { start, end } = appState.analyticsDateRange;
    const startDate = new Date(start);
    const endDate = new Date(end);

    const prStats = {};
    orders.filter(order => {
        const orderDate = new Date(order.date);
        return orderDate >= startDate && orderDate <= endDate;
    }).forEach(order => {
        if (!prStats[order.referredBy]) {
            prStats[order.referredBy] = { orders: 0, revenue: 0 };
        }
        prStats[order.referredBy].orders++;
        prStats[order.referredBy].revenue += order.total;
    });

    return Object.entries(prStats)
        .map(([name, stats]) => ({
            name,
            orders: stats.orders,
            revenue: stats.revenue
        }))
        .sort((a, b) => b.revenue - a.revenue);
}


       function getDailyPRPerformance(date) {
    const dateString = date.toISOString().split('T')[0];
    const prStats = {};

    orders.filter(order =>
        new Date(order.date).toISOString().split('T')[0] === dateString
    ).forEach(order => {
        if (!prStats[order.referredBy]) {
            prStats[order.referredBy] = { orders: 0, revenue: 0 };
        }
        prStats[order.referredBy].orders++;
        prStats[order.referredBy].revenue += order.total;
    });

    return Object.entries(prStats)
        .map(([name, stats]) => ({
            name,
            orders: stats.orders,
            revenue: stats.revenue
        }))
        .sort((a, b) => b.orders - a.orders);
}

        // Calculate commission for a single order: sum of test prices * 10%
        function calculateOrderCommission(order) {
            if (!order || !order.services || order.services.length === 0) return (order.total || 0) * 0.10;

            let totalServicePrice = 0;
            order.services.forEach(service => {
                let price = 0;
                if (typeof service === 'number') {
                    price = service;
                } else if (typeof service === 'string') {
                    const inv = inventory.find(i => i.name === service);
                    if (inv && inv.price) price = Number(inv.price) || 0;
                } else if (service && service.price) {
                    price = Number(service.price) || 0;
                }
                totalServicePrice += price;
            });

            if (totalServicePrice === 0) totalServicePrice = order.total || 0;
            return totalServicePrice * 0.10; // 10% commission
        }

        function getFilteredPRCommissions() {
            const { start, end } = appState.analyticsDateRange;
            const startDate = new Date(start);
            const endDate = new Date(end);

            const prStats = {};
            orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= startDate && orderDate <= endDate;
            }).forEach(order => {
                const name = order.referredBy || 'Unknown';
                if (!prStats[name]) prStats[name] = { orders: 0, revenue: 0, commission: 0 };
                prStats[name].orders++;
                prStats[name].revenue += order.total;
                prStats[name].commission += calculateOrderCommission(order);
            });

            return Object.entries(prStats).map(([name, stats]) => ({
                name,
                orders: stats.orders,
                revenue: stats.revenue,
                commission: stats.commission
            })).sort((a, b) => b.commission - a.commission);
        }

        function getDailyPRCommissions(date) {
            const dateString = date.toISOString().split('T')[0];
            const prStats = {};

            orders.filter(order => new Date(order.date).toISOString().split('T')[0] === dateString)
                .forEach(order => {
                    const name = order.referredBy || 'Unknown';
                    if (!prStats[name]) prStats[name] = { orders: 0, revenue: 0, commission: 0 };
                    prStats[name].orders++;
                    prStats[name].revenue += order.total;
                    prStats[name].commission += calculateOrderCommission(order);
                });

            return Object.entries(prStats).map(([name, stats]) => ({
                name,
                orders: stats.orders,
                revenue: stats.revenue,
                commission: stats.commission
            })).sort((a, b) => b.commission - a.commission);
        }

        function getDailyTopTests(date) {
            const dateString = date.toISOString().split('T')[0];
            const testCount = {};
            orders.filter(order => new Date(order.date).toISOString().split('T')[0] === dateString)
                .forEach(order => {
                    order.services.forEach(service => {
                        const name = (typeof service === 'string') ? service : (service && service.name ? service.name : 'Unknown');
                        testCount[name] = (testCount[name] || 0) + 1;
                    });
                });

            return Object.entries(testCount)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
        }

        function getDailyPaymentSummary(date) {
            const summary = { cash: 0, pos: 0, transfer: 0, total: 0 };
            const dateString = date.toISOString().split('T')[0];

            orders
                .filter(order => new Date(order.date).toISOString().split('T')[0] === dateString && order.amountPaid > 0)
                .forEach(order => {
                    if (order.paymentMethod === 'split' && order.splitPayments) {
                        // Handle split payments by adding each part to the summary
                        summary.cash += order.splitPayments.cash || 0;
                        summary.pos += order.splitPayments.pos || 0;
                        summary.transfer += order.splitPayments.transfer || 0;
                    } else {
                        // Handle single payment methods
                        const amount = order.amountPaid || 0;
                        if (order.paymentMethod === 'cash') summary.cash += amount;
                        else if (order.paymentMethod === 'pos') summary.pos += amount;
                        else if (order.paymentMethod === 'transfer') summary.transfer += amount;
                    }
                });
            summary.total = summary.cash + summary.pos + summary.transfer;

            return summary;
        }

        function getDailyTestSummaryByCategory(date) {
            const summary = {}; // Use an object to store data by category
            const dateString = date.toISOString().split('T')[0];

            orders
                .filter(order => new Date(order.date).toISOString().split('T')[0] === dateString)
                .forEach(order => {
                    // Calculate the subtotal of services before any discount
                    const subtotal = order.services.reduce((sum, service) => sum + (service.price || 0), 0);

                    // Determine the discount ratio. If subtotal is 0, ratio is 0.
                    const discountRatio = (subtotal > 0 && order.discount > 0) ? order.discount / subtotal : 0;

                    order.services.forEach(service => {
                        const category = service.category || 'Uncategorized';
                        const originalPrice = service.price || 0;

                        // Calculate the effective price after applying the proportional discount
                        const effectivePrice = originalPrice * (1 - discountRatio);

                        if (!summary[category]) {
                            summary[category] = { testCount: 0, totalAmount: 0 };
                        }
                        summary[category].testCount++;
                        summary[category].totalAmount += effectivePrice;
                    });
                });

            return Object.entries(summary).map(([category, data]) => ({ category, ...data }));
        }

        // getFilteredRecords consolidated below (removed duplicate)
        

        function getFilteredRecords() {
            const filters = appState.recordFilters;
            let filtered = [...orders]; // Start with a copy of all orders

            // Support explicit filter types (date, month, year)
            if (filters.filterType === 'date' && filters.date) {
                filtered = filtered.filter(order => new Date(order.date).toISOString().split('T')[0] === filters.date);
            } else if (filters.filterType === 'month' && filters.month) {
                const [year, month] = filters.month.split('-');
                filtered = filtered.filter(order => {
                    const orderDate = new Date(order.date);
                    return orderDate.getFullYear() == year && (orderDate.getMonth() + 1) == month;
                });
            } else if (filters.filterType === 'year' && filters.year) {
                filtered = filtered.filter(order => new Date(order.date).getFullYear() == filters.year);
            } else if (!filters.searchAllRecords) {
                // Default to daily view if no specific filter is set and not searching all
                const viewDate = new Date(appState.recordsViewDate).toISOString().split('T')[0];
                filtered = filtered.filter(order => new Date(order.date).toISOString().split('T')[0] === viewDate);
            }

            // Apply search query on top of date filters
            if (filters.searchQuery) {
                const query = filters.searchQuery.toLowerCase();
                filtered = filtered.filter(order =>
                    (order.patientName || '').toLowerCase().includes(query) ||
                    (order.pid || '').toLowerCase().includes(query)
                );
            }

            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date)); // Always sort by most recent
        }

        function exportToCSV() {
            let csv = 'Patient Name,PID,Services,Total,Status,Referred By,Staff Name,Date,Time,Payment Method,Payment Status\n';
            orders.forEach(order => {
                const serviceNames = order.services.map(s => (typeof s === 'string') ? s : (s && s.name ? s.name : '')).join('; ');
                const orderDate = new Date(order.date).toISOString().split('T')[0];
                csv += `"${order.patientName}","${order.pid}","${serviceNames}",${order.total},"${order.status}","${order.referredBy}","${order.staffName}","${orderDate}","${order.time || 'N/A'}","${order.paymentMethod || 'N/A'}","${order.paymentStatus || 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const toggleIcon = document.querySelector(`[data-toggle-for='${inputId}']`);
            if (input && toggleIcon) {
                if (input.type === 'password') {
                    input.type = 'text';
                    toggleIcon.innerHTML = '&#128064;'; // Eye-slash icon
                } else {
                    input.type = 'password';
                    toggleIcon.innerHTML = '&#128065;'; // Eye icon
                }
            }
        }

        // ====== COMPONENT-BASED RENDER FUNCTIONS ======
        const components = {
            Sidebar: ({ currentUser, currentView, sidebarCollapsed }) => {
                const isAdmin = currentUser && currentUser.role === 'Admin';
                const canAccessPRAndAnalytics = currentUser && (currentUser.role === 'Admin' || currentUser.role === 'Staff');

                return `
                    <div class="sidebar ${sidebarCollapsed ? 'collapsed' : ''}">
                        <div class="sidebar-header">
                            <div class="sidebar-logo">SDC</div>
                            <button class="sidebar-toggle" onclick="toggleSidebar()">
                                ${sidebarCollapsed ? '&#8594;' : '&#8592;'}
                            </button>
                        </div>
                        
                        <nav class="sidebar-nav">
                            <div class="nav-item ${currentView === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">
                                <div class="nav-item-icon">&#128202;</div>
                                <div class="nav-item-label">Dashboard</div>
                            </div>
                            
                            <div class="nav-item ${currentView === 'billing' ? 'active' : ''}" onclick="navigateTo('billing')">
                                <div class="nav-item-icon">&#128203;</div>
                                <div class="nav-item-label">Billing</div>
                            </div>

                            <div class="nav-item ${currentView === 'drafts' ? 'active' : ''}" onclick="navigateTo('drafts')">
                                <div class="nav-item-icon">&#128190;</div>
                                <div class="nav-item-label">Drafts</div>
                            </div>
                            
                            <div class="nav-item ${currentView === 'inventory' ? 'active' : ''}" onclick="navigateTo('inventory')">
                                <div class="nav-item-icon"></div>
                                <div class="nav-item-label">Inventory</div>
                            </div>
                            
                            ${canAccessPRAndAnalytics ? `
                            <div class="nav-item ${currentView === 'pr-management' ? 'active' : ''}" onclick="navigateTo('pr-management')">
                                <div class="nav-item-icon">&#128101;</div>
                                <div class="nav-item-label">PR Management</div>
                            </div>
                            
                            <div class="nav-item ${currentView === 'analytics' ? 'active' : ''}" onclick="navigateTo('analytics')">
                                <div class="nav-item-icon">&#128200;</div>
                                <div class="nav-item-label">Analytics</div>
                            </div>
                            ` : ''}
                            ${isAdmin ? `
                            <div class="nav-item ${currentView === 'history' ? 'active' : ''}" onclick="navigateTo('history')">
                                <div class="nav-item-icon">&#128220;</div>
                                <div class="nav-item-label">History</div>
                            </div>

                            <div class="nav-item ${currentView === 'staff-management' ? 'active' : ''}" onclick="navigateTo('staff-management')">
                                <div class="nav-item-icon">&#129489;&zwj;&#128188;</div>
                                <div class="nav-item-label">Staff Management</div>
                            </div>
                            ` : ''}
                            
                            <div class="nav-item ${currentView === 'records' ? 'active' : ''}" onclick="navigateTo('records')">
                                <div class="nav-item-icon"></div>
                                <div class="nav-item-label">Records</div>
                            </div>
                            
                            <div class="nav-item ${currentView === 'settings' ? 'active' : ''}" onclick="navigateTo('settings')">
                                <div class="nav-item-icon">&#9881;&#65039;</div>
                                <div class="nav-item-label">Settings</div>
                            </div>
                        </nav>
                        
                        <div class="sidebar-footer">
                            <button class="nav-item" onclick="logout()" style="width: 100%; justify-content: center; background-color: rgba(239, 68, 68, 0.2); color: #fecaca;">
                                <div class="nav-item-icon">&#128682;</div>
                                <div class="nav-item-label">Logout</div>
                            </button>
                        </div>
                    </div>
                `;
            },
            Header: ({ currentUser, companyProfile, sidebarCollapsed }) => {
                return `
                    <div class="header ${sidebarCollapsed ? 'sidebar-collapsed' : ''}">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="header-title">${companyProfile.name.split(' ')[0]}</div>
                            <div class="header-role">${currentUser.role} Dashboard</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 2rem;">
                            <div id="header-datetime" style="text-align: right;">
                                <div id="header-time" style="font-size: 1.25rem; font-weight: 700;"></div>
                                <div id="header-date" style="font-size: 0.8rem; opacity: 0.9;"></div>
                            </div>
                            <div class="header-user">
                                <span>&#128100; ${currentUser.fullName}</span>
                            </div>
                        </div>
                    </div>
                `;
            },

         Login: {
                render: ({ companyProfile }) => {
                    // If no users exist, show setup form for first admin
                    if (users.length === 0) {
                        return components.Login.setupForm({ companyProfile });
                    }
                    // Normal login form
                    return components.Login.Form({ companyProfile });
                },
                setupForm: ({ companyProfile }) => `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                        <div class="card" style="width: 100%; max-width: 500px; transform: scale(1); animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <div style="margin-bottom: 1rem;"><img src="${companyProfile.logo}" alt="Company Logo" style="height: 60px; width: auto; margin: 0 auto;"/></div>
                                <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${companyProfile.name}</h1>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Initial Setup - Create Admin Account</p>
                            </div>
                            <div style="background: var(--background); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">No users found. Please create the first admin account to begin.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name *</label>
                                <input type="text" id="setupFullName" class="form-input" placeholder="e.g., John Administrator" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username *</label>
                                <input type="text" id="setupUsername" class="form-input" placeholder="e.g., admin" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password *</label>
                                <div style="position: relative; display: flex; align-items: center;">
                                    <input type="password" id="setupPassword" class="form-input" placeholder="Minimum 6 characters" style="padding-right: 2.5rem;" />
                                    <button type="button" data-toggle-for="setupPassword" onclick="togglePasswordVisibility('setupPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password *</label>
                                <div style="position: relative; display: flex; align-items: center;">
                                    <input type="password" id="setupPasswordConfirm" class="form-input" placeholder="Confirm password" style="padding-right: 2.5rem;" />
                                    <button type="button" data-toggle-for="setupPasswordConfirm" onclick="togglePasswordVisibility('setupPasswordConfirm')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                </div>
                            </div>
                            <button onclick="handleFirstTimeSetup()" class="btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 1rem;">
                                Create Admin Account
                            </button>
                        </div>
                    </div>
                `,
                handleLogin: async function() {
                    const usernameEl = document.getElementById('loginUsername');
                    const passwordEl = document.getElementById('loginPassword');
                    const username = (usernameEl && usernameEl.value || '').trim().toLowerCase();
                    const password = (passwordEl && passwordEl.value || '').toLowerCase();
                    if (!username || !password) {
                        await showModal('Please enter both username and password', 'warning');
                        // Focus username for user convenience
                        const userInput = document.getElementById('loginUsername');
                        if (userInput) userInput.focus();
                        return;
                    }
                    // Case-insensitive check: compare normalized lowercase username/password
                    const user = users.find(u => (u.username || '').toLowerCase() === username);
                    if (user && (user.password || '').toLowerCase() === password) {
                        appState.currentUser = { username: user.username, role: user.role, fullName: user.fullName };
                        logAction('LOGIN', `User '${user.fullName}' logged in.`);
                        appState.currentView = 'dashboard';
                        renderApp();
                    } else {
                        await showModal('Invalid username or password. If no users exist, please set up the first admin user.', 'error');
                        // Clear password and focus username for retry
                        const pwInput = document.getElementById('loginPassword');
                        const userInput = document.getElementById('loginUsername');
                        if (pwInput) pwInput.value = '';
                        if (userInput) userInput.focus();
                    }
                },
                 
                
                Form: ({ companyProfile }) => `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                        <div class="card" style="width: 100%; max-width: 400px; transform: scale(1); animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <div style="margin-bottom: 1rem;"><img src="${companyProfile.logo}" alt="Company Logo" style="height: 60px; width: auto; margin: 0 auto;"/></div>
                                <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${companyProfile.name}</h1>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Diagnostic Center Management</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <div style="position: relative; display: flex; align-items: center;">
                                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" style="padding-right: 2.5rem;" />
                                    <button type="button" data-toggle-for="loginPassword" onclick="togglePasswordVisibility('loginPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                </div>
                            </div>
                            <button onclick="components.Login.handleLogin()" class="btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 1rem;">
                                Sign In
                            </button>
                        </div>
                    </div>
                `
            },
    // Placeholder for other components
};

// ====== RENDER FUNCTIONS ======
const loadPreferences = function() {
    // Load theme
    const savedTheme = localStorage.getItem('appTheme') || 'light';
    const savedColorTheme = localStorage.getItem('appColorTheme') || 'blue';
    
    appState.theme = savedTheme;
    appState.colorTheme = savedColorTheme;
    
    // Load company profile
    const savedProfile = localStorage.getItem('companyProfile');
    if (savedProfile) {
        appState.companyProfile = JSON.parse(savedProfile);
    }

    applyTheme();
}

function applyTheme() {
    const html = document.documentElement;
    
    if (appState.theme === 'dark') {
        html.classList.add('dark-mode');
    } else {
        html.classList.remove('dark-mode');
    }
    
    // Remove all theme classes and add the active one
    html.classList.remove('theme-blue', 'theme-skyblue', 'theme-gray', 'theme-brown', 'theme-green', 'theme-purple');
    html.classList.add(`theme-${appState.colorTheme}`);
    
    // Save preferences
    localStorage.setItem('appTheme', appState.theme);
    localStorage.setItem('appColorTheme', appState.colorTheme);
}

function updateHeaderDateTime() {
    const timeEl = document.getElementById('header-time');
    const dateEl = document.getElementById('header-date');
    if (timeEl && dateEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
}

        function renderDashboard() {
            const todayString = new Date().toISOString().split('T')[0];
            const todaysOrders = orders.filter(order => new Date(order.date).toISOString().split('T')[0] === todayString);

            return `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Welcome, ${appState.currentUser.fullName}! &#128075;</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="quick-card animate-slide-in" style="animation-delay: 0s;" onclick="navigateTo('billing')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#128221;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">New Patient Entry</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Start billing process</div>
                        </div>

                        <div class="quick-card animate-slide-in" style="animation-delay: 0.1s;" onclick="navigateTo('records')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#128194;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Patient Records</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">View historical data</div>
                        </div>

                        <div class="quick-card accent animate-slide-in" style="animation-delay: 0.2s;" onclick="navigateTo('inventory')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#129514;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Inventory</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">View available tests</div>
                        </div>

                        ${(appState.currentUser.role === 'Admin' || appState.currentUser.role === 'Staff') ? `
                        <div class="quick-card animate-slide-in" style="animation-delay: 0.3s;" onclick="navigateTo('pr-management')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#128101;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">PR Management</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Manage professionals</div>
                        </div>

                        <div class="quick-card animate-slide-in" style="animation-delay: 0.4s;" onclick="navigateTo('analytics')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#128202;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Analytics</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">View reports & insights</div>
                        </div>
                        ` : ''}
                        ${appState.currentUser.role === 'Admin' ? `
                        <div class="quick-card accent animate-slide-in" style="animation-delay: 0.5s;" onclick="navigateTo('staff-management')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">&#129489;&zwj;&#128188;</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Staff Management</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Add or remove staff</div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="card animate-fade-in">
                        <h3 style="font-weight: 700; margin-bottom: 1rem; font-size: 1.125rem;">Quick Stats</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Today's Revenue</p>
                                <p style="font-size: 1.75rem; font-weight: 700; color: var(--accent);">${formatCurrency(getTodaysRevenue())}</p>
                            </div>
                            <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Today's Patients</p>
                                <p style="font-size: 1.75rem; font-weight: 700; color: var(--primary);">${todaysOrders.length}</p>
                            </div>
                            <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Today's Discounts</p>
                                <p style="font-size: 1.75rem; font-weight: 700; color: var(--warning);">${formatCurrency(getTodaysDiscounts())}</p>
                            </div>
                            <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Today's Full Payments</p>
                                <p style="font-size: 1.75rem; font-weight: 700; color: var(--success);">${todaysOrders.filter(o => o.status === 'PAID').length}</p>
                            </div>
                            <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Today's Outstanding</p>
                                <p style="font-size: 1.75rem; font-weight: 700; color: var(--warning);">
                                    ${formatCurrency(todaysOrders.reduce((sum, o) => sum + (o.balance || 0), 0))}
                                </p>
                                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.25rem;">
                                    from ${todaysOrders.filter(o => o.paymentStatus === 'installment' && o.balance > 0).length} patients</p>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Summary Section -->
                    <div class="card animate-fade-in" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <h3 style="font-weight: 700; font-size: 1.125rem; margin: 0;">
                                Daily Payment Summary: ${appState.recordFilters.dailySummaryDate.toLocaleDateString('en-CA')}
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-secondary" onclick="changeDailySummaryDate(-1)">&#8592; Previous Day</button>
                                <button class="btn-secondary" onclick="changeDailySummaryDate(1)" ${new Date(appState.recordFilters.dailySummaryDate).setHours(0,0,0,0) >= new Date().setHours(0,0,0,0) ? 'disabled' : ''}>Next Day &#8594;</button>
                            </div>
                        </div>
                        ${(() => {
                            const dailySummary = getDailyPaymentSummary(appState.recordFilters.dailySummaryDate);
                            return `
                                <div class="grid-3">
                                    <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Cash</p>
                                        <p style="font-size: 1.75rem; font-weight: 700; color: var(--success);">${formatCurrency(dailySummary.cash)}</p>
                                    </div>
                                    <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                        <p style="color: var(--text-secondary); font-size: 0.875rem;">POS</p>
                                        <p style="font-size: 1.75rem; font-weight: 700; color: var(--success);">${formatCurrency(dailySummary.pos)}</p>
                                    </div>
                                    <div style="padding: 1rem; background-color: var(--background); border-radius: 0.5rem;">
                                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Transfer</p>
                                        <p style="font-size: 1.75rem; font-weight: 700; color: var(--success);">${formatCurrency(dailySummary.transfer)}</p>
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>

                    <!-- Daily Test Summary Section -->
                    <div class="card animate-fade-in" style="margin-top: 2rem;">
                        <h3 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1.5rem;">Daily Test Summary by Category</h3>
                        ${(() => {
                            const testSummary = getDailyTestSummaryByCategory(appState.recordFilters.dailySummaryDate);
                            if (testSummary.length === 0) {
                                return `<div style="text-align: center; color: var(--text-secondary); padding: 1rem;">No tests recorded for this day.</div>`;
                            }
                            return `
                                <div class="responsive-table-wrapper">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Test Category</th>
                                                <th style="text-align: right;">Tests Done</th>
                                                <th style="text-align: right;">Total Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${testSummary.map(item => `
                                                <tr>
                                                    <td><strong>${item.category}</strong></td>
                                                    <td style="text-align: right;">${item.testCount}</td>
                                                    <td style="text-align: right; font-weight: 700; color: var(--primary);">${formatCurrency(item.totalAmount)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>`;
                        })()}
                    </div>
                </div>
            `;
        }

        function renderBilling() {
            return `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Patient Billing</h2>

                    <div class="wizard-header animate-slide-up">
                        <div class="step-indicator ${appState.billingStep >= 1 ? 'active' : ''} ${appState.billingStep > 1 ? 'completed' : ''}">
                            <div class="step-number">${appState.billingStep > 1 ? '' : '1'}</div>
                            <div class="step-label">Patient Details</div>
                        </div>
                        <div style="width: 2rem; height: 0.125rem; background-color: var(--border); margin-top: 1rem;"></div>
                        <div class="step-indicator ${appState.billingStep >= 2 ? 'active' : ''} ${appState.billingStep > 2 ? 'completed' : ''}">
                            <div class="step-number">${appState.billingStep > 2 ? '' : '2'}</div>
                            <div class="step-label">Services</div>
                        </div>
                        <div style="width: 2rem; height: 0.125rem; background-color: var(--border); margin-top: 1rem;"></div>
                        <div class="step-indicator ${appState.billingStep >= 3 ? 'active' : ''}">
                            <div class="step-number">${appState.billingStep === 3 ? '3' : ''}</div>
                            <div class="step-label">Finalize</div>
                        </div>
                    </div>

                    <!-- Step 1: Patient Details -->
                    <div id="step1" style="display: ${appState.billingStep === 1 ? 'block' : 'none'}" class="animate-slide-up">
                        <div class="card">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Patient Information</h3>

                            <div class="form-group">
                                <label class="form-label">Patient Name *</label>
                                <input type="text" id="patientName" class="form-input" placeholder="Enter patient full name" value="${appState.billingData.patientName}" />
                            </div>

                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Patient ID (Auto-generated)</label>
                                    <input type="text" class="form-input" value="${appState.billingData.pid || generatePID()}" readonly />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact Number</label>
                                    <input type="tel" id="patientContact" class="form-input" placeholder="Phone number" value="${appState.billingData.contact}" />
                                </div>
                            </div>

                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Referred By</label>
                                    <div style="position:relative;">
                                        <input type="text" id="referredBySearch" class="form-input" placeholder="Type PR agent name..." value="${appState.billingData.referredBy || ''}" />
                                        <div id="prSuggestions" style="position:absolute; top:100%; left:0; right:0; background:var(--background); border:1px solid var(--border); border-top:none; max-height:200px; overflow-y:auto; z-index:100; display:none; border-radius:0 0 0.25rem 0.25rem;"></div>
                                    </div>
                                    <div style="margin-top:0.5rem;">
                                        <label class="form-label" style="font-size:0.85rem; margin-bottom:0.25rem;">Referring Hospital</label>
                                        <input type="text" id="referringHospital" class="form-input" placeholder="Hospital name (optional)" value="${appState.billingData.referringHospital || ''}" />
                                    </div>
                                    <div id="addPRAgentContainer" style="margin-top:0.5rem; display:none;">
                                        <button id="addNewPRBtn" class="btn-secondary" style="padding:0.4rem 0.75rem; font-size:0.85rem;">+ Add New PR Agent</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Staff Name *</label>
                                    <input type="text" id="staffName" class="form-input" placeholder="Your name" value="${appState.currentUser.fullName}" readonly />
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button onclick="billingStep(2)" class="btn-primary">Next: Select Services</button>
                                <button onclick="cancelBilling()" class="btn-secondary" title="Cancel billing and reset form">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Services Selection -->
                    <div id="step2" style="display: ${appState.billingStep === 2 ? 'block' : 'none'}" class="animate-slide-up">
                        <div class="card">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Select Services</h3>

                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                                <div style="font-size:0.95rem; color:var(--text-secondary);">Quick picks: recent / popular services</div>
                                <div style="display:flex; gap:0.5rem; align-items:center;">
                                    <label style="font-size:0.9rem; color:var(--text-secondary);">VIP Form</label>
                                    <button class="btn-secondary" onclick="toggleVIPMode()" style="padding:0.25rem 0.75rem; font-size:0.85rem;">
                                        ${appState.vipMode ? 'Disable VIP' : 'Enable VIP'}
                                    </button>
                                </div>
                            </div>

                            <!-- Popular / Recent Suggestions -->
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">
                                ${(() => {
                                    const top = getTopTests();
                                    if (!top || top.length === 0) return '<div style="color:var(--text-secondary);">No recent services</div>';
                                    return top.map(t => {
                                        const inv = inventory.find(i => i.name === t.name);
                                        const id = inv ? inv.id : '';
                                        return `<button class="btn-secondary" onclick="addServiceById(${id})">${t.name}</button>`;
                                    }).join('');
                                })()}
                            </div>

                            <!-- Search / Autocomplete -->
                            <div style="margin-bottom:1rem; display:flex; gap:0.5rem; align-items:center;">
                                <input id="serviceSearch" class="form-input" placeholder="Type a test or category name to search..." style="flex:1;" autocomplete="off" oninput="renderServiceSuggestions(this.value)" onfocus="renderServiceSuggestions(this.value)" onmousedown="renderServiceSuggestions(this.value || '')" />
                                <button class="btn-primary" onclick="openCategoryList()" title="Browse categories">Browse</button>
                            </div>
                            <div id="serviceSuggestions" role="listbox" aria-expanded="false" style="margin-bottom:1rem; display:none;"></div>

                            <!-- Selected Services (compact list is displayed in the preview below) -->
                            <div style="font-size:0.9rem;color:var(--text-secondary); margin-bottom: 0.75rem;">Selected services are shown in the preview panel below.</div>

                            <div class="form-group">
                                <label class="form-label">Discount Amount</label>
                                <input type="number" id="discount" class="form-input" placeholder="Enter discount ()" value="${appState.billingData.discount}" />
                            </div>

                            <div style="background-color: var(--background); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                                <div id="selectedServicesList" style="margin-bottom: 1rem; font-size: 0.9rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                                    <div style="color: var(--text-secondary); text-align: center;">No services selected yet.</div>
                                </div>

                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; color: var(--text-secondary);">
                                    <span>Discount:</span>
                                    <span id="discountDisplay">-0.00</span>
                                </div>
                                <div style="border-top: 1px solid var(--border); padding-top: 1rem; display: flex; justify-content: space-between; font-weight: 700; font-size: 1.125rem;">
                                    <span>Total:</span>
                                    <span id="totalAmount" style="color: var(--primary);">0.00</span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button onclick="billingStep(1)" class="btn-secondary"> Back</button>
                                <button onclick="finalizeBilling()" class="btn-primary">Finalize Payment</button>
                                <button onclick="cancelBilling()" class="btn-secondary" title="Cancel billing and reset form">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Finalize Payment -->
                    <div id="step3" style="display: ${appState.billingStep === 3 ? 'block' : 'none'}" class="animate-pop">
                        <div class="card">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Payment Information</h3>

                            <!-- Added Payment Method Section -->
                            <div style="margin-bottom: 2rem;">
                                <label class="form-label" style="margin-bottom: 1rem;">Payment Method *</label>
                                <div class="payment-method">
                                    <div class="payment-option ${appState.billingData.paymentMethod === 'cash' ? 'active' : ''}" onclick="selectPaymentMethod('cash')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">Cash</div>
                                    </div>
                                    <div class="payment-option ${appState.billingData.paymentMethod === 'pos' ? 'active' : ''}" onclick="selectPaymentMethod('pos')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">POS</div>
                                    </div>
                                    <div class="payment-option ${appState.billingData.paymentMethod === 'transfer' ? 'active' : ''}" onclick="selectPaymentMethod('transfer')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">Transfer</div>
                                    </div>
                                    <div class="payment-option ${appState.billingData.paymentMethod === 'split' ? 'active' : ''}" onclick="selectPaymentMethod('split')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">Split Payment</div>
                                    </div>
                                </div>
                                ${appState.billingData.paymentMethod === 'split' ? renderSplitPaymentInputs() : ''}
                            </div>

                            <!-- Added Payment Status Section -->
                            <div style="margin-bottom: 2rem;">
                                <label class="form-label" style="margin-bottom: 1rem;">Payment Status *</label>
                                <div class="payment-method">
                                    <div class="payment-option ${appState.billingData.paymentStatus === 'full' ? 'active' : ''}" onclick="selectPaymentStatus('full')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">Full Payment</div>
                                    </div>
                                    <div class="payment-option ${appState.billingData.paymentStatus === 'installment' ? 'active' : ''}" onclick="selectPaymentStatus('installment')">
                                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                                        <div style="font-weight: 500;">Installment</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Added Amount Paid for Installment -->
                            ${appState.billingData.paymentStatus === 'installment' ? `
                                <div class="animate-fade-in">
                                    <div class="form-group">
                                        <label class="form-label">Amount Paid</label>
                                        <input type="number" id="amountPaid" class="form-input" value="${appState.billingData.amountPaid}" oninput="updateInstallmentPayment(this.value)" ${appState.billingData.paymentMethod === 'split' ? 'readonly' : ''} />
                                    </div>
                                    <div style="font-size: 1rem; margin-bottom: 2rem; text-align: right;">
                                        Remaining Balance: 
                                        <strong style="color: var(--error); font-size: 1.25rem;">
                                            ${formatCurrency(appState.billingData.balance)}
                                        </strong>
                                    </div>
                                </div>
                            ` : ''}

                            <div style="background-color: var(--background); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                                <h4 style="font-weight: 600; margin-bottom: 1rem;">Receipt Preview</h4>
                                <div style="border: 1px solid var(--border); padding: 1.5rem; background-color: white; border-radius: 0.5rem;">
                                    <div style="text-align: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                                        <div style="margin-bottom: 0.5rem;"><img src="${appState.companyProfile.logo}" alt="Company Logo" style="height: 40px; width: auto; margin: 0 auto;"/></div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">${appState.companyProfile.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                            <p>${appState.companyProfile.address}</p>
                                            <p>${appState.companyProfile.email} | ${appState.companyProfile.contact}</p>
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">Receipt</div>
                                    </div>

                                    <div style="margin-bottom: 1rem; font-size: 0.9rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span><strong>Patient:</strong></span>
                                            <span id="receiptPatient">${appState.billingData.patientName}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span><strong>PID:</strong></span>
                                            <span id="receiptPID">${appState.billingData.pid}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span><strong>Referring Hospital:</strong></span>
                                            <span id="receiptHospital">${appState.billingData.referringHospital || 'N/A'}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span><strong>Staff:</strong></span>
                                            <span id="receiptStaff">${appState.billingData.staffName}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                            <span><strong>Date:</strong></span>
                                            <span>${new Date().toLocaleDateString()}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span><strong>Time:</strong></span>
                                            <span>${new Date().toLocaleTimeString()}</span>
                                        </div>
                                    </div>

                                    <div style="border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 1rem 0; font-size: 0.9rem; margin-bottom: 1rem;">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Services:</div>
                                        <div id="receiptServices">
                                            ${appState.billingData.selectedServices.map(s => `
                                                <div style="display: flex; justify-content: space-between; margin-bottom:0.25rem;">
                                                    <div>
                                                        <div> ${s.name}</div>
                                                        <div style="font-size:0.8rem; color:var(--text-secondary);">${s.category || ''}</div>
                                                    </div>
                                                    <div style="font-weight:700">${formatCurrency(s.overridePrice != null ? s.overridePrice : s.price)}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div style="font-size: 0.9rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span>Total:</span>
                                            <span id="receiptTotal"></span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-secondary);">
                                            <span>Payment Method:</span>
                                            <span id="receiptPaymentMethod">${appState.billingData.paymentMethod || 'N/A'}</span>
                                        </div>
                                        ${Object.values(appState.billingData.splitPayments).filter(v => v > 0).length > 1 ? `
                                            <div style="padding-left: 1rem; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                                ${appState.billingData.splitPayments.cash > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Cash:</span> <span>${formatCurrency(appState.billingData.splitPayments.cash)}</span></div>` : ''}
                                                ${appState.billingData.splitPayments.pos > 0 ? `<div style="display: flex; justify-content: space-between;"><span>POS:</span> <span>${formatCurrency(appState.billingData.splitPayments.pos)}</span></div>` : ''}
                                                ${appState.billingData.splitPayments.transfer > 0 ? `<div style="display: flex; justify-content: space-between;"><span>Transfer:</span> <span>${formatCurrency(appState.billingData.splitPayments.transfer)}</span></div>` : ''}
                                            </div>
                                        ` : ''}
                                        </div>
                                        ${appState.billingData.paymentStatus === 'installment' ? `
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-secondary);">
                                                <span>Amount Paid:</span>
                                                <span id="receiptAmountPaid">${formatCurrency(appState.billingData.amountPaid)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--error);">
                                                <span>Balance Due:</span>
                                                <span id="receiptBalance">${formatCurrency(appState.billingData.balance)}</span>
                                            </div>
                                        ` : `
                                            <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--success);">
                                                <span>Status:</span>
                                                <span id="receiptPaymentStatus">Full Payment</span>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button onclick="billingStep(2)" class="btn-secondary"> Back</button>
                                <button onclick="submitBilling()" class="btn-primary"> Complete Billing</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper for action buttons to avoid repetition
        function renderActionButtons(onSave, onCancel) {
            return `
                <button onclick="${onSave}" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"></button>
                <button onclick="${onCancel}" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"></button>
            `;
        }
        function renderInventory() {
            const searchQuery = appState.inventorySearchQuery.toLowerCase();
            const filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchQuery) || 
                item.category.toLowerCase().includes(searchQuery));
            return `
                <div style="max-width: 1200px; margin: 0 auto;" class="animate-slide-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 2rem; font-weight: 700;">Inventory & Test Pricing</h2>
                        ${appState.currentUser.role === 'Admin' ? `
                            <button onclick="toggleAddInventoryForm()" class="btn-primary"> 
                                ${appState.showAddInventoryForm ? ' Cancel' : '+ Add New Test'}
                            </button>
                        ` : ''}
                    </div>

                    <!-- Add New Inventory Form -->
                    ${appState.showAddInventoryForm ? `
                        <div class="card animate-fade-in" style="margin-bottom: 2rem;">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Add New Inventory Item</h3>
                            <div class="grid-3">
                                <div class="form-group">
                                    <label class="form-label">Test Name</label>
                                    <input type="text" id="newInventoryName" class="form-input" placeholder="e.g., ECG">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <input type="text" id="newInventoryCategory" class="form-input" placeholder="e.g., Cardiology">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price</label>
                                    <input type="number" id="newInventoryPrice" class="form-input" placeholder="e.g., 2500">
                                </div>
                            </div>
                            <button onclick="addNewInventoryItem()" class="btn-primary" style="margin-top: 1rem;">&#10003; Save Item</button>
                        </div>
                    ` : ''}

                   <div class="form-group" style="margin-bottom: 2rem; position: relative;">
  <label class="form-label">Search for a Test or Service</label>

  <input
    type="text"
    id="inventorySearch"
    class="form-input"
    placeholder="Type to search..."
    autocomplete="off"
    value="${appState.inventorySearchQuery || ''}"
    oninput="appState.inventorySearchQuery = this.value; renderInventorySuggestions(this.value);">

  <!-- Auto-complete dropdown -->
  <div id="inventorySuggestions" class="autocomplete-box"></div>
</div>



                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Category</th>
                                    <th style="text-align: right;">Price</th>
                                    ${appState.currentUser.role === 'Admin' ? '<th>Actions</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${(() => {
                                    const groups = filteredInventory.reduce((acc, s) => {
                                        if (!acc[s.category]) acc[s.category] = [];
                                        acc[s.category].push(s);
                                        return acc;
                                    }, {});

                                    return Object.keys(groups).map(cat => `
                                        <tr>
                                            <td colspan="${appState.currentUser.role === 'Admin' ? 4 : 3}" style="background: var(--background); font-weight:700;">${cat}</td>
                                        </tr>
                                        ${groups[cat].map(item => {
                                            if (appState.editingInventoryId === item.id) {
                                                return ` 
                                                    <tr class="animate-fade-in">
                                                        <td><input type="text" id="editInventoryName-${item.id}" value="${item.name}" class="form-input"></td>
                                                        <td><input type="text" id="editInventoryCategory-${item.id}" value="${item.category}" class="form-input"></td>
                                                        <td style="text-align: right;"><input type="number" id="editInventoryPrice-${item.id}" value="${item.price ?? ''}" class="form-input"></td>
                                                        ${appState.currentUser.role === 'Admin' ? `<td style="white-space: nowrap; display: flex; gap: 0.5rem;">${renderActionButtons(`saveInventoryEdit(${item.id})`, `cancelEdit('inventory')`)}</td>` : ''}
                                                    </tr>
                                                `;
                                            }
                                            return `<tr id="inventory-item-${item.id}">
                                                <tr>
                                                    <td><strong>${item.name}</strong></td>
                                                    <td><span class="badge badge-primary">${item.category}</span></td>
                                                    <td style="font-weight: 700; color: var(--primary); text-align: right;">${formatCurrency(item.price)}</td>
                                                    ${appState.currentUser.role === 'Admin' ? `<td style="white-space: nowrap; display: flex; gap: 0.5rem;"><button onclick="toggleEdit('inventory', ${item.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">&#9998;&#65039; Edit</button><button onclick="deleteInventoryItem(${item.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; color: var(--error);">&#128465;&#65039; Delete</button></td>` : ''}
                                                </tr>
                                            `;
                                        }).join('')}
                                    `).join('');
                                })()}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        function renderPRManagement() {
            if (appState.currentUser.role !== 'Admin' && appState.currentUser.role !== 'Staff') {
                return `<div class="card"><p>Access Denied: You do not have permission to manage PR.</p></div>`;
            }

            return `
                <div style="max-width: 1200px; margin: 0 auto;" class="animate-slide-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 2rem; font-weight: 700;">PR Management</h2>
                        <button onclick="toggleAddPRForm()" class="btn-primary"> 
                            ${appState.showAddPRForm ? ' Cancel' : '+ Add New PR'}
                        </button>
                    </div>

                    <!-- Add New PR Form -->
                    ${appState.showAddPRForm ? `
                        <div class="card animate-fade-in" style="margin-bottom: 2rem;">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Add New Professional</h3>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">PR Name *</label>
                                    <input type="text" id="newPRName" class="form-input" placeholder="e.g., Dr. John Doe">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact Number (Optional)</label>
                                    <input type="tel" id="newPRPhone" class="form-input" placeholder="e.g., 0803 123 4567">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hospital (Optional)</label>
                                <input type="text" id="newPRHospital" class="form-input" placeholder="e.g., St. Mary's Hospital">
                            </div>
                            <button onclick="addNewPR()" class="btn-primary" style="margin-top: 1rem;">&#10003; Save Professional</button>
                        </div>
                    ` : ''}

                    <div class="card">
                        <!-- Search Bar -->
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                            <div style="flex:1;">
                                <div class="form-group" style="margin-bottom: 0; position: relative;">
                                    <label class="form-label">Search by PR Name or Phone</label>
                                    <input type="text" id="prSearch" class="form-input" placeholder="Type to search..." value="${appState.recordFilters.prManagementSearchQuery}" oninput="appState.recordFilters.prManagementSearchQuery = this.value; renderPRManagementSuggestions(this.value);" autocomplete="off">
                                    <div id="prManagementSuggestions" class="autocomplete-box"></div>
                                </div>
                            </div>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <button class="btn-secondary" onclick="toggleHospitalsPanel()">Hospitals</button>
                            </div>
                        </div>

                        ${appState.showHospitalsPanel ? `
                            <div id="hospitalsPanel" class="card animate-fade-in" style="margin-bottom: 1rem;">
                                ${(() => {
                                    const groups = getHospitals();
                                    if (!groups || groups.length === 0) return `<div style="color:var(--text-secondary);">No hospitals assigned yet.</div>`;
                                    return groups.map(h => `
                                        <div style="margin-bottom:0.75rem;">
                                            <div style="font-weight:700; margin-bottom:0.35rem;">${h.hospital}</div>
                                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">${h.prs.map(pr => `<button class="btn-secondary" onclick="selectPRFromHosp(${JSON.stringify(pr.name)})">${pr.name}</button>`).join('')}</div>
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        ` : ''}

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>PR Name</th>
                                    <th>Contact Phone</th>
                                    <th>Hospital</th>
                                    <th>Total Referrals</th>
                                    <th style="text-align: right;">Actions</th> 
                                </tr>
                            </thead>
                            <tbody>
                                ${(() => {
                                    const searchQuery = appState.recordFilters.prManagementSearchQuery.toLowerCase();
                                    const filteredPRs = prList.filter(pr => 
                                        pr.name.toLowerCase().includes(searchQuery) || 
                                        pr.phone.toLowerCase().includes(searchQuery));
                                    return filteredPRs.map(pr => {
                                    if (appState.editingPRId === pr.id) {
                                        return `
                                            <tr class="animate-fade-in">
                                                <td><input type="text" id="editPRName-${pr.id}" value="${pr.name}" class="form-input"></td>
                                                <td><input type="tel" id="editPRPhone-${pr.id}" value="${pr.phone}" class="form-input"></td>
                                                <td><input type="text" id="editPRHospital-${pr.id}" value="${pr.hospital || ''}" class="form-input"></td>
                                                <td colspan="2" style="text-align: right; white-space: nowrap; display: flex; gap: 0.5rem; justify-content: flex-end;">
                                                    ${renderActionButtons(`savePREdit(${pr.id})`, `cancelEdit('pr')`)}
                                                </td>
                                            </tr>
                                        `;
                                    }
                                    const referralCount = orders.filter(order => order.referredBy === pr.name).length;
                                    return `
                                        <tr id="pr-item-${pr.id}">
                                            <td><strong>${pr.name}</strong></td>
                                            <td>${pr.phone}</td>
                                            <td>${pr.hospital || ''}</td>
                                            <td style="font-weight: 700; color: var(--primary);">${referralCount}</td>
                                            <td style="text-align: right; white-space: nowrap; display: flex; gap: 0.5rem; justify-content: flex-end;"> 
                                                <button onclick="toggleEdit('pr', ${pr.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">&#9998;&#65039; Edit</button>
                                                <button onclick="deletePR(${pr.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; color: var(--error);">&#128465;&#65039; Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                    }).join('');
                                })()}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        function renderAnalytics() {
            if (appState.currentUser.role !== 'Admin' && appState.currentUser.role !== 'Staff') {
                return `<div class="card"><p>Access Denied: You do not have permission to view analytics.</p></div>`;
            }

            const stats = getOrderStats();
            const topTests = getFilteredTopTests();
            const filteredStats = getFilteredStats();
            const prPerformance = getFilteredPRPerformance();
            const paymentStats = getPaymentStats();
            const isAdmin = appState.currentUser.role === 'Admin';

            return `
                <div id="printable-area" style="display: none;">
                    <!-- This is a hidden container for the full printable report -->
                    <!-- The content will be dynamically generated by printReport() -->
                </div>

                <div style="max-width: 1400px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 2rem; font-weight: 700;">Analytics & Reports</h2>
                        <button onclick="printReport()" class="btn-primary">&#128424;&#65039; Print Report</button>
                    </div>

                    <!-- Date Range Filter for Analytics -->
                    <div class="card animate-slide-up" style="margin-bottom: 2rem;">
                        <h3 style="font-weight: 700; margin-bottom: 1rem;">Filter by Date Range</h3>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="analyticsStartDate" value="${appState.analyticsDateRange.start}" onchange="updateAnalyticsDateRange('start', this.value)">
                            </div>
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="analyticsEndDate" value="${appState.analyticsDateRange.end}" onchange="updateAnalyticsDateRange('end', this.value)">
                            </div>
                            <div class="filter-group">
                                <button onclick="resetAnalyticsDateRange()">Reset to Last 30 Days</button>
                            </div>
                        </div>
                    </div>

                    <div id="printable-area">
                    <!-- Key Financial Metrics (Visible on screen) -->
                    <div class="stat-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="stat-box animate-slide-up" style="border-left: 4px solid var(--success); animation-delay: 0s;">
                            <p class="stat-label">Total Income (Selected Period)</p>
                            <p class="stat-value" style="color: var(--success);">${formatCurrency(filteredStats.totalRevenue)}</p>
                            <p style="font-size: 0.75rem; color: var(--text-secondary);">${filteredStats.orderCount} orders in period</p>
                        </div>
                        <div class="stat-box animate-slide-up" style="border-left: 4px solid var(--accent); animation-delay: 0.1s;">
                            <p class="stat-label">Total Discounts (Selected Period)</p>
                            <p class="stat-value" style="color: var(--accent);">${formatCurrency(filteredStats.totalDiscounts)}</p>
                            <p style="font-size: 0.75rem; color: var(--text-secondary);">Value given to patients</p>
                        </div>
                        <div class="stat-box animate-slide-up" style="border-left: 4px solid var(--warning); animation-delay: 0.1s;">
                            <p class="stat-label">Outstanding Balance (All Time)</p>
                            <p class="stat-value" style="color: var(--warning);">${formatCurrency(stats.pendingBalance)}</p>
                            <p style="font-size: 0.75rem; color: var(--text-secondary);">Awaiting payment</p>
                        </div>
                        <div class="stat-box animate-slide-up" style="border-left: 4px solid var(--primary); animation-delay: 0.2s;">
                            <p class="stat-label">Total Revenue (All Time)</p>
                            <p class="stat-value">${formatCurrency(stats.totalRevenue)}</p>
                            <p style="font-size: 0.75rem; color: var(--text-secondary);">${stats.paidOrders} completed orders</p>
                        </div>
                        <div class="stat-box accent animate-slide-up" style="border-left: 4px solid var(--accent); animation-delay: 0.3s;">
                            <p class="stat-label">Average Order Value (All Time)</p>
                            <p class="stat-value">${formatCurrency(stats.totalOrders > 0 ? (stats.totalRevenue + stats.pendingBalance) / stats.totalOrders : 0)}</p>
                            <p style="font-size: 0.75rem; color: var(--text-secondary);">Per patient</p>
                        </div>
                    </div>

                    <!-- Payment Status Distribution -->
                    <div class="card animate-slide-up">
                        <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Payment Status Distribution</h3>
                        <div class="chart-container">
                            <div class="chart-item">
                                <div class="chart-label">Full Payments</div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar" style="width: ${paymentStats.fullPayment > 0 ? (paymentStats.fullPayment / (paymentStats.fullPayment + paymentStats.installment)) * 100 : 0}%;">
                                        ${paymentStats.fullPayment > 0 ? paymentStats.fullPayment : '0'}
                                    </div>
                                </div>
                            </div>
                            <div class="chart-item">
                                <div class="chart-label">Installment Payments</div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar" style="width: ${paymentStats.installment > 0 ? (paymentStats.installment / (paymentStats.fullPayment + paymentStats.installment)) * 100 : 0}%; background: linear-gradient(90deg, var(--warning) 0%, var(--accent) 100%);">
                                        ${paymentStats.installment > 0 ? paymentStats.installment : '0'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily PR Performance -->
                    <div class="card animate-slide-up" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 700; font-size: 1.25rem; margin: 0;">Top PR Agents by Referrals (Today)</h3>
                        </div>
                        <div class="responsive-table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr><th>PR Agent Name</th><th>Number of Referrals</th><th>Total Revenue</th></tr>
                                </thead>
                                <tbody>
                                    ${(() => {
                                        const todaysPerformance = getDailyPRPerformance(new Date()).slice(0, 5);
                                        if (todaysPerformance.length === 0) {
                                            return `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No PR referrals recorded for today yet.</td></tr>`;
                                        }
                                        return todaysPerformance.map(pr => `
                                            <tr>
                                                <td><strong>${pr.name}</strong></td>
                                                <td>${pr.orders}</td>
                                                <td>${formatCurrency(pr.revenue)}</td>
                                            </tr>
                                        `).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>
                        <button onclick="toggleFullDailyRecord()" class="btn-secondary" style="margin-top: 1.5rem;">
                            ${appState.showFullDailyRecord ? 'Hide Daily PR Report' : 'View Full Daily PR Report'}
                        </button>

                        ${appState.showFullDailyRecord ? `
                            <div class="animate-fade-in" style="border-top: 1px solid var(--border); margin-top: 1.5rem; padding-top: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="font-weight: 600; font-size: 1.125rem;">Full PR Referral Report for: ${appState.dailyRecordViewDate.toLocaleDateString('en-CA')}</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn-secondary" onclick="changeDailyRecordDate(-1)">&#8592; Previous Day</button>
                                        <button class="btn-secondary" onclick="changeDailyRecordDate(1)" ${new Date(appState.dailyRecordViewDate).setHours(0,0,0,0) >= new Date().setHours(0,0,0,0) ? 'disabled' : ''}>Next Day &#8594;</button>
                                    </div>
                                </div>
                                <div class="responsive-table-wrapper">
                                    <table class="table">
                                        <thead><tr><th>PR Agent Name</th><th>Number of Referrals</th><th>Total Revenue</th></tr></thead>
                                        <tbody>
                                            ${(() => {
                                                const dailyPerformance = getDailyPRPerformance(appState.dailyRecordViewDate);
                                                if (dailyPerformance.length === 0) return `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No PR referrals for this day.</td></tr>`;
                                                return dailyPerformance.map(pr => `
                                                    <tr>
                                                        <td><strong>${pr.name}</strong></td>
                                                        <td>${pr.orders}</td>
                                                        <td>${formatCurrency(pr.revenue)}</td>
                                                    </tr>
                                                `).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- PR Agent Commissions -->
                    <div class="card animate-slide-up" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 700; font-size: 1.25rem; margin: 0;">PR Agent Commissions (10%)</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="month" id="commissionMonth" class="form-input" style="height:34px; padding:4px;" title="Select month for monthly report">
                                <button class="btn-primary" onclick="printMonthlyCommissionReport()">&#128424;&#65039; Print Monthly</button>
                                <input type="number" id="commissionYear" class="form-input" placeholder="YYYY" style="width:100px; height:34px; padding:4px;" min="2000" max="2100" title="Enter year for yearly report">
                                <button class="btn-primary" onclick="printYearlyCommissionReport()">&#128424;&#65039; Print Yearly</button>
                                <button class="btn-primary" onclick="printCommissionReport()">&#128424;&#65039; Print Commissions</button>
                            </div>
                        </div>
                        <div class="responsive-table-wrapper">
                            <table class="table">
                                <thead><tr><th>Agent</th><th>Referrals</th><th>Total Revenue</th><th>Commission (10%)</th></tr></thead>
                                <tbody>
                                    ${(() => {
                                        const commissions = getFilteredPRCommissions().slice(0,5);
                                        if (commissions.length === 0) return `<tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No commissions in selected period.</td></tr>`;
                                        return commissions.map(c => `
                                            <tr>
                                                <td><strong>${c.name}</strong></td>
                                                <td>${c.orders}</td>
                                                <td>${formatCurrency(c.revenue)}</td>
                                                <td>${formatCurrency(c.commission)}</td>
                                            </tr>
                                        `).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>
                        <button onclick="toggleFullDailyCommissionReport()" class="btn-secondary" style="margin-top: 1.5rem;">
                            ${appState.showFullDailyCommissionReport ? 'Hide Daily Commission Report' : 'View Daily Commission Report'}
                        </button>

                        ${appState.showFullDailyCommissionReport ? `
                            <div class="animate-fade-in" style="border-top: 1px solid var(--border); margin-top: 1.5rem; padding-top: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="font-weight: 600; font-size: 1.125rem;">Daily Commission Report for: ${appState.dailyCommissionViewDate.toLocaleDateString('en-CA')}</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn-secondary" onclick="changeDailyCommissionDate(-1)">&#8592; Previous Day</button>
                                        <button class="btn-secondary" onclick="changeDailyCommissionDate(1)" ${new Date(appState.dailyCommissionViewDate).setHours(0,0,0,0) >= new Date().setHours(0,0,0,0) ? 'disabled' : ''}>Next Day &#8594;</button>
                                        <button class="btn-primary" onclick="printDailyCommissionReport()">&#128424;&#65039; Print Daily</button>
                                    </div>
                                </div>
                                <div class="responsive-table-wrapper">
                                    <table class="table">
                                        <thead><tr><th>Agent</th><th>Referrals</th><th>Total Revenue</th><th>Commission (10%)</th></tr></thead>
                                        <tbody>
                                            ${(()=> {
                                                const daily = getDailyPRCommissions(appState.dailyCommissionViewDate);
                                                if (daily.length === 0) return `<tr><td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No commissions for this day.</td></tr>`;
                                                return daily.map(c => `
                                                    <tr>
                                                        <td><strong>${c.name}</strong></td>
                                                        <td>${c.orders}</td>
                                                        <td>${formatCurrency(c.revenue)}</td>
                                                        <td>${formatCurrency(c.commission)}</td>
                                                    </tr>
                                                `).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Hospital Referral Performance -->
                    <div class="card animate-slide-up" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem;">
                            <div>
                                <h3 style="font-weight: 700; font-size: 1.25rem; margin: 0;">Hospital Referral Performance</h3>
                                <div style="font-size:0.9rem; color:var(--text-secondary);">Showing data for <strong id="hospitalMonthLabel">${formatMonthYearLabel(appState.hospitalPerformanceMonth || new Date())}</strong></div>
                            </div>

                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <button class="btn-secondary" onclick="changeHospitalPerformanceMonth(-1)">&#8592;</button>
                                <input id="hospitalMonthInput" type="month" value="${(appState.hospitalPerformanceMonth || new Date()).toISOString().slice(0,7)}" onchange="setHospitalPerformanceMonthFromInput(this.value)" style="padding:0.35rem; border-radius:0.25rem; border:1px solid var(--border); background:var(--surface);">
                                <button class="btn-secondary" onclick="changeHospitalPerformanceMonth(1)">&#8594;</button>
                            </div>
                        </div>

                        <div style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center;">
                            <button class="btn-secondary" onclick="exportHospitalMonthlyCSV()">Export CSV</button>
                            <button class="btn-secondary" onclick="printHospitalMonthlyReport()">Print</button>
                        </div>

                        <div class="responsive-table-wrapper" style="margin-top:1rem;">
                            <div style="max-height:420px; overflow-y:auto; padding-right:8px;">
                                <table class="table">
                                    <thead><tr><th style="width:40px;"></th><th>Hospital</th><th style="text-align:right;">Total Revenue</th></tr></thead>
                                    <tbody>
                                        ${(() => {
                                            const data = getHospitalMonthlyPerformance(appState.hospitalPerformanceMonth || new Date());
                                            if (data.length === 0) return `<tr><td colspan="3" style="text-align:center;color:var(--text-secondary);padding:1rem;">No hospital referrals for this period.</td></tr>`;
                                            return data.map(h => `
                                                <tr>
                                                    <td style="padding-left:0.25rem;"><button aria-label="Toggle details for ${h.hospital}" style="background:none;border:none;cursor:pointer;font-size:1rem;line-height:1;" onclick="toggleHospitalDetails(${JSON.stringify(h.hospital)})">${appState.showHospitalDetails && appState.showHospitalDetails[h.hospital] ? '' : ''}</button></td>
                                                    <td><strong>${h.hospital}</strong></td>
                                                    <td style="text-align:right; font-weight:700;">${formatCurrency(h.totalRevenue)}</td>
                                                </tr>
                                                ${appState.showHospitalDetails && appState.showHospitalDetails[h.hospital] ? `<tr><td colspan="3"><div style="padding:0.25rem 0.75rem 0.75rem 0.75rem;"><table class="table"><thead><tr><th>PR Agent</th><th>Referrals</th><th style="text-align:right;">Total Revenue</th></tr></thead><tbody>${h.prs.map(pr => `<tr><td>${pr.name}</td><td>${pr.orders}</td><td style="text-align:right;">${formatCurrency(pr.revenue)}</td></tr>`).join('')}</tbody></table></div></td></tr>` : ''}
                                            `).join('');
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Top Tests -->
                    <div class="card animate-slide-up" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 700; font-size: 1.25rem; margin: 0;">Top 5 Most Ordered Tests (Today)</h3>
                        </div>
                        <div class="responsive-table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr><th>Test Name</th><th>Times Ordered</th></tr>
                                </thead>
                                <tbody>
                                    ${(() => {
                                        const todaysTopTests = getDailyTopTests(new Date()).slice(0, 5);
                                        if (todaysTopTests.length === 0) {
                                            return `<tr><td colspan="2" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No tests recorded for today yet.</td></tr>`;
                                        }
                                        return todaysTopTests.map(test => `
                                            <tr>
                                                <td><strong>${test.name}</strong></td>
                                                <td>${test.count}</td>
                                            </tr>
                                        `).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>
                        <button onclick="toggleFullDailyTestRecord()" class="btn-secondary" style="margin-top: 1.5rem;">
                            ${appState.showFullDailyTestRecord ? 'Hide Full Daily Test Record' : 'View Full Daily Test Record'}
                        </button>

                        ${appState.showFullDailyTestRecord ? `
                            <div class="animate-fade-in" style="border-top: 1px solid var(--border); margin-top: 1.5rem; padding-top: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="font-weight: 600; font-size: 1.125rem;">Full Test Record for: ${appState.dailyTestRecordViewDate.toLocaleDateString('en-CA')}</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn-secondary" onclick="changeDailyTestRecordDate(-1)">&#8592; Previous Day</button>
                                        <button class="btn-secondary" onclick="changeDailyTestRecordDate(1)" ${new Date(appState.dailyTestRecordViewDate).setHours(0,0,0,0) >= new Date().setHours(0,0,0,0) ? 'disabled' : ''}>Next Day &#8594;</button>
                                    </div>
                                </div>
                                <div class="responsive-table-wrapper">
                                    <table class="table">
                                        <thead><tr><th>Test Name</th><th>Times Ordered</th></tr></thead>
                                        <tbody>
                                            ${(() => {
                                                const dailyTests = getDailyTopTests(appState.dailyTestRecordViewDate);
                                                if (dailyTests.length === 0) return `<tr><td colspan="2" style="text-align: center; color: var(--text-secondary); padding: 1rem;">No tests recorded for this day.</td></tr>`;
                                                return dailyTests.map(test => `<tr><td><strong>${test.name}</strong></td><td>${test.count}</td></tr>`).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    </div>

                    <!-- Data Export -->
                    <div class="card animate-slide-up" style="margin-top: 2rem;">
                        <h3 style="font-weight: 700; margin-bottom: 1rem;">Data Export</h3>
                        <button onclick="exportData()" class="btn-primary ${!isAdmin ? 'disabled' : ''}" ${!isAdmin ? 'disabled' : ''}>
                            &#128229; One-Click Data Export (CSV)
                        </button>
                        ${!isAdmin ? '<p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Only admins can export data</p>' : ''}
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        async function loadDraft(index) {
            const draft = appState.drafts[index];
            if (!draft) return;

            const confirmed = await showConfirm(`This will replace any current billing information. Continue with draft for "${draft.patientName}"?`);
            if (!confirmed) {
                return; // User cancelled
            }

            // Deep copy and normalize the draft data to avoid missing fields or invalid types
            const raw = JSON.parse(JSON.stringify(draft));
            appState.billingData = ensureBillingDataShape(raw);
            appState.billingStep = draft.billingStep || 1;
            appState.currentView = 'billing';

            // Close any open modals/overlays that might remain set and block the UI
            appState.viewingOrderId = null;
            appState.editingPRId = null;
            appState.editingInventoryId = null;
            appState.showAddPRForm = false;
            appState.showAddInventoryForm = false;
            
            // Remove the draft from the list now that it's loaded
            appState.drafts.splice(index, 1);
            autoSave();
            renderApp();

            // Give the UI a moment to mount then ensure billing UI is interactive and up-to-date
            setTimeout(() => {
                try {
                    updateBillingCalculations();
                    const patientNameInput = document.getElementById('patientName');
                    if (patientNameInput) patientNameInput.focus();
                    // recovery after loading draft
                    const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                    if (disabledEls.length > 0) {
                        console.warn('Post-draft-load check: found disabled elements, attempting recoverUI');
                        recoverUI();
                        clearAllEventListeners();
                        try { renderApp(); } catch(e) { console.error(e); }
                    }
                } catch (e) {
                    console.warn('Error while finalizing draft load:', e);
                }
            }, 60);
        }

        function deleteDraft(index) {
            const draft = appState.drafts[index];
            if (!draft) return;

            showConfirm(`Are you sure you want to delete the draft for "${draft.patientName}"? This action cannot be undone.`).then(confirmed => {
                if (!confirmed) return;
                const deletedDraftName = draft.patientName;
                appState.drafts.splice(index, 1);
                logAction('DELETE_DRAFT', `Deleted draft for '${deletedDraftName}'.`);
                autoSave();
                renderApp();
            });
        }

        function renderStaffManagement() {
            if (appState.currentUser.role !== 'Admin') {
                return `<div class="card"><p>Access Denied: Only admins can manage staff.</p></div>`;
            }

            // Get all staff (excluding current admin)
            const staffList = users.filter(u => u.username !== appState.currentUser.username);

            return `
                <div style="max-width: 1200px; margin: 0 auto;" class="animate-slide-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 2rem; font-weight: 700;">Staff Management</h2>
                        <button onclick="toggleAddStaffForm()" class="btn-primary">
                            ${appState.showAddStaffForm ? ' Cancel' : '+ Add New Staff'}
                        </button>
                    </div>

                    <!-- Add New Staff Form -->
                    ${appState.showAddStaffForm ? `
                        <div class="card animate-fade-in" style="margin-bottom: 2rem;">
                            <h3 style="font-weight: 700; margin-bottom: 1.5rem; font-size: 1.25rem;">Add New Staff Member</h3>
                            <div class="grid-3">
                                <div class="form-group">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" id="newStaffFullName" class="form-input" placeholder="e.g., Jane Doe">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Username *</label>
                                    <input type="text" id="newStaffUsername" class="form-input" placeholder="e.g., janedoe">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password *</label>
                                    <div style="position: relative; display: flex; align-items: center;">
                                        <input type="password" id="newStaffPassword" class="form-input" placeholder="Minimum 6 characters" style="padding-right: 2.5rem;">
                                        <button type="button" data-toggle-for="newStaffPassword" onclick="togglePasswordVisibility('newStaffPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="addNewStaff()" class="btn-primary" style="margin-top: 1rem;">&#10003; Save Staff</button>
                        </div>
                    ` : ''}

                    <div class="card">
                        <h3 style="font-weight: 700; margin-bottom: 1.5rem;">Current Users</h3>
                        ${staffList.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <p>No staff members added yet. Click "+ Add New Staff" to create one.</p>
                            </div>
                        ` : `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Full Name</th>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${staffList.map(user => `
                                        <tr>
                                            <td><strong>${user.fullName}</strong></td>
                                            <td>${user.username}</td>
                                            <td><span class="badge badge-primary">${user.role}</span></td>
                                            <td>
                                                <button onclick="deleteStaff('${user.username}')" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; color: var(--error);">&#128465;&#65039; Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
        }

        function renderAdvancedFilter() {
            const filters = appState.recordFilters;
            return `
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Filter By</label>
                        <select class="form-select" onchange="updateFilterType(this.value)">
                            <option value="all" ${filters.filterType === 'all' ? 'selected' : ''}>Daily View</option>
                            <option value="date" ${filters.filterType === 'date' ? 'selected' : ''}>Specific Date</option>
                            <option value="month" ${filters.filterType === 'month' ? 'selected' : ''}>Month</option>
                            <option value="year" ${filters.filterType === 'year' ? 'selected' : ''}>Year</option>
                        </select>
                    </div>

                    ${filters.filterType === 'date' ? `
                        <div class="filter-group">
                            <label>Date</label>
                            <input type="date" class="form-input" value="${filters.date}" onchange="updateFilter('date', this.value)">
                        </div>
                    ` : ''}

                    ${filters.filterType === 'month' ? `
                        <div class="filter-group">
                            <label>Month</label>
                            <input type="month" class="form-input" value="${filters.month}" onchange="updateFilter('month', this.value)">
                        </div>
                    ` : ''}

                    ${filters.filterType === 'year' ? `
                        <div class="filter-group">
                            <label>Year</label>
                            <input type="number" class="form-input" placeholder="YYYY" value="${filters.year}" onchange="updateFilter('year', this.value)">
                        </div>
                    ` : ''}

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
                    </div>
                </div>
            `;
        }


        function renderRecords() {
            const filteredRecords = getFilteredRecords();
            
            return `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Patient Records</h2>

                    <!-- Daily Record Navigation and Search -->
                    <div class="card animate-slide-up" style="margin-bottom: 2rem;">
                        ${renderAdvancedFilter()}
                    </div>
                    <div class="card animate-slide-up" style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <h3 style="font-weight: 700; font-size: 1.25rem;" class="${appState.recordFilters.searchAllRecords ? 'disabled-text' : ''}">
                                ${appState.recordFilters.searchAllRecords ? 'Showing All Records' : `Records for: ${appState.recordsViewDate.toLocaleDateString('en-CA')}`}
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.8rem; margin-bottom: 0.25rem;">Go to Date</label>
                                    <input type="date" class="form-input" onchange="setRecordsDate(this.value)" value="${appState.recordsViewDate.toISOString().split('T')[0]}" ${appState.recordFilters.searchAllRecords ? 'disabled' : ''}>
                                </div>
                                <button class="btn-secondary" onclick="changeRecordsDate(-1)" ${appState.recordFilters.searchAllRecords ? 'disabled' : ''} style="align-self: flex-end;">&#8592; Previous Day</button>
                                ${(() => {
                                    const today = new Date().setHours(0, 0, 0, 0);
                                    const viewDate = new Date(appState.recordsViewDate).setHours(0, 0, 0, 0);
                                    if (viewDate < today && !appState.recordFilters.searchAllRecords) {
                                        return `<button class="btn-primary" onclick="navigateToCurrentDayRecords()">Back to Current Day</button>`;
                                    }
                                    return '';
                                })()}
                            </div>
                        </div>
                        <div style="border-top: 1px solid var(--border); margin-top: 1.5rem; padding-top: 1.5rem;">
                            <div style="display: flex; gap: 1.5rem; align-items: center;">
                                <div class="form-group" style="flex: 1; margin-bottom: 0; position: relative;">
                                    <label class="form-label">Search by Patient Name or PID</label>
                                    <input type="text" id="searchQuery" class="form-input" placeholder="Type to search..." value="${appState.recordFilters.searchQuery}" oninput="appState.recordFilters.searchQuery = this.value; renderRecordsSuggestions(this.value);" autocomplete="off">
                                    <div id="recordsSuggestions" class="autocomplete-box"></div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5rem; padding-top: 1.5rem;">
                                    <input type="checkbox" id="searchAllRecords" onchange="updateFilter('searchAllRecords', this.checked)" ${appState.recordFilters.searchAllRecords ? 'checked' : ''} style="width: 1.25rem; height: 1.25rem;">
                                    <label for="searchAllRecords" style="margin-bottom: 0;">
                                        Search All Records
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card animate-fade-in">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-weight: 700; margin: 0;">
                                Daily Log (${filteredRecords.length} record${filteredRecords.length !== 1 ? 's' : ''})
                            </h3>
                            <button onclick="printDailyRecords()" class="btn-primary" ${filteredRecords.length === 0 || appState.recordFilters.searchAllRecords ? 'disabled' : ''} title="${appState.recordFilters.searchAllRecords ? 'Printing is only available for single-day views.' : ''}">
                                &#128424;&#65039; Print Daily Record
                            </button>
                        </div>
                        <div class="responsive-table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Patient Name</th>
                                        <th>PID</th>
                                        <th>Services</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Referred By</th>
                                        <th>Staff Name</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredRecords.length > 0 ? filteredRecords.map(order => `
                                        <tr id="record-item-${order.id}">
                                            <td><a href="#" onclick="viewOrderDetails(${order.id})" style="color: var(--primary); text-decoration: underline; font-weight: 500;">${order.patientName}</a></td>
                                            <td><strong>${order.pid}</strong></td>
                                            <td style="font-size: 0.85rem;">${order.services.map(s => (typeof s === 'string') ? s : (s && s.name ? s.name : '')).join(', ')}</td>
                                            <td>${formatCurrency(order.total)}</td>
                                            <td><span class="badge ${order.status === 'PAID' ? 'badge-success' : 'badge-warning'}">${order.status}</span></td>
                                            <td style="font-size: 0.9rem;">${order.referredBy}</td>
                                            <td style="font-weight: 500;">${order.staffName}</td>
                                            <td>${order.date.toISOString().split('T')[0]}</td>
                                            <td>${order.time || 'N/A'}</td>
                                            <td><span class="badge ${order.paymentStatus === 'full' ? 'badge-full' : 'badge-installment'}">${order.paymentStatus === 'full' ? 'Full' : 'Installment'}</span></td>
                                            <td><button onclick="reprintReceiptById(${order.id})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">&#128424;&#65039; Print</button></td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="11" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No records found for the selected filter.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        function renderOrderDetailsModal() {
            if (appState.viewingOrderId === null && !appState.modal) return '';

            // If a generic modal is present, render it here (ensures it overlays above everything)
            if (appState.modal) {
                const m = appState.modal;
                if (m.type === 'navConfirm' || m.type === 'cancelBilling') {
                    const title = m.title || 'Confirm';
                    const message = m.message || '';
                    return `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000;">
                            <div class="card animate-pop" style="width: 90%; max-width: 520px;">
                                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 1rem;">
                                    <h3 style="font-size: 1.25rem; font-weight:700;">${escapeHtml(title)}</h3>
                                    <button onclick="handleNavConfirmCancel()" style="background:none; border:none; font-size:1.25rem; cursor:pointer;">&times;</button>
                                </div>
                                <div style="margin-bottom: 1rem; color:var(--text-secondary);">${escapeHtml(message)}</div>
                                <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top: 1rem;">
                                    <button class="btn-primary" onclick="handleNavConfirmSave()">Save Draft & Continue</button>
                                    <button class="btn-secondary" onclick="handleNavConfirmDiscard()">Discard & Continue</button>
                                    <button class="btn-secondary" onclick="handleNavConfirmCancel()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            const order = orders.find(o => o.id === appState.viewingOrderId);
            if (!order) return '';

            const hasOutstandingPayment = order.paymentStatus === 'installment' && order.balance > 0;

            return `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                    <div class="card animate-pop" style="width: 90%; max-width: 650px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.5rem; font-weight: 700;">Record Details: ${order.pid}</h3>
                            <button onclick="closeOrderDetails()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1;">&times;</button> 
                        </div>

                        <div class="grid-2" style="gap: 1rem; margin-bottom: 1.5rem; background-color: var(--background); padding: 1rem; border-radius: 0.5rem;">
                            <div><strong>Patient:</strong> ${order.patientName}</div>
                            <div><strong>PID:</strong> ${order.pid}</div>
                            <div><strong>Date:</strong> ${order.date.toISOString().split('T')[0]} at ${order.time || 'N/A'}</div>
                            <div><strong>Referred By:</strong> ${order.referredBy}</div>
                            <div><strong>Processed By:</strong> ${order.staffName}</div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Services Rendered</h4>
                            <ul style="list-style: disc; padding-left: 1.5rem;">
                                ${order.services.map(s => `<li>${(typeof s === 'string') ? s : (s && s.name ? s.name : 'Unnamed')}</li>`).join('')}
                            </ul>
                        </div>

                        <div>
                            <h4 style="font-weight: 600; margin-bottom: 1rem;">Payment Summary</h4>
                            <div style="background-color: var(--background); padding: 1rem; border-radius: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span>Total Bill:</span> <strong>${formatCurrency(order.total)}</strong></div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span>Payment Method:</span> <span>${order.paymentMethod}</span></div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span>Amount Paid:</span> <span>${formatCurrency(order.amountPaid)}</span></div>
                                <div style="display: flex; justify-content: space-between; color: ${order.balance > 0 ? 'var(--error)' : 'var(--success)'};"><span>Balance:</span> <strong>${formatCurrency(order.balance)}</strong></div>
                            </div>
                        </div>

                        ${hasOutstandingPayment ? `
                            <button onclick="markAsFullyPaid(${order.id})" class="btn-primary" style="margin-top: 2rem; width: 100%; background-color: var(--success);">&#10003; Mark as Fully Paid & Print Receipt</button>
                        ` : ''}

                        <button onclick="closeOrderDetails()" class="btn-secondary" style="margin-top: 1rem; width: 100%;">Close</button>
                    </div>
                </div>
            `;
        }
        
        async function saveCategoryRename(oldName, event) {
            const newNameInput = document.getElementById(`edit-category-input-${oldName}`);
            if (!newNameInput) return;

            const newName = newNameInput.value.trim();
            if (!newName) {
                showModal('Category name cannot be empty.', 'warning');
                return;
            }

            if (newName === oldName) {
                // No change, just cancel the edit
                appState.editingCategoryName = null;
                renderApp();
                return;
            }

            // Check if the new category name already exists
            const allCategories = [...new Set(inventory.map(item => item.category))];
            const existingCategory = allCategories.find(cat => cat.toLowerCase() === newName.toLowerCase());

            if (existingCategory && existingCategory.toLowerCase() !== oldName.toLowerCase()) {
                // The new name matches another existing category. Ask to merge.
                const mergeConfirmed = await showConfirm(`The category "${newName}" already exists. Do you want to merge all items from "${oldName}" into "${newName}"? This action cannot be undone.`);
                if (!mergeConfirmed) {
                    // User cancelled the merge operation.
                    return;
                }
                // If confirmed, the logic will proceed to rename, effectively merging the categories.
            } else if (existingCategory && existingCategory.toLowerCase() === oldName.toLowerCase() && existingCategory !== newName) {
                // This handles case changes, e.g., renaming "lab" to "LAB". No confirmation needed.
            } else if (existingCategory) {
                // This case should not be hit if logic is correct, but as a safeguard:
                showModal(`The category "${newName}" already exists. Please choose a unique name or an existing one to merge.`, 'warning');
                return;
            }

            // Proceed with renaming
            inventory.forEach(item => {
                if (item.category === oldName) {
                    item.category = newName;
                }
            });

            logAction('RENAME_CATEGORY', `Renamed/Merged category from '${oldName}' to '${newName}'. This affected all associated tests.`);
            autoSave();

            // Exit editing mode and re-render
            appState.editingCategoryName = null;
            renderApp();
            showModal(`Category '${oldName}' has been successfully renamed/merged into '${newName}'.`, 'success');
        }

        function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Please fill in all password fields.');
                return;
            }

            const currentUserObject = users.find(u => u.username === appState.currentUser.username);

            if (!currentUserObject || currentUserObject.password !== currentPassword) {
                alert('Your current password is incorrect.');
                return;
            }

            if (newPassword.length < 6) {
                alert('Your new password must be at least 6 characters long.');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('The new passwords do not match. Please try again.');
                return;
            }

            // Update the password
            currentUserObject.password = newPassword;
            autoSave();

            logAction('CHANGE_PASSWORD', `User '${currentUserObject.fullName}' changed their password.`);

            alert('Password changed successfully. You will now be logged out for security reasons.');
            logout();
        }

        function renderSettings() {
            const colorThemes = [
                { name: 'Blue', id: 'blue', colors: ['#0e4a7c', '#14b8a6'] },
                { name: 'Skyblue', id: 'skyblue', colors: ['#0369a1', '#06b6d4'] },
                { name: 'Gray', id: 'gray', colors: ['#374151', '#6b7280'] },
                { name: 'Brown', id: 'brown', colors: ['#92400e', '#a16207'] },
                { name: 'Green', id: 'green', colors: ['#166534', '#059669'] },
                { name: 'Purple', id: 'purple', colors: ['#6b21a8', '#9333ea'] }
            ];

            const categoryManagementSection = () => {
                const allCategories = [...new Set(inventory.map(item => item.category))].sort();

                return `
                    <div class="settings-card">
                        <div class="settings-card-title">Category Management</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">Rename test categories across the application. This change will update all tests under the specified category.</p>
                        <div class="responsive-table-wrapper">
                            <table class="table">
                                <thead><tr><th>Category Name</th><th style="text-align: right;">Actions</th></tr></thead>
                                <tbody>
                                    ${allCategories.map(cat => {
                                        if (appState.editingCategoryName === cat) {
                                            return `
                                                <tr class="animate-fade-in">
                                                    <td><input type="text" id="edit-category-input-${cat}" class="form-input" value="${cat}" oninput="event.stopPropagation()"></td>
                                                    <td style="text-align: right; white-space: nowrap; display: flex; gap: 0.5rem; justify-content: flex-end;">
                                                        <button onclick="saveCategoryRename('${cat}', event)" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"> Save</button>
                                                        <button onclick="appState.editingCategoryName = null; renderApp();" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;"> Cancel</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }
                                        return `
                                            <tr>
                                                <td><strong>${cat}</strong></td>
                                                <td style="text-align: right;">
                                                    <button onclick="appState.editingCategoryName = '${cat}'; renderApp();" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">&#9998;&#65039; Rename</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };
            const isAdmin = appState.currentUser.role === 'Admin';

            const companyProfileSection = `
                <div class="settings-card">
                    <div class="settings-card-title">Company Profile</div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">Manage your company's information. This will be reflected on receipts and the login page.</p>
                    
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" id="companyName" class="form-input" value="${appState.companyProfile.name}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <input type="text" id="companyContact" class="form-input" value="${appState.companyProfile.contact}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" id="companyAddress" class="form-input" value="${appState.companyProfile.address}">
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="companyEmail" class="form-input" value="${appState.companyProfile.email}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo (URL or Emoji)</label>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                ${appState.companyProfile.logo.startsWith('data:image') ? `<img src="${appState.companyProfile.logo}" alt="Current Logo" style="height: 40px; width: 40px; border-radius: 0.25rem; object-fit: cover; background: var(--background);">` : `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--background); border-radius: 0.25rem;"></div>`}
                                <input type="file" id="companyLogoUpload" class="form-input" accept="image/png, image/jpeg, image/gif" onchange="handleLogoUpload(event)"> 
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.5rem; display: block;">Select a new logo to automatically update it. The change is saved immediately.</small>
                        </div>
                    </div>
                    <button onclick="saveCompanyProfile()" class="btn-primary" style="margin-top: 1rem;">Save Profile</button>
                </div>
            `;

            // The logo input is now a file type and handled separately
            // We remove it from the saveCompanyProfile function

            return `
                <div class="animate-slide-up">
                    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem; color: var(--text-primary);">Settings</h1>
                    
                    <div class="settings-card">
                        <div class="settings-card-title">Theme Mode</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Choose between light and dark mode for your preferred viewing experience</p>
                        <div class="mode-toggle">
                            <button class="mode-toggle-btn ${appState.theme === 'light' ? 'active' : ''}" onclick="toggleTheme('light')">
                                &#9728;&#65039; Light Mode
                            </button>
                            <button class="mode-toggle-btn ${appState.theme === 'dark' ? 'active' : ''}" onclick="toggleTheme('dark')">
                                &#127769; Dark Mode
                            </button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-title">Color Theme</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Select your preferred color palette for the application</p>
                        <div class="settings-grid">
                            ${colorThemes.map(theme => `
                                <div class="theme-option ${appState.colorTheme === theme.id ? 'active' : ''}" onclick="changeColorTheme('${theme.id}')">
                                    <div class="theme-preview">
                                        <div style="flex: 1; background-color: ${theme.colors[0]};"></div>
                                        <div style="flex: 1; background-color: ${theme.colors[1]};"></div>
                                    </div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${theme.name}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-title">Change Password</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">Update your account password. You will be logged out after a successful change for security.</p>
                        
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <div style="position: relative; display: flex; align-items: center;">
                                <input type="password" id="currentPassword" class="form-input" placeholder="Enter your current password" style="padding-right: 2.5rem;">
                                <button type="button" data-toggle-for="currentPassword" onclick="togglePasswordVisibility('currentPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                            </div>
                        </div>
                        <div class="grid-2" style="margin-bottom: 1rem;">
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <div style="position: relative; display: flex; align-items: center;">
                                    <input type="password" id="newPassword" class="form-input" placeholder="Minimum 6 characters" style="padding-right: 2.5rem;">
                                    <button type="button" data-toggle-for="newPassword" onclick="togglePasswordVisibility('newPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <div style="position: relative; display: flex; align-items: center;">
                                    <input type="password" id="confirmNewPassword" class="form-input" placeholder="Re-enter new password" style="padding-right: 2.5rem;">
                                    <button type="button" data-toggle-for="confirmNewPassword" onclick="togglePasswordVisibility('confirmNewPassword')" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--text-secondary);">&#128065;</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="handleChangePassword()" class="btn-primary">Update Password</button>
                    </div>

                    ${isAdmin ? companyProfileSection : ''}

                    ${isAdmin ? categoryManagementSection() : ''}

                    <div class="settings-card">
                        <div class="settings-card-title">About & Data Management</div>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Application:</strong> Silhouette Diagnostic Consultants</p>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Version:</strong> 2.0</p>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;"><strong>Status:</strong> Active and Running</p>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;"><strong>DEVELOPER:</strong> Stanley Akegbeotu</p>

                        ${isAdmin ? `
                            <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                                <h4 style="font-weight: 600; margin-bottom: 1rem;">Data Backup & Restore</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Create a backup of all application data or restore from a previous backup file.</p>
                                <div style="display: flex; gap: 1rem;">
                                    <button onclick="handleBackup()" class="btn-primary">&#128228; Create Backup</button>
                                    <button onclick="handleRestore()" class="btn-secondary" style="color: var(--error);">&#128229; Restore from Backup</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderDrafts() {
            return `
                <div style="max-width: 1200px; margin: 0 auto;" class="animate-slide-up">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 2rem; font-weight: 700;">Saved Drafts</h2>
                        <p style="color: var(--text-secondary);">Continue a billing process you started earlier.</p>
                    </div>

                    <div class="card">
                        ${appState.drafts.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <p>You have no saved drafts.</p>
                                <p style="font-size: 0.9rem;">Drafts are automatically created when you fill out the billing form and navigate away or close the app.</p>
                            </div>
                        ` : `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Patient Name</th>
                                        <th>Patient ID</th>
                                        <th>Last Saved</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appState.drafts.map((draft, index) => `
                                        <tr>
                                            <td><strong>${draft.patientName}</strong></td>
                                            <td>${draft.pid}</td>
                                            <td>${new Date(draft.lastSaved).toLocaleString()}</td>
                                            <td style="display: flex; gap: 0.5rem;">
                                                <button onclick="loadDraft(${index})" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">&#9998;&#65039; Continue</button>
                                                <button onclick="deleteDraft(${index})" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; color: var(--error);">&#128465;&#65039; Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        function renderHistoryFilters() {
            const filters = appState.historyFilters;
            const uniqueUsers = [...new Set(auditLog.map(log => log.user))];
            const uniqueActions = [...new Set(auditLog.map(log => log.action))];

            return `
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Filter by User</label>
                        <select class="form-select" onchange="updateHistoryFilter('user', this.value)">
                            <option value="">All Users</option>
                            ${uniqueUsers.map(user => `<option value="${user}" ${filters.user === user ? 'selected' : ''}>${user}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filter by Action</label>
                        <select class="form-select" onchange="updateHistoryFilter('action', this.value)">
                            <option value="">All Actions</option>
                            ${uniqueActions.map(action => `<option value="${action}" ${filters.action === action ? 'selected' : ''}>${action.replace(/_/g, ' ')}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" class="form-input" value="${filters.startDate}" onchange="updateHistoryFilter('startDate', this.value)">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" class="form-input" value="${filters.endDate}" onchange="updateHistoryFilter('endDate', this.value)">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button onclick="clearHistoryFilters()" class="btn-secondary">Clear Filters</button>
                    </div>
                </div>
            `;
        }



        function renderHistory() {
            if (appState.currentUser.role !== 'Admin') {
                return `<div class="card"><p>Access Denied: Only admins can view the history log.</p></div>`;
            }

            const searchQuery = (appState.historySearchQuery || '').toLowerCase();
            const filters = appState.historyFilters;
            const filteredLog = auditLog.filter(log => {
                // Date filtering
                const logDate = new Date(log.timestamp);
                const startDate = filters.startDate ? new Date(filters.startDate) : null;
                const endDate = filters.endDate ? new Date(filters.endDate) : null;
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);

                const matchesUserFilter = !filters.user || (log.user === filters.user);
                const matchesActionFilter = !filters.action || (log.action === filters.action);
                const matchesDateRange = (!startDate || logDate >= startDate) && (!endDate || logDate <= endDate);

                if (searchQuery) {
                    const userMatch = (log.user || '').toLowerCase().includes(searchQuery);
                    const actionMatch = (log.action || '').toLowerCase().replace(/_/g, ' ').includes(searchQuery);
                    // If search query is present, it must match user or action AND other filters must also match
                    return (userMatch || actionMatch) && matchesUserFilter && matchesActionFilter && matchesDateRange;
                }

                // If no search query, rely only on the explicit filters
                return matchesUserFilter && matchesActionFilter && matchesDateRange;
            });

            
            function resetHistorySearch() {
                appState.historySearchQuery = '';
                renderApp();
            }

            return `
                <div style="max-width: 1400px; margin: 0 auto;" class="animate-slide-up">
                    <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">Application History Log</h2>

                    <div class="card"> 
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <p style="color: var(--text-secondary); margin: 0;">This log shows all significant changes made within the application. It is read-only.</p>
                            ${filteredLog.length > 10 ? `<span class="badge badge-primary">Page ${appState.analytics.historyPage + 1} of ${Math.ceil(filteredLog.length / 10)}</span>` : ''}
                        </div>

                        <div class="filter-section" style="padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                            <div class="filter-group" style="flex: 2; position: relative;">
                                <label>Search by User or Action</label>
                                <input type="text" id="historySearch" placeholder="e.g., John Doe or CREATE_BILLING" value="${appState.historySearchQuery}" oninput="appState.historySearchQuery = this.value; renderHistorySuggestions(this.value); appState.analytics.historyPage = 0;" autocomplete="off">
                                <div id="historySuggestions" class="autocomplete-box"></div>
                            </div>
                            <button class="btn-secondary" onclick="appState.historySearchQuery = ''; renderApp();">Clear</button>
                        </div>
                        ${renderHistoryFilters()}
                        <div class="responsive-table-wrapper">
                            <table class="table">

                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(() => {
                                        const page = appState.analytics.historyPage;
                                        const itemsPerPage = 10;
                                        const paginatedItems = filteredLog.slice(page * itemsPerPage, (page + 1) * itemsPerPage);

                                        if (paginatedItems.length === 0) {
                                            return `
                                                <tr>
                                                    <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No history records found.</td>
                                                </tr>
                                            `;
                                        }

                                        return paginatedItems.map(log => `
                                            <tr id="history-item-${log.id}">
                                                <td style="white-space: nowrap; font-size: 0.85rem;">${log.timestamp instanceof Date ? log.timestamp.toLocaleString() : 'Invalid Date'}</td>
                                                <td><strong>${log.user}</strong></td>
                                                <td><span class="badge ${log.role === 'Admin' ? 'badge-error' : 'badge-primary'}">${log.role}</span></td>
                                                <td style="font-weight: 500;">${log.action.replace('_', ' ')}</td>
                                                <td style="font-size: 0.9rem; word-break: break-word;">${log.details}</td>
                                            </tr>
                                        `).join('');
                                    })()}
                                </tbody>
                            </table>
                        </div>
                        ${filteredLog.length > 10 ? `
                            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn-secondary" onclick="changeHistoryPage(-1, ${filteredLog.length})" ${appState.analytics.historyPage === 0 ? 'disabled' : ''}>&larr; Previous</button>
                                <button class="btn-secondary" onclick="changeHistoryPage(1, ${filteredLog.length})" ${appState.analytics.historyPage >= Math.ceil(filteredLog.length / 10) - 1 ? 'disabled' : ''}>Next &rarr;</button>
                            </div>
                        ` : `
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No history records found.</td>
                                        </tr>
                                    `}
                                </tbody>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button onclick="navigateTo('dashboard')" class="btn-secondary">Back to Dashboard</button>
                    </div>
                </div>
            `;
        }

        // ====== EVENT HANDLERS ======
        function toggleTheme(mode) {
            appState.theme = mode;
            applyTheme();
            renderApp();
        }

        function changeColorTheme(theme) {
            appState.colorTheme = theme;
            applyTheme();
            renderApp();
        }

        // Remove event listeners by replacing elements with clones (used as a cleanup step before re-attaching)
        function clearAllEventListeners() {
            // Do not remove listeners from active modal dialogs
            const activeModal = document.querySelector('[data-silhouette-modal]');
            document.querySelectorAll('input, button, select, textarea, a, div, span').forEach(el => {
                try {
                    // Skip nodes that are part of an active modal (so confirm buttons remain clickable)
                    if (activeModal && (el === activeModal || el.closest('[data-silhouette-modal]'))) return;
                    // Also skip body and html
                    if (el === document.body || el === document.documentElement) return;
                    const clone = el.cloneNode(true);
                    if (el.parentNode) el.parentNode.replaceChild(clone, el);
                } catch (e) {
                    // ignore cloning errors for certain nodes
                }
            });
        }

        // Detect and remove any full-screen blocking overlays (e.g., invisible divs) that might capture pointer events
        function detectAndRemoveBlockingOverlays() {
            const candidates = Array.from(document.body.querySelectorAll('*')).filter(el => {
                try {
                    const s = window.getComputedStyle(el);
                    const rect = el.getBoundingClientRect();
                    const coversViewport = rect.width >= window.innerWidth - 2 && rect.height >= window.innerHeight - 2 && rect.top <= 0 && rect.left <= 0;
                    const visible = s.display !== 'none' && s.visibility !== 'hidden' && parseFloat(s.opacity || '1') > 0;
                    const captures = s.pointerEvents !== 'none';
                    return (s.position === 'fixed' || s.position === 'absolute') && coversViewport && visible && captures;
                } catch (e) {
                    return false;
                }
            });
            if (candidates.length) {
                candidates.forEach(el => {
                    console.warn('Removing blocking overlay:', el);
                    el.remove();
                });
                return true;
            }
            return false;
        }

        // Defensive UI recovery: remove overlays and re-enable inputs
        function recoverUI() {
            // Remove unexpected modal-like overlays but do not remove active app modals (data-silhouette-modal)
            document.querySelectorAll('.modal-backdrop, .modal, .backdrop').forEach(el => {
                if (!el.closest('[data-silhouette-modal]')) {
                    console.info('recoverUI: removing overlay', el);
                    el.remove();
                }
            });
            // Remove any blocking overlays we didn't expect
            detectAndRemoveBlockingOverlays();
            // Re-enable all inputs/buttons
            document.querySelectorAll('input, button, select, textarea').forEach(el => {
                try { el.disabled = false; el.readOnly = false; } catch(e) {}
            });
            // Ensure body can receive pointer events
            try { document.body.style.pointerEvents = ''; } catch(e) {}
            // Re-attach event listeners
            try { attachEventListeners(); } catch(e) {}
        }

        function attachEventListeners() {
            try {
                // Service selection checkboxes
                document.querySelectorAll('.service-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // if user toggles a classic checkbox, sync to appState.selectedServices
                        const id = this.dataset.id;
                        if (this.checked) addServiceById(id);
                        else removeServiceById(id);
                        updateBillingCalculations();
                    });
                });

                // Discount input
                document.getElementById('discount')?.addEventListener('input', updateBillingCalculations);

                // Service item click: toggle checkbox unless click target is an input (checkbox or override price)
                document.querySelectorAll('.service-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        const target = e.target;
                        if (target && (target.closest('.override-price') || target.closest('.service-checkbox') || target.tagName === 'INPUT')) {
                            // let the input handle the event
                            return;
                        }
                        const checkbox = this.querySelector('.service-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            updateBillingCalculations();
                        }
                    });
                });

                // Override price inputs (shown in VIP mode)
                document.querySelectorAll('.override-price').forEach(input => {
                    input.addEventListener('input', function() {
                        const id = this.dataset.id;
                        const val = parseFloat(this.value);
                        const svc = (appState.billingData && appState.billingData.selectedServices) && appState.billingData.selectedServices.find(x => String(x.id) === String(id));
                        if (svc) {
                            svc.overridePrice = !isNaN(val) && val >= 0 ? val : null;
                        }
                        updateBillingCalculations();
                    });
                });

                // PR agent search input
                const referredByInput = document.getElementById('referredBySearch');
                if (referredByInput) {
                    referredByInput.oninput = function() {
                        renderPRSuggestions(this.value);
                    };
                    referredByInput.addEventListener('focus', function() {
                        // Show suggestions on focus
                        renderPRSuggestions(this.value);
                    });
                    referredByInput.addEventListener('blur', function() {
                        // Hide suggestions after a short delay (to allow click)
                        setTimeout(() => {
                            const prDiv = document.getElementById('prSuggestions');
                            if (prDiv) prDiv.style.display = 'none';
                        }, 200);
                    });
                }

                // Also wire the referring hospital input so changes are reflected in appState immediately
                const referringHospitalInput = document.getElementById('referringHospital');
                if (referringHospitalInput) {
                    referringHospitalInput.addEventListener('input', function() { appState.billingData.referringHospital = this.value; });
                    referringHospitalInput.addEventListener('focus', function() { /* no-op, kept for parity */ });

                    // When the user leaves the hospital input, if a PR agent is selected and the agent has no assigned hospital,
                    // offer to assign the entered hospital to the PR without clearing other billing inputs.
                    referringHospitalInput.addEventListener('blur', async function() {
                        const hospital = this.value ? this.value.trim() : '';
                        appState.billingData.referringHospital = hospital;
                        const prName = appState.billingData.referredBy && appState.billingData.referredBy.trim() ? appState.billingData.referredBy.trim() : '';
                        if (!prName || !hospital) return;
                        const pr = prList.find(p => p.name === prName);
                        if (!pr) return;
                        if (!pr.hospital) {
                            const confirmAssign = await showConfirm(`No hospital is assigned to PR '${prName}'. Assign '${hospital}' to this PR agent?`);
                            if (confirmAssign) {
                                pr.hospital = hospital;
                                logAction('ASSIGN_PR_HOSPITAL', `Assigned PR '${prName}' to hospital '${hospital}' via billing form.`);
                                await showModal(`Assigned hospital '${hospital}' to PR '${prName}'.`, 'success');
                            }
                        }
                    });
                }

                // PR suggestions click handler (delegated)
                const prSuggestionsDiv = document.getElementById('prSuggestions');
                if (prSuggestionsDiv) {
                    prSuggestionsDiv.addEventListener('click', function(e) {
                        const item = e.target.closest('.pr-suggestion-item');
                        if (!item) return;
                        const name = item.dataset.name;
                        const phone = item.dataset.phone;
                        selectPRAgent(name, phone);
                    });
                }

                // Login/setup inputs: force lowercase on input and pasted text for username/password
                // This improves UX by showing the conversion live and prevents case mismatches during auth
                const loginU = document.getElementById('loginUsername');
                const loginP = document.getElementById('loginPassword');
                const setupU = document.getElementById('setupUsername');
                const setupP = document.getElementById('setupPassword');
                const setupPC = document.getElementById('setupPasswordConfirm');

                function attachLowercaseHandler(el) {
                    if (!el) return;
                    // live-lowercase while preserving caret position
                    el.addEventListener('input', function () {
                        const pos = this.selectionStart;
                        this.value = (this.value || '').toLowerCase();
                        try { this.setSelectionRange(pos, pos); } catch (e) { /* ignore */ }
                    });
                    // paste: insert lowercased paste content
                    el.addEventListener('paste', function (e) {
                        e.preventDefault();
                        const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
                        const lower = pasted.toLowerCase();
                        const start = this.selectionStart || 0;
                        const end = this.selectionEnd || 0;
                        const val = this.value || '';
                        this.value = val.slice(0, start) + lower + val.slice(end);
                        const pos = start + lower.length;
                        try { this.setSelectionRange(pos, pos); } catch (e) { /* ignore */ }
                    });
                }

                attachLowercaseHandler(loginU);
                attachLowercaseHandler(loginP);
                attachLowercaseHandler(setupU);
                attachLowercaseHandler(setupP);
                attachLowercaseHandler(setupPC);

                // Service search input - attach handlers here so they persist across re-renders
                const svcInput = document.getElementById('serviceSearch');
                if (svcInput) {
                    svcInput.oninput = function() { renderServiceSuggestions(this.value); };
                    svcInput.addEventListener('focus', function() { renderServiceSuggestions(this.value); });
                    svcInput.addEventListener('mousedown', function() { renderServiceSuggestions(this.value || ''); });
                    svcInput.addEventListener('blur', function() { setTimeout(() => { const box = document.getElementById('serviceSuggestions'); if (box) { box.style.display = 'none'; box.setAttribute('aria-expanded','false'); } }, 200); });
                    svcInput.addEventListener('keydown', function(e) {
                        const items = Array.from(document.querySelectorAll('#serviceSuggestions .suggestion-item'));
                        if (e.key === 'ArrowDown') { e.preventDefault(); if (items.length > 0) items[0].focus(); }
                        else if (e.key === 'ArrowUp') { e.preventDefault(); if (items.length > 0) items[items.length - 1].focus(); }
                        else if (e.key === 'Escape') { const box = document.getElementById('serviceSuggestions'); if (box) box.style.display = 'none'; }
                        else if (e.key === 'Enter') {
                            const focused = document.activeElement && document.activeElement.closest && document.activeElement.closest('.suggestion-item');
                            if (focused) { focused.click(); e.preventDefault(); }
                            else { const first = document.querySelector('#serviceSuggestions .suggestion-item'); if (first) { first.click(); e.preventDefault(); } }
                        }
                    });

                    // suggestion click handler is set elsewhere (delegated), ensure suggestion box is keyboard-friendly
                    const svcBox = document.getElementById('serviceSuggestions');
                    if (svcBox) {
                        svcBox.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                const focused = document.activeElement && document.activeElement.closest && document.activeElement.closest('.suggestion-item');
                                if (focused) { focused.click(); e.preventDefault(); }
                            }
                        });
                    }
                }

                // Add new PR agent button
                const addPRBtn = document.getElementById('addNewPRBtn');
                if (addPRBtn) {
                    addPRBtn.addEventListener('click', addNewPRAgent);
                }

                // Inventory search input
                const inventorySearchInput = document.getElementById('inventorySearch');
                if (inventorySearchInput) {
                    // Use a small debounce to avoid heavy work while user is typing, for a smooth experience
                    inventorySearchInput.addEventListener('input', function() {
                        // keep app state in sync immediately
                        appState.inventorySearchQuery = this.value;

                        // debounced suggestion render
                        clearTimeout(inventorySuggestTimeout);
                        inventorySuggestTimeout = setTimeout(() => {
                            renderInventorySuggestions(this.value);
                        }, 120); // 120ms debounce
                    });

                    inventorySearchInput.addEventListener('focus', function() {
                        // show suggestions immediately on focus for current value
                        renderInventorySuggestions(this.value);
                    });

                    inventorySearchInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const first = document.querySelector('#inventorySuggestions .autocomplete-item');
                            if (first) first.click();
                        }
                        // Arrow navigation (basic)
                        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                            const items = Array.from(document.querySelectorAll('#inventorySuggestions .autocomplete-item'));
                            if (items.length === 0) return;
                            e.preventDefault();
                            // find current focused index
                            const active = document.activeElement;
                            const activeItem = active && active.classList && active.classList.contains('autocomplete-item') ? active : null;
                            let currentIndex = activeItem ? items.indexOf(activeItem) : -1;
                            if (e.key === 'ArrowDown') currentIndex = Math.min(items.length - 1, currentIndex + 1);
                            if (e.key === 'ArrowUp') currentIndex = Math.max(0, currentIndex - 1);
                            const toFocus = items[currentIndex];
                            if (toFocus) toFocus.focus();
                        }
                    });

                    inventorySearchInput.addEventListener('blur', function() {
                        setTimeout(() => {
                            const suggestionsDiv = document.getElementById('inventorySuggestions');
                            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
                        }, 200);
                    });
                }

                // Inventory suggestions click handler (delegated)
                const invSug = document.getElementById('inventorySuggestions');
                if (invSug) {
                    invSug.onclick = function(e) {
                        const item = e.target.closest('.autocomplete-item');
                        if (!item) return;
                        const id = item.dataset.id;
                        const name = item.dataset.name || item.textContent.trim();
                        if (!id) return;
                        selectInventoryItemById(id, name);
                    };
                }

                // PR Management: attach handlers for search suggestions (replace handlers each render)
                const prMgmtInput = document.getElementById('prSearch');
                const prSugDiv = document.getElementById('prManagementSuggestions');
                if (prMgmtInput) {
                    prMgmtInput.onkeydown = function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const first = document.querySelector('#prManagementSuggestions .autocomplete-item');
                            if (first) first.click();
                        }
                    };
                    prMgmtInput.onfocus = function() { renderPRManagementSuggestions(this.value); };
                    prMgmtInput.onblur = function() { setTimeout(() => { if (prSugDiv) prSugDiv.style.display = 'none'; }, 200); };
                }
                if (prSugDiv) {
                    prSugDiv.onclick = function(e) {
                        const item = e.target.closest('.autocomplete-item');
                        if (!item) return;
                        const id = item.dataset.id;
                        const name = item.dataset.name || item.textContent.trim();
                        if (!id) return;
                        selectPRManagementById(id, name);
                    };
                }

                // Records search input handlers (replace per-render to avoid duplicates)
                const recInput = document.getElementById('searchQuery');
                const recSugDiv = document.getElementById('recordsSuggestions');
                if (recInput) {
                    recInput.onkeydown = function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const first = document.querySelector('#recordsSuggestions .autocomplete-item');
                            if (first) first.click();
                        }
                        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                            const items = Array.from(document.querySelectorAll('#recordsSuggestions .autocomplete-item'));
                            if (items.length === 0) return;
                            e.preventDefault();
                            const active = document.activeElement;
                            const activeItem = active && active.classList && active.classList.contains('autocomplete-item') ? active : null;
                            let currentIndex = activeItem ? items.indexOf(activeItem) : -1;
                            if (e.key === 'ArrowDown') currentIndex = Math.min(items.length - 1, currentIndex + 1);
                            if (e.key === 'ArrowUp') currentIndex = Math.max(0, currentIndex - 1);
                            const toFocus = items[currentIndex];
                            if (toFocus) toFocus.focus();
                        }
                    };
                    recInput.onfocus = function() { renderRecordsSuggestions(this.value); };
                    recInput.onblur = function() { setTimeout(() => { if (recSugDiv) recSugDiv.style.display = 'none'; }, 200); };
                    // Keep app state in sync but do not renderApp on each keystroke
                    recInput.oninput = function() { appState.recordFilters.searchQuery = this.value; renderRecordsSuggestions(this.value); };
                }
                if (recSugDiv) {
                    recSugDiv.onclick = function(e) {
                        const item = e.target.closest('.autocomplete-item');
                        if (!item) return;
                        const id = item.dataset.id;
                        const pid = item.dataset.pid || item.textContent.trim();
                        if (!id) return;
                        selectRecordById(id, pid);
                    };
                }

                // History search input handlers (replace per-render to avoid duplicates)
                const histInput = document.getElementById('historySearch');
                const histSugDiv = document.getElementById('historySuggestions');
                if (histInput) {
                    histInput.onkeydown = function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const first = document.querySelector('#historySuggestions .autocomplete-item');
                            if (first) first.click();
                        }
                        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                            const items = Array.from(document.querySelectorAll('#historySuggestions .autocomplete-item'));
                            if (items.length === 0) return;
                            e.preventDefault();
                            const active = document.activeElement;
                            const activeItem = active && active.classList && active.classList.contains('autocomplete-item') ? active : null;
                            let currentIndex = activeItem ? items.indexOf(activeItem) : -1;
                            if (e.key === 'ArrowDown') currentIndex = Math.min(items.length - 1, currentIndex + 1);
                            if (e.key === 'ArrowUp') currentIndex = Math.max(0, currentIndex - 1);
                            const toFocus = items[currentIndex];
                            if (toFocus) toFocus.focus();
                        }
                    };
                    histInput.onfocus = function() { renderHistorySuggestions(this.value); };
                    histInput.onblur = function() { setTimeout(() => { if (histSugDiv) histSugDiv.style.display = 'none'; }, 200); };
                    // Keep app state in sync but do not renderApp on each keystroke
                    histInput.oninput = function() { appState.historySearchQuery = this.value; renderHistorySuggestions(this.value); };
                }
                if (histSugDiv) {
                    histSugDiv.onclick = function(e) {
                        const item = e.target.closest('.autocomplete-item');
                        if (!item) return;
                        const id = item.dataset.id;
                        const label = item.dataset.label || item.textContent.trim();
                        if (!id) return;
                        selectHistoryById(id, label);
                    };
                }

                // Hide inventory suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    const invBox = document.getElementById('inventorySuggestions');
                    const invInput = document.getElementById('inventorySearch');
                    if (!invBox || !invInput) return;
                    if (!invBox.contains(e.target) && !invInput.contains(e.target)) {
                        invBox.style.display = 'none';
                    }

                    // Hide service suggestions when clicking outside
                    const svcBox = document.getElementById('serviceSuggestions');
                    const svcInput = document.getElementById('serviceSearch');
                    if (svcBox && svcInput && !svcBox.contains(e.target) && !svcInput.contains(e.target)) {
                        svcBox.style.display = 'none'; svcBox.setAttribute('aria-expanded','false');
                    }

                    // DOCUMENT-LEVEL FALLBACK: handle direct pointer clicks on suggestion items even if container handlers are missing
                    const svcItem = e.target.closest && e.target.closest('.suggestion-item');
                    if (svcItem && svcBox && svcBox.contains(svcItem)) {
                        // If it's a service suggestion with a data-id, add immediately
                        const id = svcItem.getAttribute && svcItem.getAttribute('data-id');
                        const cat = svcItem.getAttribute && svcItem.getAttribute('data-category');
                        if (id) {
                            try { addServiceById(id); } catch (err) { console.error('Fallback addServiceById error:', err); }
                            svcBox.style.display = 'none'; svcBox.setAttribute('aria-expanded','false');
                            const input = document.getElementById('serviceSearch'); if (input) { input.value = ''; input.focus(); }
                        } else if (cat) {
                            // expand category view
                            renderServiceSuggestions(cat, { expandCategory: true });
                        }
                    }

                    // Ensure we also catch pointerdown before blur hides the suggestions (attach once)
                    if (!window._svcPointerDownAttached) {
                        window._svcPointerDownAttached = true;
                        document.addEventListener('pointerdown', function(ev) {
                            const box = document.getElementById('serviceSuggestions');
                            const item = ev.target && ev.target.closest && ev.target.closest('.suggestion-item');
                            if (!item || !box || !box.contains(item)) return;
                            // If it's a suggestion item, handle selection immediately and prevent input blur race
                            ev.preventDefault(); ev.stopPropagation();
                            const id = item.getAttribute && item.getAttribute('data-id');
                            const cat = item.getAttribute && item.getAttribute('data-category');
                            if (id) {
                                try { addServiceById(id); } catch (err) { console.error('Pointerdown addServiceById error:', err); }
                                box.style.display = 'none'; box.setAttribute('aria-expanded','false');
                                const input = document.getElementById('serviceSearch'); if (input) { input.value = ''; input.focus(); }
                            } else if (cat) {
                                renderServiceSuggestions(cat, { expandCategory: true });
                            }
                        }, { passive: false });
                    }
                });

                // Service search input
                const searchInput = document.getElementById('serviceSearch');
                if (searchInput) {
                    // Show suggestions on focus, input and when clicked (mousedown)
                    searchInput.addEventListener('input', function() {
                        renderServiceSuggestions(this.value);
                    });
                    searchInput.addEventListener('focus', function() {
                        renderServiceSuggestions(this.value);
                    });
                    // Show immediately on mousedown (covers click-before-focus scenarios)
                    searchInput.addEventListener('mousedown', function(e) {
                        renderServiceSuggestions(this.value || '');
                    });
                    searchInput.addEventListener('blur', function() {
                        // Small delay to allow click selection
                        setTimeout(() => { const box = document.getElementById('serviceSuggestions'); if (box) { box.style.display = 'none'; box.setAttribute('aria-expanded','false'); } }, 200);
                    });

                    // Keyboard navigation: ArrowDown/ArrowUp to focus suggestions, Escape to close
                    searchInput.addEventListener('keydown', function(e) {
                        const items = document.querySelectorAll('#serviceSuggestions .suggestion-item');
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (items.length > 0) items[0].focus();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (items.length > 0) items[items.length - 1].focus();
                        } else if (e.key === 'Escape') {
                            const box = document.getElementById('serviceSuggestions'); if (box) box.style.display = 'none';
                        } else if (e.key === 'Enter') {
                            // If there's a focused suggestion, trigger it; otherwise pick first
                            const focused = document.activeElement && document.activeElement.closest && document.activeElement.closest('.suggestion-item');
                            if (focused) { focused.click(); e.preventDefault(); }
                            else {
                                const first = document.querySelector('#serviceSuggestions .suggestion-item');
                                if (first) { first.click(); e.preventDefault(); }
                            }
                        }
                    });

                    // Allow Enter on focused suggestion items
                    const svcBox = document.getElementById('serviceSuggestions');
                    if (svcBox) {
                        svcBox.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                const focused = document.activeElement && document.activeElement.closest && document.activeElement.closest('.suggestion-item');
                                if (focused) { focused.click(); e.preventDefault(); }
                            }
                        });
                    }
                }

                // Suggestion click handler (delegated) - ensures service is added on click
                const suggestionsContainer = document.getElementById('serviceSuggestions');
                if (suggestionsContainer) {
                    // Remove any previous listeners
                    suggestionsContainer.replaceWith(suggestionsContainer.cloneNode(true));
                    const freshContainer = document.getElementById('serviceSuggestions');
                    
                    freshContainer.addEventListener('click', function(e) {
                        const btn = e.target.closest('.suggestion-item');
                        if (!btn) return;

                        // Debug logging to help trace click selection
                        console.debug('serviceSuggestions click target:', btn, 'text:', btn.textContent);

                        e.stopPropagation();
                        e.preventDefault();

                        const id = btn.getAttribute('data-id');
                        const cat = btn.getAttribute('data-category');
                        console.debug('suggestion clicked id:', id, 'category:', cat);

                        if (id) {
                            // Add service immediately
                            try {
                                addServiceById(id);
                                console.debug('addServiceById invoked for id:', id);
                            } catch (err) {
                                console.error('Error calling addServiceById:', err);
                            }

                            // Close the dropdown
                            const suggestionsBox = document.getElementById('serviceSuggestions');
                            if (suggestionsBox) {
                                suggestionsBox.style.display = 'none';
                                suggestionsBox.setAttribute('aria-expanded', 'false');
                            }

                            // Clear input and refocus
                            const input = document.getElementById('serviceSearch');
                            if (input) {
                                input.value = '';
                                input.focus();
                            }
                        } else if (cat) {
                            // category click: expand category list
                            renderServiceSuggestions(cat, {expandCategory: true});
                        }
                    });

                    // Immediate selection on pointerdown (handles blur-before-click cases)
                    freshContainer.addEventListener('pointerdown', function(e) {
                        const btn = e.target.closest('.suggestion-item');
                        if (!btn) return;
                        e.preventDefault();
                        e.stopPropagation();
                        const id = btn.getAttribute('data-id');
                        const cat = btn.getAttribute('data-category');
                        if (id) {
                            try { addServiceById(id); } catch (err) { console.error('Error calling addServiceById (pointerdown):', err); }
                            const suggestionsBox = document.getElementById('serviceSuggestions');
                            if (suggestionsBox) { suggestionsBox.style.display = 'none'; suggestionsBox.setAttribute('aria-expanded', 'false'); }
                            const input = document.getElementById('serviceSearch');
                            if (input) { input.value = ''; input.focus(); }
                        } else if (cat) {
                            renderServiceSuggestions(cat, {expandCategory: true});
                        }
                    });

                    // Ensure pointerdown handler is attached early (so the very first click selects suggestions reliably)
                    if (!window._svcPointerDownAttached) {
                        window._svcPointerDownAttached = true;
                        document.addEventListener('pointerdown', function(ev) {
                            const box = document.getElementById('serviceSuggestions');
                            const item = ev.target && ev.target.closest && ev.target.closest('.suggestion-item');
                            if (!item || !box || !box.contains(item)) return;
                            // If it's a suggestion item, handle selection immediately and prevent input blur race
                            ev.preventDefault(); ev.stopPropagation();
                            const id = item.getAttribute && item.getAttribute('data-id');
                            const cat = item.getAttribute && item.getAttribute('data-category');
                            if (id) {
                                try { addServiceById(id); } catch (err) { console.error('Pointerdown addServiceById error:', err); }
                                box.style.display = 'none'; box.setAttribute('aria-expanded','false');
                                const input = document.getElementById('serviceSearch'); if (input) { input.value = ''; input.focus(); }
                            } else if (cat) {
                                renderServiceSuggestions(cat, { expandCategory: true });
                            }
                        }, { passive: false });
                    }
                }

                // Selected services remove (delegated)
                document.getElementById('selectedServicesList')?.addEventListener('click', function(e) {
                    const rem = e.target.closest('.remove-selected');
                    if (!rem) return;
                    const id = rem.dataset.id;
                    removeServiceById(id);
                    renderApp();
                });

                // VIP override input change (delegated)
                document.getElementById('selectedServicesList')?.addEventListener('change', function(e) {
                    const inp = e.target.closest('.vip-override-input');
                    if (!inp) return;
                    const id = inp.dataset.id;
                    const newPrice = inp.value ? parseFloat(inp.value) : null;
                    const services = appState.billingData.selectedServices || [];
                    const service = services.find(s => String(s.id) === String(id));
                    if (service) {
                        service.overridePrice = (newPrice != null && !isNaN(newPrice)) ? newPrice : null;
                        updateBillingCalculations();
                    }
                });

                // Call updateBillingCalculations to populate the preview panel on initial render
                updateBillingCalculations();
            } catch (e) {
                console.error('attachEventListeners failed:', e);
            }
        }

        // --- Helper functions for PR agent search/add ---
        function renderPRSuggestions(query) {
            const suggestionsDiv = document.getElementById('prSuggestions');
            const addBtn = document.getElementById('addPRAgentContainer');
            if (!suggestionsDiv) return;

            const lowerQuery = (query || '').toLowerCase().trim();
            const matches = prList.filter(pr => pr.name.toLowerCase().includes(lowerQuery));

            if (lowerQuery && matches.length === 0) {
                // No matches and user typed something: show "add new" option
                suggestionsDiv.innerHTML = `
                    <div style="padding:0.5rem; color:var(--text-secondary); font-size:0.9rem;">
                        No results for "${query}"
                    </div>
                `;
                addBtn.style.display = 'block';
                suggestionsDiv.style.display = 'block';
            } else if (matches.length > 0) {
                // Show matched suggestions
                suggestionsDiv.innerHTML = matches.map(pr => `
                    <div class="pr-suggestion-item" data-name="${pr.name}" data-phone="${pr.phone}" style="padding:0.5rem; border-bottom:1px solid var(--border); cursor:pointer;">
                        <div style="font-weight:500;">${pr.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">${pr.phone}</div>
                    </div>
                `).join('');
                addBtn.style.display = 'none';
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
                addBtn.style.display = 'none';
            }
        }

        function selectPRAgent(name, phone) {
            const input = document.getElementById('referredBySearch');
            if (input) input.value = name;
            appState.billingData.referredBy = name;

            // Capture hospital input if provided and assign it to the PR
            const hospInput = document.getElementById('referringHospital');
            const hospital = hospInput && hospInput.value ? hospInput.value.trim() : '';

            let pr = prList.find(p => p.name === name);
            if (pr) {
                if (hospital) {
                    // User provided a hospital on the billing form: use it and assign to PR
                    pr.hospital = hospital;
                    appState.billingData.referringHospital = hospital;
                } else if (pr.hospital) {
                    // Autofill the hospital field from the PR's assigned hospital
                    if (hospInput) hospInput.value = pr.hospital;
                    appState.billingData.referringHospital = pr.hospital;
                    logAction('AUTO_FILL_PR_HOSPITAL', `Auto-filled hospital for PR '${name}' to '${pr.hospital}'.`);
                } else {
                    // No hospital assigned to this PR: focus hospital input so user can assign directly
                    if (hospInput) {
                        try { hospInput.focus(); } catch (e) {}
                        showToast('No hospital assigned to this agent  type a hospital name to assign it.', 'info', 2400);
                    }
                }
            } else {
                // No existing PR found: if the billing form had a hospital, use it; otherwise new PR will be unassigned
                if (hospital) {
                    appState.billingData.referringHospital = hospital;
                }
                const newId = prList.length > 0 ? Math.max(...prList.map(p => p.id)) + 1 : 1;
                prList.push({ id: newId, name: name, phone: phone || 'N/A', hospital: hospital });
                logAction('CREATE_PR', `Added new PR: '${name}' (auto-created from billing) and assigned to hospital '${hospital || 'Unassigned'}'.`);
            }

            if (hospital) logAction('ASSIGN_PR_HOSPITAL', `Assigned PR '${name}' to hospital '${hospital}'.`);

            document.getElementById('prSuggestions').style.display = 'none';
            document.getElementById('addPRAgentContainer').style.display = 'none';
        }

        // PR Management suggestions (non-billing page)
        let prMgmtSuggestTimeout = null;
        function renderPRManagementSuggestions(query) {
            const suggestionsDiv = document.getElementById('prManagementSuggestions');
            if (!suggestionsDiv) return;

            clearTimeout(prMgmtSuggestTimeout);
            prMgmtSuggestTimeout = setTimeout(() => {
                const q = (query || '').toLowerCase().trim();
                if (!q) { suggestionsDiv.style.display = 'none'; return; }

                const matches = prList.filter(pr => pr.name.toLowerCase().includes(q) || (pr.phone || '').toLowerCase().includes(q)).slice(0, 8);
                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = `<div class="autocomplete-item" style="color:var(--text-secondary);">No results for "${query}"</div>`;
                    suggestionsDiv.style.display = 'block';
                    return;
                }

                suggestionsDiv.innerHTML = matches.map(m => `
                    <div class="autocomplete-item" tabindex="0" data-id="${m.id}" data-name="${m.name}">
                        <div style="font-weight:500;">${m.name}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary);">${m.phone || 'N/A'}</div>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            }, 120);
        }

        function selectPRManagementById(id, name) {
            const input = document.getElementById('prSearch');
            const suggestionsDiv = document.getElementById('prManagementSuggestions');
            if (input) input.value = name;
            appState.recordFilters.prManagementSearchQuery = name;
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
            renderApp();

            // Scroll to the PR row after render
            setTimeout(() => {
                const row = document.getElementById('pr-item-' + id);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const prevBg = row.style.background;
                    row.style.background = 'rgba(255, 235, 59, 0.15)';
                    setTimeout(() => { row.style.background = prevBg; }, 2000);
                }
            }, 120);
        }

        // Toggle Hospitals panel in PR Management
        function toggleHospitalsPanel() {
            appState.showHospitalsPanel = !appState.showHospitalsPanel;
            renderApp();
        }

        // Return hospitals grouped with PRs
        function getHospitals() {
            const map = {};
            prList.forEach(pr => {
                const h = pr.hospital && pr.hospital.trim() ? pr.hospital.trim() : 'Unassigned';
                if (!map[h]) map[h] = [];
                map[h].push(pr);
            });
            return Object.keys(map).sort().map(h => ({ hospital: h, prs: map[h] }));
        }

        // Select PR by name from the Hospitals panel
        function selectPRFromHosp(name) {
            const pr = prList.find(p => p.name === name);
            if (pr) {
                selectPRManagementById(pr.id, pr.name);
            } else {
                const input = document.getElementById('prSearch');
                if (input) { input.value = name; appState.recordFilters.prManagementSearchQuery = name; renderPRManagementSuggestions(name); }
            }
        }

        // Toggle hospital details in analytics
        function toggleHospitalDetails(hospital) {
            appState.showHospitalDetails = appState.showHospitalDetails || {};
            appState.showHospitalDetails[hospital] = !appState.showHospitalDetails[hospital];
            renderApp();
        }

        // Compute hospital performance for the analytics date range
        function getHospitalPerformance() {
            const { start, end } = appState.analyticsDateRange;
            const startDate = new Date(start);
            const endDate = new Date(end);

            const map = {};
            orders.filter(o => {
                const d = new Date(o.date);
                return d >= startDate && d <= endDate;
            }).forEach(o => {
                const h = (o.referredHospital && o.referredHospital.trim()) || 'Unassigned';
                if (!map[h]) map[h] = { totalRevenue: 0, orders: 0, prs: {} };
                map[h].totalRevenue += o.total || 0;
                map[h].orders += 1;
                const pr = o.referredBy || 'Unknown';
                if (!map[h].prs[pr]) map[h].prs[pr] = { revenue: 0, orders: 0 };
                map[h].prs[pr].revenue += o.total || 0;
                map[h].prs[pr].orders += 1;
            });

            return Object.keys(map).map(h => ({
                hospital: h,
                totalRevenue: map[h].totalRevenue,
                orders: map[h].orders,
                prs: Object.keys(map[h].prs).map(name => ({ name, revenue: map[h].prs[name].revenue, orders: map[h].prs[name].orders }))
            })).sort((a, b) => b.totalRevenue - a.totalRevenue);
        }

        function formatMonthYearLabel(d) {
            const date = d ? new Date(d) : new Date();
            const opts = { year: 'numeric', month: 'long' };
            return date.toLocaleDateString(undefined, opts);
        }

        function changeHospitalPerformanceMonth(delta) {
            const d = appState.hospitalPerformanceMonth ? new Date(appState.hospitalPerformanceMonth) : new Date();
            d.setMonth(d.getMonth() + delta);
            appState.hospitalPerformanceMonth = d;
            renderApp();
        }

        function setHospitalPerformanceMonthFromInput(value) {
            if (!value) return;
            const d = new Date(value + '-01');
            if (isNaN(d.getTime())) return;
            appState.hospitalPerformanceMonth = d;
            renderApp();
        }

        // Export hospital monthly report as CSV
        function exportHospitalMonthlyCSV() {
            const data = getHospitalMonthlyPerformance(appState.hospitalPerformanceMonth || new Date());
            const monthLabel = formatMonthYearLabel(appState.hospitalPerformanceMonth || new Date());
            const rows = [];
            rows.push(['Report', 'Hospital Monthly Report']);
            rows.push(['Month', monthLabel]);
            rows.push([]);
            rows.push(['Hospital', 'Hospital Total Revenue', 'PR Agent', 'PR Referrals', 'PR Revenue']);

            data.forEach(h => {
                // Hospital summary row
                rows.push([h.hospital, h.totalRevenue.toFixed(2), '', '', '']);
                // PR detail rows
                if (h.prs && h.prs.length > 0) {
                    h.prs.forEach(pr => {
                        rows.push(['', '', pr.name, pr.orders, pr.revenue.toFixed(2)]);
                    });
                }
            });

            const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hospital-report-${(appState.hospitalPerformanceMonth || new Date()).toISOString().slice(0,7)}.csv`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { try { URL.revokeObjectURL(url); a.remove(); } catch (e) {} }, 5000);
        }

        // Print a simplified hospital monthly report
        function printHospitalMonthlyReport() {
            const data = getHospitalMonthlyPerformance(appState.hospitalPerformanceMonth || new Date());
            const monthLabel = formatMonthYearLabel(appState.hospitalPerformanceMonth || new Date());
            const win = window.open('', '_blank', 'width=900,height=700');
            if (!win) { showModal('Could not open print window. Please allow pop-ups for this app.', 'warning'); return; }
            const html = `
                <html>
                <head>
                    <title>Hospital Monthly Report - ${monthLabel}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color:#111 }
                        h1 { font-size: 18px; margin-bottom: 8px }
                        table { width:100%; border-collapse: collapse; margin-top: 12px }
                        th, td { border:1px solid #ddd; padding:8px; text-align:left }
                        th { background:#f6f6f6 }
                        .hospital { font-weight:700 }
                        .right { text-align:right }
                    </style>
                </head>
                <body>
                    <h1>Hospital Monthly Report</h1>
                    <div>${monthLabel}</div>
                    <table>
                        <thead><tr><th>Hospital</th><th class="right">Total Revenue</th><th>PR Agent</th><th class="right">Referrals</th><th class="right">PR Revenue</th></tr></thead>
                        <tbody>
                            ${data.map(h => {
                                const prRows = (h.prs && h.prs.length) ? h.prs.map(pr=>`<tr><td></td><td></td><td>${pr.name}</td><td class="right">${pr.orders}</td><td class="right">${formatCurrency(pr.revenue)}</td></tr>`).join('') : '';
                                return `<tr><td class="hospital">${h.hospital}</td><td class="right">${formatCurrency(h.totalRevenue)}</td><td></td><td class="right">${h.orders}</td><td class="right"></td></tr>${prRows}`;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            win.document.write(html);
            win.document.close();
            win.focus();
            setTimeout(() => { try { win.print(); } catch(e){} }, 500);
        }

        // Compute hospital performance for the selected calendar month (shows only hospitals with revenue > 0)
        function getHospitalMonthlyPerformance(targetDate = appState.hospitalPerformanceMonth || new Date()) {
            const month = targetDate.getMonth();
            const year = targetDate.getFullYear();

            const map = {};

            // Prepopulate with assigned hospitals (so assigned hospitals show even with zero revenue)
            prList.forEach(pr => {
                const h = pr.hospital && pr.hospital.trim() ? pr.hospital.trim() : 'Unassigned';
                if (!map[h]) map[h] = { totalRevenue: 0, orders: 0, prs: {} };
                if (!map[h].prs[pr.name]) map[h].prs[pr.name] = { revenue: 0, orders: 0 };
            });

            orders.filter(o => {
                const d = new Date(o.date);
                return d.getMonth() === month && d.getFullYear() === year;
            }).forEach(o => {
                const h = (o.referredHospital && o.referredHospital.trim()) || 'Unassigned';
                if (!map[h]) map[h] = { totalRevenue: 0, orders: 0, prs: {} };
                map[h].totalRevenue += o.total || 0;
                map[h].orders += 1;
                const pr = o.referredBy || 'Unknown';
                if (!map[h].prs[pr]) map[h].prs[pr] = { revenue: 0, orders: 0 };
                map[h].prs[pr].revenue += o.total || 0;
                map[h].prs[pr].orders += 1;
            });

            return Object.keys(map).map(h => ({
                hospital: h,
                totalRevenue: map[h].totalRevenue,
                orders: map[h].orders,
                prs: Object.keys(map[h].prs).map(name => ({ name, revenue: map[h].prs[name].revenue, orders: map[h].prs[name].orders })).sort((a,b) => b.revenue - a.revenue)
            })).sort((a, b) => b.totalRevenue - a.totalRevenue);
        }

        // Inventory search suggestions (used on Inventory page)
        function renderInventorySuggestions(query) {
            const suggestionsDiv = document.getElementById('inventorySuggestions');
            if (!suggestionsDiv) return;

            const q = (query || '').toLowerCase().trim();
            if (!q) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const matches = inventory.filter(it => it.name.toLowerCase().includes(q)).slice(0, 8);
            if (matches.length === 0) {
                suggestionsDiv.innerHTML = `<div style="padding:0.5rem; color:var(--text-secondary); font-size:0.9rem;">No results for "${query}"</div>`;
                suggestionsDiv.style.display = 'block';
                return;
            }

            suggestionsDiv.innerHTML = matches.map(it => `
                <div class="autocomplete-item" tabindex="0" data-id="${it.id}" data-name="${it.name}">${it.name}</div>
            `).join('');
            suggestionsDiv.style.display = 'block';
        }

        function selectInventoryItemById(id, name) {
            // Set search and re-render
            const input = document.getElementById('inventorySearch');
            const suggestionsDiv = document.getElementById('inventorySuggestions');
            if (input) input.value = name;
            appState.inventorySearchQuery = name;
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
            renderApp();

            // Scroll to the item after render
            setTimeout(() => {
                const row = document.getElementById('inventory-item-' + id);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const prevBg = row.style.background;
                    row.style.background = 'rgba(255, 235, 59, 0.15)';
                    setTimeout(() => { row.style.background = prevBg; }, 2000);
                }
            }, 120);
        }

        // Records search suggestions (Patient Records page)
        function renderRecordsSuggestions(query) {
            const suggestionsDiv = document.getElementById('recordsSuggestions');
            if (!suggestionsDiv) return;

            clearTimeout(recordsSuggestTimeout);
            recordsSuggestTimeout = setTimeout(() => {
                const q = (query || '').toLowerCase().trim();
                if (!q) { suggestionsDiv.style.display = 'none'; return; }

                const matches = orders.filter(o => (o.patientName || '').toLowerCase().includes(q) || (o.pid || '').toLowerCase().includes(q))
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 8);

                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = `<div class="autocomplete-item" style="color:var(--text-secondary);">No results for "${query}"</div>`;
                    suggestionsDiv.style.display = 'block';
                    return;
                }

                suggestionsDiv.innerHTML = matches.map(m => `
                    <div class="autocomplete-item" tabindex="0" data-id="${m.id}" data-pid="${m.pid}">
                        <div style="font-weight:500;">${m.patientName}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary);">${m.pid}  ${new Date(m.date).toISOString().split('T')[0]}</div>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            }, 120);
        }

        // History search suggestions
        function renderHistorySuggestions(query) {
            const suggestionsDiv = document.getElementById('historySuggestions');
            if (!suggestionsDiv) return;

            clearTimeout(historySuggestTimeout);
            historySuggestTimeout = setTimeout(() => {
                const q = (query || '').toLowerCase().trim();
                if (!q) { suggestionsDiv.style.display = 'none'; return; }

                const matches = auditLog.filter(l => (l.user || '').toLowerCase().includes(q) || (l.action || '').toLowerCase().replace('_',' ').includes(q))
                    .slice(0, 8);

                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = `<div class="autocomplete-item" style="color:var(--text-secondary);">No results for "${query}"</div>`;
                    suggestionsDiv.style.display = 'block';
                    return;
                }

                suggestionsDiv.innerHTML = matches.map(m => `
                    <div class="autocomplete-item" tabindex="0" data-id="${m.id}" data-label="${(m.user || '') + '  ' + (m.action || '').replace('_',' ')}">
                        <div style="font-weight:500;">${m.user}</div>
                        <div style="font-size:0.85rem; color:var(--text-secondary);">${(m.action || '').replace('_',' ')}  ${new Date(m.timestamp).toISOString().split('T')[0]}</div>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
                // make items clickable and keyboard accessible for arrow navigation
                suggestionsDiv.querySelectorAll('.autocomplete-item').forEach(it => {
                    it.onclick = function() { selectHistoryById(this.dataset.id, this.dataset.label || this.textContent.trim()); };
                    it.onkeydown = function(e) { if (e.key === 'Enter') this.click(); };
                    it.onfocus = function() { /* focus visual handled via CSS */ };
                });
            }, 120);
        }

        function selectHistoryById(id, label) {
            const input = document.getElementById('historySearch');
            const suggestionsDiv = document.getElementById('historySuggestions');
            if (input) input.value = label;
            appState.historySearchQuery = label;

            // Set page to where the history entry lives
            const idx = auditLog.findIndex(a => String(a.id) === String(id));
            if (idx >= 0) appState.analytics.historyPage = Math.floor(idx / 10);

            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
            renderApp();

            // Scroll to the history row after render
            setTimeout(() => {
                const row = document.getElementById('history-item-' + id);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const prevBg = row.style.background;
                    row.style.background = 'rgba(255, 235, 59, 0.15)';
                    setTimeout(() => { row.style.background = prevBg; }, 2000);
                }
            }, 120);
        }

        function selectRecordById(id, pidOrName) {
            const input = document.getElementById('searchQuery');
            const suggestionsDiv = document.getElementById('recordsSuggestions');
            if (input) input.value = pidOrName;
            appState.recordFilters.searchQuery = pidOrName;

            // Set page to where the record lives
            const idx = orders.findIndex(o => String(o.id) === String(id));
            if (idx >= 0) appState.analytics.historyPage = Math.floor(idx / 10);

            if (suggestionsDiv) suggestionsDiv.style.display = 'none';
            renderApp();

            // Scroll to the record row after render
            setTimeout(() => {
                const row = document.getElementById('record-item-' + id);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const prevBg = row.style.background;
                    row.style.background = 'rgba(255, 235, 59, 0.15)';
                    setTimeout(() => { row.style.background = prevBg; }, 2000);
                }
            }, 120);
        }

        async function addNewPRAgent() {
            const query = document.getElementById('referredBySearch').value.trim();
            if (!query) {
                await showModal('Please enter a PR agent name', 'warning');
                return;
            }
            const phone = prompt(`Enter phone number for "${query}" (optional):`, '');
            if (phone === null) return; // user cancelled
            // Capture hospital if entered on billing form
            const hospital = (document.getElementById('referringHospital') && document.getElementById('referringHospital').value.trim()) || '';
            // Add to prList
            const newId = (prList.length > 0 ? Math.max(...prList.map(p => p.id)) : 0) + 1;
            const finalPhone = phone.trim() || 'N/A';
            prList.push({ id: newId, name: query, phone: finalPhone, hospital: hospital });
            appState.billingData.referredBy = query;
            if (hospital) appState.billingData.referringHospital = hospital;
            document.getElementById('referredBySearch').value = query;
            document.getElementById('prSuggestions').style.display = 'none';
            document.getElementById('addPRAgentContainer').style.display = 'none';
            logAction('ADD_PR_AGENT', `New PR agent added: ${query} (${finalPhone}) and assigned to hospital '${hospital || 'Unassigned'}'.`);
        }

        function handleFirstTimeSetup() {
            const setupName = document.getElementById('setupFullName').value.trim();
            const setupUsername = (document.getElementById('setupUsername').value || '').trim().toLowerCase();
            const setupPassword = (document.getElementById('setupPassword').value || '').toLowerCase();
            const setupPasswordConfirm = (document.getElementById('setupPasswordConfirm').value || '').toLowerCase();

            if (!setupName || !setupUsername || !setupPassword || !setupPasswordConfirm) {
                showModal('Please fill in all fields', 'warning');
                return;
            }

            if (setupPassword !== setupPasswordConfirm) {
                showModal('Passwords do not match', 'warning');
                return;
            }

            if (setupPassword.length < 6) {
                showModal('Password must be at least 6 characters', 'warning');
                return;
            }

            // Create first admin user (store credentials lowercased for case-insensitive auth)
            users.push({
                username: setupUsername,
                password: setupPassword,
                role: 'Admin',
                fullName: setupName
            });

            autoSave(); // Save the new user
            // Set user BEFORE logging action
            appState.currentUser = { username: setupUsername, role: 'Admin', fullName: setupName };
            logAction('SETUP', `First admin user created: ${setupName} (${setupUsername})`);
            appState.currentView = 'dashboard';
            renderApp();
        }

        function logout() {
            logAction('LOGOUT', `User '${appState.currentUser.fullName}' logged out.`);
            appState.currentUser = null;
            appState.currentView = 'login';
            appState.billingStep = 1;
            autoSave(); // Persist any final state changes
            renderApp();
        }

        function navigateTo(view) {
            // If user is leaving billing and there's unsaved billing data, show confirm modal
            if (appState.currentView === 'billing' && view !== 'billing' && hasUnsavedBilling()) {
                showNavigateAwayModal(view);
                return;
            }

            appState.currentView = view;
            appState.billingStep = 1;
            appState.editingPRId = null; // Cancel any edits when navigating away
            appState.editingInventoryId = null;
            resetAddForms(); // Reset forms when navigating away
            if (view !== 'inventory') appState.inventorySearchQuery = ''; // Reset inventory search
            if (view !== 'history') appState.analytics.historyPage = 0; // Reset history page
            if (view !== 'pr-management') appState.recordFilters.prManagementSearchQuery = ''; // Reset PR search
            if (view !== 'history') appState.historySearchQuery = ''; // Reset history search
            if (view !== 'analytics') appState.analytics.prPerformancePage = 0; // Reset analytics page
            clearFilters(); // Clear filters when navigating away from records
            renderApp();
        }

        function toggleSidebar() {
            appState.sidebarCollapsed = !appState.sidebarCollapsed;
            renderApp();
        }

        async function billingStep(step) {
            if (step === 2) {
                appState.billingData.patientName = document.getElementById('patientName').value;
                appState.billingData.contact = document.getElementById('patientContact').value;
                appState.billingData.referredBy = document.getElementById('referredBySearch').value;
                appState.billingData.staffName = appState.currentUser.fullName;
                appState.billingData.pid = document.getElementById('patientName').value ? (appState.billingData.pid || generatePID()) : '';

                saveDraft(); // Auto-save draft when moving to step 2
                if (!appState.billingData.patientName || !appState.billingData.staffName) {
                    await showModal('Please fill in Patient Name and Staff Name', 'warning');
                    return;
                }
            }
            appState.billingStep = step;
            renderApp();
            if (step > 1) saveDraft(); // Auto-save on subsequent steps too
        }

        function updateBillingCalculations() {
            let subtotal = 0;
            const selectedServicesListEl = document.getElementById('selectedServicesList');
            let servicesHTML = '';

            // Prefer using the appState.selectedServices (this is populated when users pick via search/suggestions)
            const selected = appState.billingData.selectedServices || [];
            selected.forEach(s => {
                const usedPrice = (s.overridePrice != null) ? s.overridePrice : (s.price != null ? s.price : 0);
                subtotal += Number(usedPrice || 0);
                // render name, category and price with a small remove button
                const catHtml = s.category ? `<div style="font-size:0.8rem; color:var(--text-secondary);">${s.category}</div>` : '';
                const vipTag = s.overridePrice != null ? ` <strong style=\\"color:var(--accent);\\">(VIP)</strong>` : '';
                // If VIP mode is enabled, show an inline override input
                const overrideInput = appState.vipMode ? `
                    <input type="number" class="vip-override-input" data-id="${s.id}" value="${s.overridePrice != null ? s.overridePrice : ''}" placeholder="Override price..." style="width:100px; padding:0.25rem; font-size:0.85rem; border:1px solid var(--border); border-radius:0.25rem;" />
                ` : '';
                servicesHTML += ` 
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem; padding:0.5rem; background:var(--background); border-radius:0.25rem;">
                        <div style="flex:1;">
                            <div> ${s.name}${vipTag}</div>
                            ${catHtml}
                        </div>
                        <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:0.25rem;">
                            <div style="font-weight:700">${formatCurrency(usedPrice)}</div>
                            ${overrideInput}
                            <button class="remove-selected" data-id="${s.id}" style="background:none; border:none; color:var(--error); cursor:pointer; font-size:0.95rem;">&times; Remove</button>
                        </div>
                    </div>
                `;
            });

            // Backwards compatibility: if no selected services in appState, fall back to checked boxes
            if ((!selected || selected.length === 0) && document.querySelectorAll('.service-checkbox:checked').length) {
                document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
                    const id = checkbox.dataset.id;
                    const name = checkbox.dataset.name;
                    let originalPrice = parseFloat(checkbox.dataset.price);
                    if (isNaN(originalPrice)) originalPrice = 0;
                    const inv = inventory.find(i => String(i.id) === String(id));
                    const category = inv ? inv.category : '';
                    subtotal += originalPrice;
                    servicesHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;"><span> ${name}</span><span>${formatCurrency(originalPrice)}</span></div>`;
                    appState.billingData.selectedServices.push({ id, name, category, price: originalPrice, originalPrice });
                });
            }

            const discount = parseFloat(document.getElementById('discount')?.value || 0);
            const finalDiscount = calculateDiscount(subtotal, discount);
            const total = subtotal - finalDiscount;

            appState.billingData.discount = finalDiscount;
            appState.billingData.total = total;

            if (selectedServicesListEl) {
                if (servicesHTML) {
                    selectedServicesListEl.innerHTML = servicesHTML + (selected.length ? `<div style="margin-top:0.5rem;"><small style="color:var(--text-secondary);">Click a selected item below to remove it.</small></div>` : '');
                } else {
                    selectedServicesListEl.innerHTML = `<div style="color: var(--text-secondary); text-align: center;">No services selected yet.</div>`;
                }
            } else {
                // no selected services container present in current view
                // keep calculations but skip DOM update
            }

            const subtotalEl = document.getElementById('subtotal');
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            const discountEl = document.getElementById('discountDisplay');
            if (discountEl) discountEl.textContent = formatCurrency(finalDiscount);
            const totalEl = document.getElementById('totalAmount');
            if (totalEl) totalEl.textContent = formatCurrency(total);
            const receiptTotalEl = document.getElementById('receiptTotal');
            if (receiptTotalEl) receiptTotalEl.textContent = formatCurrency(total);
            const receiptServicesEl = document.getElementById('receiptServices');
            if (receiptServicesEl) receiptServicesEl.innerHTML = (appState.billingData.selectedServices || []).map(s => `<div style="display:flex; justify-content:space-between;"><span> ${s.name}${s.overridePrice != null ? ' (VIP)' : ''}</span><span>${formatCurrency(s.overridePrice != null ? s.overridePrice : s.price)}</span></div>`).join('');
        }

        function selectPaymentStatus(status) {
            appState.billingData.paymentStatus = status;
            renderApp();
        }

        function finalizeBilling() {
            billingStep(3);
        }

        // Toggle VIP form mode: allows manual override of service prices
        function toggleVIPMode() {
            appState.vipMode = !appState.vipMode;
            // Re-render billing so override inputs appear/disappear
            renderApp();
        }

        function selectPaymentMethod(method) {
            appState.billingData.paymentMethod = method;
            if (method !== 'split') {
                appState.billingData.splitPayments = { cash: 0, pos: 0, transfer: 0 };
            }
            if (appState.billingData.paymentStatus === 'full') {
                appState.billingData.amountPaid = appState.billingData.total;
            }
            renderApp();
        }

        function renderSplitPaymentInputs() {
            return `
                <div class="card animate-fade-in" style="margin-top: 1rem; background-color: var(--background);">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">Enter Split Amounts</h4>
                    <div class="grid-3">
                        <div class="form-group"><label class="form-label">Cash</label><input type="number" class="form-input" data-split-method="cash" value="${appState.billingData.splitPayments.cash}" oninput="updateSplitPayment('cash', this.value)" onblur="commitSplitPayment()"></div>
                        <div class="form-group"><label class="form-label">POS</label><input type="number" class="form-input" data-split-method="pos" value="${appState.billingData.splitPayments.pos}" oninput="updateSplitPayment('pos', this.value)" onblur="commitSplitPayment()"></div>
                        <div class="form-group"><label class="form-label">Transfer</label><input type="number" class="form-input" data-split-method="transfer" value="${appState.billingData.splitPayments.transfer}" oninput="updateSplitPayment('transfer', this.value)" onblur="commitSplitPayment()"></div>
                    </div>
                </div>
            `;
        }

        function updateSplitPayment(method, value) {
            // Update state immediately but avoid re-rendering the whole app on every keystroke
            appState.billingData.splitPayments[method] = parseFloat(value) || 0;

            const totalPaid = Object.values(appState.billingData.splitPayments).reduce((sum, val) => sum + (val || 0), 0);
            appState.billingData.amountPaid = totalPaid;
            if (appState.billingData.paymentStatus === 'installment') {
                appState.billingData.balance = Math.max(0, appState.billingData.total - totalPaid);
            }

            // Update important UI elements directly for immediate feedback
            const receiptAmount = document.getElementById('receiptAmountPaid');
            if (receiptAmount) receiptAmount.textContent = formatCurrency(appState.billingData.amountPaid);
            const receiptBalance = document.getElementById('receiptBalance');
            if (receiptBalance) receiptBalance.textContent = formatCurrency(appState.billingData.balance);

            // Debounced render to commit changes and avoid bubbling/flicker while typing
            clearTimeout(splitPaymentTimeout);
            // If the user is actively focused on one of the split inputs, avoid scheduling a render
            const active = document.activeElement;
            const focusedIsSplit = active && active.getAttribute && active.getAttribute('data-split-method');
            if (!focusedIsSplit) {
                splitPaymentTimeout = setTimeout(() => {
                    renderApp();
                    splitPaymentTimeout = null;
                }, 180); // 180ms debounce for typing
            } else {
                // keep splitPaymentTimeout null while typing  render will occur on blur via commitSplitPayment
                splitPaymentTimeout = null;
            }
        }

        function commitSplitPayment() {
            // User left the input  commit any pending changes immediately
            clearTimeout(splitPaymentTimeout);
            splitPaymentTimeout = null;
            renderApp();
        }

        function updateInstallmentPayment(amount) {
            const paidAmount = parseFloat(amount) || 0;
            appState.billingData.amountPaid = paidAmount;
            appState.billingData.balance = Math.max(0, appState.billingData.total - paidAmount);

            // Directly update the UI elements instead of re-rendering the whole app
            const receiptAmountEl = document.getElementById('receiptAmountPaid');
            const receiptBalanceEl = document.getElementById('receiptBalance');
            const balanceDisplayEl = document.querySelector('#step3 .animate-fade-in strong');

            if (receiptAmountEl) {
                receiptAmountEl.textContent = formatCurrency(paidAmount);
            }
            if (receiptBalanceEl) {
                receiptBalanceEl.textContent = formatCurrency(appState.billingData.balance);
            }
            if (balanceDisplayEl) {
                balanceDisplayEl.textContent = formatCurrency(appState.billingData.balance);
            }
        }

        function buildReceiptHTML(order) {
            // Support services stored either as array of names or array of {name, price, category} objects
            const serviceDetails = order.services.map(s => {
                if (typeof s === 'string') {
                    const service = inventory.find(inv => inv.name === s);
                    return { name: s, price: service ? service.price : 0, category: service ? service.category : '' };
                }
                // object with name, price, category
                return { name: s.name || 'Unnamed', price: typeof s.price === 'number' ? s.price : 0, category: s.category || '' };
            });
            const subtotal = serviceDetails.reduce((sum, s) => sum + s.price, 0);

            return `
                <html>
                <head>
                    <title>Official Receipt - ${order.pid}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
                        body { font-family: 'Roboto', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; margin: 0; color: #1e293b; background-color: #f8fafc; }
                        .receipt-container { width: 380px; margin: 0 auto; padding: 25px; background-color: #ffffff; min-height: 90vh; border: 1px solid #ddd; box-sizing: border-box; }
                        .receipt-header { text-align: center; border-bottom: 2px solid #334155; padding-bottom: 15px; margin-bottom: 20px; }
                        .receipt-header .logo { margin-bottom: 10px; }
                        .receipt-header .logo img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
                        .receipt-header h2 { margin: 0; font-size: 1.8rem; font-weight: 700; color: #0e4a7c; }
                        .receipt-header .address { font-size: 0.9rem; color: #475569; margin-top: 8px; line-height: 1.5; }
                        .receipt-header .receipt-title { margin: 10px 0 0 0; font-size: 1rem; color: #475569; font-weight: bold; }
                        .details { margin-bottom: 20px; }
                        .details div { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
                        .details div span:first-child { color: #475569; }
                        .services { border-top: 1px solid #cbd5e1; border-bottom: 1px solid #cbd5e1; padding: 15px 0; margin: 20px 0; }
                        .services .service-item { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; font-size: 1rem; }
                        .services .service-item .service-name { font-weight: 500; }
                        .services .service-item .service-category { font-size: 0.85rem; color: #64748b; }
                        .services .service-item .service-price { font-weight: 700; }
                        .total div { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
                        .total .grand-total { font-weight: 700; font-size: 1.5rem; border-top: 2px solid #1e293b; padding-top: 15px; margin-top: 10px; }
                        .total .balance-due { color: #ef4444; font-weight: 700; font-size: 1.3rem; }
                        .footer { text-align: center; margin-top: 25px; font-size: 0.9rem; color: #64748b; }
                        .footer p { margin: 5px 0; }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="receipt-header">
                            <div class="logo"><img src="${appState.companyProfile.logo}" alt="Company Logo" style="height: 80px; width: auto; margin: 0 auto;"/></div>
                            <h2>${appState.companyProfile.name}</h2>
                            <div class="address">
                                <p>${appState.companyProfile.address}</p>
                                <p>${appState.companyProfile.email} | ${appState.companyProfile.contact}</p>
                            </div>
                            <p class="receipt-title">Official Receipt</p>
                        </div>
                        <div class="details">
                            <div><span>Patient Name:</span> <strong>${order.patientName}</strong></div>
                            <div><span>Patient ID:</span> <strong>${order.pid}</strong></div>
                            <div><span>Date & Time:</span> <span>${new Date(order.date).toLocaleDateString()} ${order.time}</span></div>
                        </div>
                        <div class="services">
                            ${serviceDetails.map(s => `
                                <div class="service-item">
                                    <div>
                                        <div class="service-name">${s.name}</div>
                                        ${s.category ? `<div class="service-category">${s.category}</div>` : ''}
                                    </div>
                                    <div class="service-price">${formatCurrency(s.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="total">
                            <div><span>Subtotal:</span> <span>${formatCurrency(subtotal)}</span></div>
                            <div><span>Discount Given:</span> <span>-${formatCurrency(subtotal - order.total)}</span></div>
                            ${order.paymentMethod === 'split' && order.splitPayments ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #999;">
                                    <div><span>Payment Method:</span> <span>Split Payment</span></div>
                                    <div style="padding-left: 15px; font-size: 0.9rem; color: #475569; margin-top: 5px;">
                                        ${order.splitPayments.cash > 0 ? `<div><span>Cash:</span> <span>${formatCurrency(order.splitPayments.cash)}</span></div>` : ''}
                                        ${order.splitPayments.pos > 0 ? `<div><span>POS:</span> <span>${formatCurrency(order.splitPayments.pos)}</span></div>` : ''}
                                        ${order.splitPayments.transfer > 0 ? `<div><span>Transfer:</span> <span>${formatCurrency(order.splitPayments.transfer)}</span></div>` : ''}
                                    </div>
                                </div>
                            ` : `
                                <div><span>Payment Method:</span> <span>${order.paymentMethod.charAt(0).toUpperCase() + order.paymentMethod.slice(1)}</span></div>
                            `}
                            <div class="grand-total"><span>TOTAL:</span> <span>${formatCurrency(order.total)}</span></div>
                            ${order.paymentStatus === 'installment' ? `
                                <div><span>Amount Paid:</span> <span>${formatCurrency(order.amountPaid)}</span></div>
                                <div class="balance-due"><span>BALANCE DUE:</span> <span>${formatCurrency(order.balance)}</span></div>
                            ` : `
                                <div class="grand-total"><span>Amount Paid:</span> <span>${formatCurrency(order.total)}</span></div>
                            `}
                        <div class="footer">
                            <p><strong>Payment Status: ${order.paymentStatus === 'full' ? 'PAID IN FULL' : 'INSTALLMENT'}</strong></p>
                            <p>Thank you for choosing Silhouette Diagnostics.</p>
                        </div>
                    </div>
                </body></html>`;
        }

        function printReceipt(order) {
            const receiptHTML = buildReceiptHTML(order);

            const printFrame = document.createElement('iframe');
            printFrame.style.display = 'none';
            document.body.appendChild(printFrame);
            printFrame.contentDocument.write(receiptHTML);
            printFrame.contentWindow.print();
            document.body.removeChild(printFrame);
        }

        function showReceiptPreview(order) {
            // Simplified preview: show iframe, Print and Cancel. After any action (print or cancel), resolve so caller will navigate back to Dashboard.
            return new Promise((resolve) => {
                try {
                    const modal = document.createElement('div');
                    modal.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;`;
                    modal.dataset.silhouetteModal = 'true';

                    modal.innerHTML = `
                        <div style="background: var(--surface); border-radius: 0.5rem; padding: 0.5rem; width: 860px; max-width: 95%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); color: var(--text-primary); display:flex; flex-direction: column; gap:0.5rem; max-height: calc(100vh - 60px);">
                            <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.5rem 1rem; border-bottom: 1px solid #e6eef8;">
                                <h3 style="margin:0;">Receipt Preview</h3>
                                <div style="font-size:0.9rem; color:var(--text-secondary);">Printing is handled by your system dialog. After printing or cancelling you'll return to the Dashboard.</div>
                            </div>
                            <div style="flex:1 1 auto; overflow:auto; padding:1rem; background:#fff; border-top:1px solid #e6eef8; border-bottom:1px solid #e6eef8;">
                                <iframe id="receipt-preview-iframe" style="width:100%; min-height:360px; border:none; background:white;" srcdoc=""></iframe>
                            </div>
                            <div style="display:flex; gap:0.75rem; justify-content:flex-end; padding:0.75rem;">
                                <button data-print-btn style="background:var(--primary); color:white; border:none; padding:0.6rem 1rem; border-radius:0.25rem; cursor:pointer; font-weight:600;">Print</button>
                                <button data-back-btn style="background:var(--border); color:var(--text-primary); border:none; padding:0.6rem 1rem; border-radius:0.25rem; cursor:pointer; font-weight:600;">Cancel</button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    const iframe = modal.querySelector('#receipt-preview-iframe');
                    try { iframe.srcdoc = buildReceiptHTML(order); } catch(e) { console.error('Error loading preview iframe:', e); }

                    // Buttons
                    const printBtn = modal.querySelector('[data-print-btn]');
                    const backBtn = modal.querySelector('[data-back-btn]');

                    function cleanupAndResolve(result) {
                        try { if (modal.parentNode) modal.parentNode.removeChild(modal); } catch(e) {}
                        resolve(result);
                    }

                    if (printBtn) {
                        printBtn.addEventListener('click', (ev) => {
                            try { ev && ev.preventDefault && ev.preventDefault(); ev && ev.stopPropagation && ev.stopPropagation(); } catch(e) {}
                            try {
                                if (iframe && iframe.contentWindow && typeof iframe.contentWindow.print === 'function') {
                                    iframe.contentWindow.focus();
                                    iframe.contentWindow.print();
                                } else {
                                    printReceipt(order);
                                }
                            } catch (e) { console.error('print failed, fallback called:', e); try { printReceipt(order); } catch(e2) { console.error(e2); } }
                            showToast('Receipt sent to printer', 'success', 900);
                            // Immediately close preview so user can continue; submitBilling will navigate to Dashboard after this resolves
                            cleanupAndResolve('printed');
                        });
                    }

                    if (backBtn) {
                        backBtn.addEventListener('click', (ev) => {
                            try { ev && ev.preventDefault && ev.preventDefault(); ev && ev.stopPropagation && ev.stopPropagation(); } catch(e) {}
                            showToast('Returning to Dashboard', 'info', 900);
                            cleanupAndResolve('skipped');
                        });
                    }

                    // focus print button for quick action
                    try { setTimeout(() => { if (printBtn && typeof printBtn.focus === 'function') printBtn.focus(); }, 120); } catch(e) {}

                } catch (e) {
                    console.error('showReceiptPreview error:', e);
                    resolve(null);
                }
            });
        }

        function reprintReceiptById(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                showReceiptPreview(order).then(() => {
                    // preview handled printing or cancel; nothing else to do here
                }).catch(e => {
                    console.error('reprintReceiptById error:', e);
                    // Fallback to direct print if preview fails
                    try { printReceipt(order); } catch(e2) { showModal('Unable to print receipt.', 'error'); }
                });
            } else {
                showModal('Could not find order to print.', 'error');
            }
        }

        // --- Helper functions for new service selection flow ---
        function addServiceById(id) {
            console.debug('addServiceById called with id:', id);
            if (!id) return;
            const svc = inventory.find(i => String(i.id) === String(id));
            console.debug('addServiceById resolved svc:', svc);
            if (!svc) {
                console.warn('addServiceById: no matching service found for id:', id);
                return;
            }
            appState.billingData.selectedServices = appState.billingData.selectedServices || [];
            const exists = appState.billingData.selectedServices.find(s => String(s.id) === String(id));
            if (exists) return; // already added
            appState.billingData.selectedServices.push({ id: svc.id, name: svc.name, category: svc.category, price: svc.price ?? 0, originalPrice: svc.price ?? 0, overridePrice: null });
            updateBillingCalculations();
            renderApp();
        }

        function removeServiceById(id) {
            if (!id) return;
            appState.billingData.selectedServices = (appState.billingData.selectedServices || []).filter(s => String(s.id) !== String(id));
            // uncheck any checkboxes for compatibility
            const cb = document.querySelector(`.service-checkbox[data-id="${id}"]`);
            if (cb) cb.checked = false;
            updateBillingCalculations();
        }

        function openCategoryList() {
            // show all categories as suggestions
            renderServiceSuggestions('');
        }

        function renderServiceSuggestions(query, opts = {}) {
            const container = document.getElementById('serviceSuggestions');
            if (!container) return;
            // Ensure the suggestions container is visible when we populate it
            try { container.style.display = 'block'; container.style.maxHeight = '240px'; container.style.overflowY = 'auto'; container.scrollTop = 0; container.setAttribute('aria-expanded','true'); } catch(e) {}
            container.style.display = 'block'; container.setAttribute('aria-expanded','true');

            // Ensure the suggestions container is visible when we populate it
            const q = (query || '').trim().toLowerCase();

            // If expandCategory option provided and query matches a category, show that category items
            if (opts.expandCategory && q) {
            const cat = Object.keys(inventory.reduce((acc, s) => (acc[s.category] = true, acc), {})).find(c => c.toLowerCase().includes(q));
            if (cat) {
                const list = inventory.filter(i => i.category === cat).map(i => `<button type="button" class="suggestion-item" data-id="${i.id}" tabindex="0" role="option" style="display:block; width:100%; text-align:left; padding:0.5rem; cursor:pointer; border:1px solid var(--border); background:var(--background); border-radius:0.25rem; margin-bottom:0.25rem; transition:background 0.2s;">${i.name}  ${formatCurrency(i.price)}</button>`).join('');
                container.innerHTML = `<div style="font-weight:700; margin-bottom:0.5rem;">${cat}</div>${list}`;
                return;
            }
            }

            // If empty query, show categories list
            if (!q) {
            const cats = [...new Set(inventory.map(i => i.category))];
            container.innerHTML = cats.map(c => `<button type="button" class="suggestion-item" data-category="${c}" tabindex="0" role="option" style="margin:0.25rem; padding:0.35rem 0.6rem; border:1px solid var(--border); background:var(--background); border-radius:0.25rem; cursor:pointer; transition:background 0.2s;">${c}</button>`).join('');
            return;
            }

            // Search services and categories
            const matches = inventory.filter(i => i.name.toLowerCase().includes(q) || i.category.toLowerCase().includes(q));
            if (matches.length === 0) {
            container.innerHTML = `<div style="color:var(--text-secondary);">No matches for "${query}"</div>`;
            return;
            }

            // Group matches by category
            const groups = matches.reduce((acc, s) => { if (!acc[s.category]) acc[s.category] = []; acc[s.category].push(s); return acc; }, {});
            container.innerHTML = Object.keys(groups).map(cat => `<div style="margin-bottom:0.75rem;"><div style="font-weight:700; margin-bottom:0.25rem;">${cat}</div>${groups[cat].map(i => `<button type="button" class="suggestion-item" data-id="${i.id}" tabindex="0" role="option" style="display:block; width:100%; text-align:left; padding:0.5rem; cursor:pointer; border:1px solid var(--border); background:var(--background); border-radius:0.25rem; margin-bottom:0.25rem; transition:background 0.2s;">${i.name}  ${formatCurrency(i.price)}</button>`).join('')}</div>`).join('');
        }

        // --- Inventory Page Autocomplete Logic ---
        function attachInventorySearchAutocomplete() {
            const input = document.getElementById('inventorySearch');
            const suggestionsBox = document.getElementById('inventorySuggestions');
            if (!input || !suggestionsBox) return;

            input.addEventListener('input', function () {
            const query = this.value.trim().toLowerCase();
            if (!query) {
                suggestionsBox.style.display = 'none';
                return;
            }
            // Find matches
            const matches = inventory.filter(item =>
                item.name.toLowerCase().includes(query) ||
                item.category.toLowerCase().includes(query)
            );
            if (matches.length === 0) {
                suggestionsBox.innerHTML = `<div class="autocomplete-item" style="color:var(--text-secondary);">No matches for "${this.value}"</div>`;
                suggestionsBox.style.display = 'block';
                return;
            }
            suggestionsBox.innerHTML = matches.map(item =>
                `<div class="autocomplete-item" data-id="${item.id}">${item.name} <span style="color:var(--text-secondary); font-size:0.85em;">(${item.category})</span>  <strong>${formatCurrency(item.price)}</strong></div>`
            ).join('');
            suggestionsBox.style.display = 'block';
            });

            input.addEventListener('focus', function () {
            if (this.value.trim()) input.dispatchEvent(new Event('input'));
            });

            input.addEventListener('blur', function () {
            setTimeout(() => { suggestionsBox.style.display = 'none'; }, 150);
            });

            suggestionsBox.addEventListener('mousedown', function (e) {
            const item = e.target.closest('.autocomplete-item');
            if (!item) return;
            const id = item.dataset.id;
            const targetElement = document.getElementById(`inventory-item-${id}`);

            if (targetElement) {
                // Clear the search query to show the full list
                appState.inventorySearchQuery = '';
                input.value = '';
                suggestionsBox.style.display = 'none';

                // Re-render to ensure the full list is visible before scrolling
                renderApp();

                // Use a timeout to ensure the element exists in the DOM after re-render
                setTimeout(() => {
                    const elementToScrollTo = document.getElementById(`inventory-item-${id}`);
                    elementToScrollTo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    elementToScrollTo.style.transition = 'background-color 0.5s';
                    elementToScrollTo.style.backgroundColor = 'var(--accent-light)';
                    setTimeout(() => { elementToScrollTo.style.backgroundColor = ''; }, 2000); // Remove highlight after 2 seconds
                }, 100);
            }
            });
        }

        function renderAdvancedFilter() {
            const filters = appState.recordFilters;
            return `
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Filter By</label>
                        <select class="form-select" onchange="updateFilterType(this.value)">
                            <option value="all" ${filters.filterType === 'all' ? 'selected' : ''}>Daily View</option>
                            <option value="date" ${filters.filterType === 'date' ? 'selected' : ''}>Specific Date</option>
                            <option value="month" ${filters.filterType === 'month' ? 'selected' : ''}>Month</option>
                            <option value="year" ${filters.filterType === 'year' ? 'selected' : ''}>Year</option>
                        </select>
                    </div>

                    ${filters.filterType === 'date' ? `
                        <div class="filter-group">
                            <label>Date</label>
                            <input type="date" class="form-input" value="${filters.date}" onchange="updateFilter('date', this.value)">
                        </div>
                    ` : ''}

                    ${filters.filterType === 'month' ? `
                        <div class="filter-group">
                            <label>Month</label>
                            <input type="month" class="form-input" value="${filters.month}" onchange="updateFilter('month', this.value)">
                        </div>
                    ` : ''}

                    ${filters.filterType === 'year' ? `
                        <div class="filter-group">
                            <label>Year</label>
                            <input type="number" class="form-input" placeholder="YYYY" value="${filters.year}" onchange="updateFilter('year', this.value)">
                        </div>
                    ` : ''}

                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
                    </div>
                </div>
            `;
        }


        async function submitBilling() {
            if (appState.billingData.selectedServices.length === 0) {
                await showModal('Please select at least one service', 'warning');
                return;
            }

            if (appState.billingData.paymentStatus === 'installment' && appState.billingData.amountPaid <= 0) {
                await showModal('For installment payments, please enter the amount paid.', 'warning');
                return;
            }

            // Combined confirmation: complete billing and preview/print receipt (include payment method)
            const totalAmountFormatted = formatCurrency(appState.billingData.total);
            // Describe payment method in a human-friendly way
            let paymentDesc = '';
            if ((appState.billingData.paymentMethod || '').toLowerCase() === 'split') {
                const parts = Object.entries(appState.billingData.splitPayments || {}).filter(([k,v]) => v > 0).map(([k,v]) => `${k.toUpperCase()}: ${formatCurrency(v)}`);
                paymentDesc = parts.length ? `Split (${parts.join(', ')})` : 'Split';
            } else {
                paymentDesc = (appState.billingData.paymentMethod || 'Cash').charAt(0).toUpperCase() + (appState.billingData.paymentMethod || 'cash').slice(1);
            }

            const confirmed = await showConfirm(`Complete billing for "${appState.billingData.patientName}" with a total of ${totalAmountFormatted} (Payment: ${paymentDesc})? Click Confirm to preview and print the receipt. You will be returned to the Dashboard after printing.`);
            if (!confirmed) {
                return; // User clicked 'Cancel'
            }

            // Find and remove the draft associated with this billing
            const draftIndex = appState.drafts.findIndex(d => d.pid === appState.billingData.pid);
            if (draftIndex > -1) appState.drafts.splice(draftIndex, 1);

            // Resolve referred hospital: prefer explicit field, else use PR's assigned hospital if available
            const referredHospital = (appState.billingData.referringHospital && appState.billingData.referringHospital.trim()) || (prList.find(p => p.name === appState.billingData.referredBy && p.hospital && p.hospital.trim()) || {}).hospital || 'Not Specified';

            const newOrder = {
                id: orders.length + 1,
                patientName: appState.billingData.patientName,
                pid: appState.billingData.pid,
                // store services as objects with name, category and price so VIP overrides are preserved
                discount: appState.billingData.discount,
                services: appState.billingData.selectedServices.map(s => ({ name: s.name, category: s.category || (inventory.find(i => i.name === s.name) || {}).category || '', price: (s.overridePrice != null ? s.overridePrice : s.price) })),
                total: appState.billingData.total,
                status: appState.billingData.paymentStatus === 'full' ? 'PAID' : 'PENDING',
                referredBy: appState.billingData.referredBy || 'Not Specified',
                referredHospital: referredHospital,
                date: new Date(), // Store as a full Date object
                time: new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }), // Time can remain a string
                staffName: appState.billingData.staffName
                ,
                paymentMethod: Object.values(appState.billingData.splitPayments).filter(v => v > 0).length > 1 ? 'split' : appState.billingData.paymentMethod,
                splitPayments: Object.values(appState.billingData.splitPayments).filter(v => v > 0).length > 1 ? { ...appState.billingData.splitPayments } : null,
                paymentStatus: appState.billingData.paymentStatus,
                amountPaid: appState.billingData.paymentStatus === 'full' ? appState.billingData.total : 
                            (Object.values(appState.billingData.splitPayments).reduce((s, v) => s + v, 0)),
                balance: appState.billingData.paymentStatus === 'full' ? 0 : appState.billingData.balance
            };

            orders.push(newOrder);
            autoSave(); // Save after adding a new order
            logAction('CREATE_BILLING', `Created new bill for '${newOrder.patientName}' (PID: ${newOrder.pid}) with a total of ${formatCurrency(newOrder.total)}.`);
            // Immediately re-render so analytics (hospital performance) reflect this new billing
            try { renderApp(); } catch(e) { console.error('renderApp error after billing:', e); }

            // Show a receipt preview modal which allows printing. After printing (or skipping), return to dashboard
            try {
                await showReceiptPreview(newOrder);
            } catch (e) {
                console.error('Error in receipt preview flow:', e);
            }

            appState.billingData = {
                patientName: '', pid: '', contact: '', referredBy: '', referringHospital: '', staffName: '',
                selectedServices: [], discount: 0, total: 0, paymentMethod: 'cash', paymentStatus: 'full',
                amountPaid: 0, balance: 0,
                splitPayments: { cash: 0, pos: 0, transfer: 0 }
            };
            appState.billingStep = 1;
            navigateTo('dashboard');

            // Small deferred check and recovery to handle any lingering UI blocking states
            setTimeout(() => {
                const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                if (disabledEls.length > 0) {
                    console.warn('Post-billing check: found disabled elements, attempting recoverUI');
                    recoverUI();
                    clearAllEventListeners();
                    try { renderApp(); } catch(e) { console.error(e); }
                }
            }, 120);
        }

        function resetAddForms() {
            appState.showAddPRForm = false;
            appState.showAddInventoryForm = false;
            appState.showAddStaffForm = false;
            appState.editingPRId = null;
            appState.editingInventoryId = null;
            appState.editingCategoryName = null;
        }

        function toggleAddPRForm() {
            appState.showAddPRForm = !appState.showAddPRForm;
            renderApp();
        }

        function addNewPR() {
            const name = document.getElementById('newPRName').value.trim();
            const phone = document.getElementById('newPRPhone').value.trim();
            const hospital = document.getElementById('newPRHospital') ? document.getElementById('newPRHospital').value.trim() : '';

            if (!name) {
                alert('Please fill in the PR name.');
                return;
            }

            const newId = prList.length > 0 ? Math.max(...prList.map(p => p.id)) + 1 : 1;
            prList.push({
                id: newId,
                name,
                phone: phone || 'N/A',
                hospital: hospital || ''
            });

            autoSave(); // Save the updated PR list
            logAction('CREATE_PR', `Added new PR: '${name}' (${phone || 'N/A'}) assigned to hospital '${hospital || 'Unassigned'}'.`);
            appState.showAddPRForm = false;
            renderApp();
        }

        function toggleAddInventoryForm() {
            appState.showAddInventoryForm = !appState.showAddInventoryForm;
            renderApp();
        }

        function addNewInventoryItem() {
            const name = document.getElementById('newInventoryName').value;
            const category = document.getElementById('newInventoryCategory').value;
            const price = parseFloat(document.getElementById('newInventoryPrice').value);

            if (!name || !category || isNaN(price) || price <= 0) {
                alert('Please fill all fields with valid data for the new item.');
                return;
            }

            inventory.push({ id: (inventory.length > 0 ? Math.max(...inventory.map(i => i.id)) : 0) + 1, name, category, price });
            autoSave(); // Save the updated inventory

            logAction('CREATE_INVENTORY', `Added new test: '${name}' with price ${formatCurrency(price)}.`);
            appState.showAddInventoryForm = false;
            renderApp();
        }

        function toggleAddStaffForm() {
            appState.showAddStaffForm = !appState.showAddStaffForm;
            renderApp();
        }

        function addNewStaff() {
            const fullName = document.getElementById('newStaffFullName').value.trim();
            const username = document.getElementById('newStaffUsername').value.trim().toLowerCase();
            const password = document.getElementById('newStaffPassword').value;

            if (!fullName || !username || !password) {
                alert('Please fill all fields for the new staff member.');
                return;
            }

            if (username.length < 3) {
                alert('Username must be at least 3 characters.');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters.');
                return;
            }

            // Check if username already exists
            if (users.find(u => u.username === username)) {
                alert('This username already exists. Please choose a different one.');
                return;
            }

            // Add new staff user
            users.push({
                username,
                password,
                role: 'Staff',
                fullName
            });

            autoSave(); // Save the new user
            logAction('CREATE_STAFF', `Added new staff member: '${fullName}' (Username: ${username}).`);
            appState.showAddStaffForm = false; 
            renderApp();
        }

        function deleteStaff(username) {
            const userToDelete = users.find(u => u.username === username);
            if (!userToDelete) return;

            showConfirm(`Are you sure you want to delete "${userToDelete.fullName}"? This action cannot be undone.`).then(confirmed => {
                if (!confirmed) return;
                users = users.filter(u => u.username !== username);
                autoSave(); // Save the updated user list
                logAction('DELETE_STAFF', `Deleted staff: '${userToDelete.fullName}' (Username: ${username}).`);
                renderApp();
            });
        }

        // Generic function to toggle edit mode for an item
        function toggleEdit(type, id) {
            if (type === 'pr') {
                appState.editingPRId = id;
                appState.editingInventoryId = null; // Ensure only one item is edited at a time
            } else if (type === 'inventory') {
                appState.editingInventoryId = id;
                appState.editingPRId = null;
            }
            renderApp();
        }

        // Generic function to cancel an edit
        function cancelEdit(type) {
            if (type === 'pr') appState.editingPRId = null;
            if (type === 'inventory') appState.editingInventoryId = null;
            renderApp();
        }

        function savePREdit(id) {
            const pr = prList.find(p => p.id === id);
            if (!pr) return;

            const oldDetails = `Name: ${pr.name}, Phone: ${pr.phone}`;
            pr.name = document.getElementById(`editPRName-${id}`).value.trim();
            pr.phone = document.getElementById(`editPRPhone-${id}`).value.trim();
            pr.hospital = (document.getElementById(`editPRHospital-${id}`) && document.getElementById(`editPRHospital-${id}`).value.trim()) || '';

            autoSave(); // Save changes
            logAction('EDIT_PR', `Edited PR #${id}. FROM: [${oldDetails}] TO: [Name: ${pr.name}, Phone: ${pr.phone}, Hospital: ${pr.hospital || 'Unassigned'}].`);
            appState.editingPRId = null;
            renderApp();
        }

        function deletePR(id) {
            showConfirm('Are you sure you want to delete this PR?').then(confirmed => {
                if (!confirmed) return;
                const index = prList.findIndex(p => p.id === id);
                const prToDelete = prList[index];
                if (index > -1) {
                    prList.splice(index, 1);
                }
                autoSave(); // Save changes
                logAction('DELETE_PR', `Deleted PR: '${prToDelete.name}' (ID: ${prToDelete.id}).`);
                renderApp();
            });
        }

        function saveInventoryEdit(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            const oldDetails = `Name: ${item.name}, Price: ${formatCurrency(item.price)}`;
            item.name = document.getElementById(`editInventoryName-${id}`).value;
            item.category = document.getElementById(`editInventoryCategory-${id}`).value;
            item.price = parseFloat(document.getElementById(`editInventoryPrice-${id}`).value);

            autoSave(); // Save changes
            logAction('EDIT_INVENTORY', `Edited Test #${id}. FROM: [${oldDetails}] TO: [Name: ${item.name}, Price: ${formatCurrency(item.price)}].`);
            appState.editingInventoryId = null;
            renderApp();
        }

        function deleteInventoryItem(id) {
            showConfirm('Are you sure you want to delete this inventory item?').then(confirmed => {
                if (!confirmed) return;
                const index = inventory.findIndex(i => i.id === id);
                const itemToDelete = inventory[index];
                if (index > -1) {
                    inventory.splice(index, 1);
                }
                autoSave(); // Save changes
                logAction('DELETE_INVENTORY', `Deleted test: '${itemToDelete.name}' (ID: ${itemToDelete.id}).`);
                renderApp();
            });
        }

        function updateFilterType(type) {
            appState.recordFilters.filterType = type;
            appState.recordFilters.date = '';
            appState.recordFilters.month = '';
            appState.recordFilters.year = '';
            appState.recordFilters.time = '';
            renderApp();
        }

        function updateHistoryFilter(key, value) {
            appState.historyFilters[key] = value;
            appState.analytics.historyPage = 0; // Reset pagination on filter change
            renderApp();
        }

        function clearHistoryFilters() {
            appState.historyFilters = { user: '', action: '', startDate: '', endDate: '' };
            renderApp();
        }

        function updateFilter(key, value) {
            appState.recordFilters[key] = value;
            renderApp();
        }

        function updateFilter(key, value) {
            appState.recordFilters[key] = value;
            renderApp();
        }

        function clearFilters() {
            appState.recordFilters = { date: '', month: '', year: '', time: '', filterType: 'all', searchQuery: '', dailySummaryDate: new Date(), prManagementSearchQuery: '', searchAllRecords: false };
            renderApp();
        }
        function navigateToCurrentDayRecords() {
            appState.recordsViewDate = new Date();
            renderApp();
        }

        function changeRecordsDate(direction) {
            const newDate = new Date(appState.recordsViewDate);
            newDate.setDate(newDate.getDate() + direction);
            appState.recordsViewDate = newDate;
            renderApp();
        }

        function setRecordsDate(dateString) {
            appState.recordsViewDate = new Date(dateString);
            renderApp();
        }

        function exportData() {
            if (appState.currentUser.role !== 'Admin') {
                alert('Only admins can export data');
                return;
            }
            exportToCSV();
        }

        function viewOrderDetails(orderId) {
            appState.viewingOrderId = orderId;
            renderApp();
        }

        function closeOrderDetails() {
            appState.viewingOrderId = null;
            renderApp();
        }

        function markAsFullyPaid(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            showConfirm(`Are you sure you want to mark the order for ${order.patientName} (PID: ${order.pid}) as fully paid?`).then(confirmed => {
                if (!confirmed) return;
                order.status = 'PAID';
                order.paymentStatus = 'full';
                order.balance = 0;
                order.amountPaid = order.total;
                autoSave(); // Save the updated order
                logAction('UPDATE_PAYMENT', `Marked order #${order.id} for '${order.patientName}' as fully paid.`);
                printReceipt(order); // Print receipt after updating
                renderApp(); // Re-render to update the modal view
                showModal('Payment updated successfully! The receipt will now be printed.', 'success');
                // Second print handled with user confirmation above
            });
        }

        function changePRPerformancePage(direction) {
            const newPage = appState.analytics.prPerformancePage + direction;
            const prPerformance = getPRPerformance();
            const totalPages = Math.ceil(prPerformance.length / 10);

            if (newPage >= 0 && newPage < totalPages) {
                appState.analytics.prPerformancePage = newPage;
                renderApp();
            }
        }

        function changeHistoryPage(direction, logLength) {
            const newPage = appState.analytics.historyPage + direction;
            const totalPages = Math.ceil(logLength / 10);

            if (newPage >= 0 && newPage < totalPages) {
                appState.analytics.historyPage = newPage;
                renderApp();
            }
        }

        function toggleFullDailyRecord() {
            appState.showFullDailyRecord = !appState.showFullDailyRecord;
            if (appState.showFullDailyRecord) {
                // Reset to today's date when opening
                appState.dailyRecordViewDate = new Date();
            }
            renderApp();
        }

        function changeDailyRecordDate(direction) {
            const newDate = new Date(appState.dailyRecordViewDate);
            newDate.setDate(newDate.getDate() + direction);
            // Prevent going into the future
            if (newDate > new Date()) {
                return;
            }
            appState.dailyRecordViewDate = newDate;
            renderApp();
        }

        function toggleFullDailyCommissionReport() {
            appState.showFullDailyCommissionReport = !appState.showFullDailyCommissionReport;
            if (appState.showFullDailyCommissionReport) {
                appState.dailyCommissionViewDate = new Date();
            }
            renderApp();
        }

        function changeDailyCommissionDate(direction) {
            const newDate = new Date(appState.dailyCommissionViewDate);
            newDate.setDate(newDate.getDate() + direction);
            // Prevent going into the future
            if (newDate > new Date()) {
                return;
            }
            appState.dailyCommissionViewDate = newDate;
            renderApp();
        }

        function changeDailySummaryDate(direction) {
            const newDate = new Date(appState.recordFilters.dailySummaryDate);
            newDate.setDate(newDate.getDate() + direction);
            // Prevent going into the future
            if (newDate > new Date()) {
                return;
            }
            appState.recordFilters.dailySummaryDate = newDate;
            renderApp();
        }

        function updateAnalyticsDateRange(key, value) {
            appState.analyticsDateRange[key] = value;
            renderApp();
        }

        function resetAnalyticsDateRange() {
            appState.analyticsDateRange = {
                start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
                end: new Date().toISOString().split('T')[0]
            };
            renderApp();
        }

        // Keep a reference to the chart to destroy it before re-rendering
        let prChartInstance = null;

        function renderPRPerformanceChart() {
            const prPerformance = getFilteredPRPerformance();
            const ctx = document.getElementById('prPerformanceChart')?.getContext('2d');
            if (!ctx) return;

            // Destroy the old chart instance if it exists
            if (prChartInstance) {
                prChartInstance.destroy();
            }

            const labels = prPerformance.map(p => p.name);
            const data = prPerformance.map(p => p.revenue);

            prChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue Generated',
                        data: data,
                        backgroundColor: 'rgba(14, 74, 124, 0.6)', // --primary with opacity
                        borderColor: 'rgba(14, 74, 124, 1)', // --primary
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Display as a horizontal bar chart
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` Revenue: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        function toggleFullDailyTestRecord() {
            appState.showFullDailyTestRecord = !appState.showFullDailyTestRecord;
            if (appState.showFullDailyTestRecord) {
                // Reset to today's date when opening
                appState.dailyTestRecordViewDate = new Date();
            }
            renderApp();
        }

        function changeDailyTestRecordDate(direction) {
            const newDate = new Date(appState.dailyTestRecordViewDate);
            newDate.setDate(newDate.getDate() + direction);
            // Prevent going into the future
            if (newDate > new Date()) return;
            appState.dailyTestRecordViewDate = newDate;
            renderApp();
        }

        function saveCompanyProfile() {
            const name = document.getElementById('companyName').value;
            const address = document.getElementById('companyAddress').value;
            const email = document.getElementById('companyEmail').value;
            const contact = document.getElementById('companyContact').value;

            if (!name || !address || !email || !contact) {
                showModal('Please fill in all company profile fields.', 'warning');
                return;
            }

            appState.companyProfile = { ...appState.companyProfile, name, address, email, contact };
            localStorage.setItem('companyProfile', JSON.stringify(appState.companyProfile));
            autoSave(); // Save updated profile to the main data file as well
            logAction('UPDATE_PROFILE', `Updated company profile information.`);

            showModal('Company profile updated successfully!', 'success');
            renderApp();

            // Post-settings-save recovery check
            setTimeout(() => {
                const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                if (disabledEls.length > 0) {
                    console.warn('Post-company-save check: found disabled elements, attempting recoverUI');
                    recoverUI();
                    clearAllEventListeners();
                    try { renderApp(); } catch(e) { console.error(e); }
                }
            }, 120);
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Use FileReader to convert image to a Base64 Data URL
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                appState.companyProfile.logo = dataUrl;

                // Save the profile with the new logo immediately
                localStorage.setItem('companyProfile', JSON.stringify(appState.companyProfile));
                autoSave();
                logAction('UPDATE_PROFILE', 'Updated company logo.');
                showModal('Logo updated successfully!', 'success');
                
                // Re-render the app to show the new logo everywhere
                renderApp();

                // Post-logo-update recovery check
                setTimeout(() => {
                    const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                    if (disabledEls.length > 0) {
                        console.warn('Post-logo-update check: found disabled elements, attempting recoverUI');
                        recoverUI();
                        clearAllEventListeners();
                        try { renderApp(); } catch(e) { console.error(e); }
                    }
                }, 120);
            };
            reader.readAsDataURL(file);
        }

        async function handleBackup() {
            if (window.electronAPI) {
                const result = await window.electronAPI.backupData();
                if (result.success) {
                    showModal(`Data successfully backed up to: ${result.path}`, 'success');
                } else {
                    // Don't show an error if the user just cancelled the dialog
                    if (result.error) {
                        showModal(`Backup failed: ${result.error}`, 'error');
                        // Post-backup recovery check
                        setTimeout(() => {
                            const disabledEls = document.querySelectorAll('input:disabled, button:disabled, textarea:disabled, select:disabled');
                            if (disabledEls.length > 0) {
                                console.warn('Post-backup check: found disabled elements, attempting recoverUI');
                                recoverUI();
                                clearAllEventListeners();
                                try { renderApp(); } catch(e) { console.error(e); }
                            }
                        }, 120);
                    } else {
                        console.log('Backup cancelled by user.');
                    }
                }
            }
        }

        async function handleRestore() {
            if (window.electronAPI) {
                const result = await window.electronAPI.restoreData();
                if (result.success) {
                    // The main process will reload the window, so no alert is needed here.
                } else {
                    console.log('Restore cancelled by user.');
                }
            }
        }

        function printReport() {
            const { start, end } = appState.analyticsDateRange;
            const filteredStats = getFilteredStats();
            const prPerformance = getFilteredPRPerformance();

            const printContent = `
                <html>
                <head>
                    <title>Analytics Report</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        .section h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
                        .stat { font-size: 1.5rem; font-weight: bold; color: #0e4a7c; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Analytics Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Report for period: <strong>${start}</strong> to <strong>${end}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Company Income Summary</h2>
                        <p>Total Income for Selected Period: <span class="stat">${formatCurrency(filteredStats.totalRevenue)}</span></p>
                        <p>Total Orders in Period: <span class="stat">${filteredStats.orderCount}</span></p>
                    </div>

                    <div class="section">
                        <h2>Agent Referral Performance</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue Generated</th></tr></thead>
                            <tbody>
                                ${prPerformance.map(pr => `
                                    <tr><td>${pr.name}</td><td>${pr.orders}</td><td>${formatCurrency(pr.revenue)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function printPRPerformanceReport() {
            const { start, end } = appState.analyticsDateRange;
            const prPerformance = getFilteredPRPerformance();

            const printContent = `
                <html>
                <head>
                    <title>Referring Agent Revenue Report</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        .section h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Referring Agent Revenue Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Report for period: <strong>${start}</strong> to <strong>${end}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Agent Referral Performance</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue Generated</th></tr></thead>
                            <tbody>
                                ${prPerformance.map(pr => `
                                    <tr><td>${pr.name}</td><td>${pr.orders}</td><td>${formatCurrency(pr.revenue)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Helper: compute PR commissions for an explicit date range
        function getPRCommissionsInRange(startDate, endDate) {
            const prStats = {};
            orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= startDate && orderDate <= endDate;
            }).forEach(order => {
                const name = order.referredBy || 'Unknown';
                if (!prStats[name]) prStats[name] = { orders: 0, revenue: 0, commission: 0 };
                prStats[name].orders++;
                prStats[name].revenue += order.total;
                prStats[name].commission += calculateOrderCommission(order);
            });

            return Object.entries(prStats).map(([name, stats]) => ({
                name,
                orders: stats.orders,
                revenue: stats.revenue,
                commission: stats.commission
            })).sort((a, b) => b.commission - a.commission);
        }

        function printMonthlyCommissionReport() {
            const monthVal = document.getElementById('commissionMonth')?.value;
            if (!monthVal) {
                showToast('Please select a month to print.', 'warning');
                return;
            }
            const [year, month] = monthVal.split('-');
            const start = new Date(Number(year), Number(month) - 1, 1);
            const end = new Date(Number(year), Number(month), 0); // last day of selected month

            const commissions = getPRCommissionsInRange(start, end);
            const periodLabel = start.toLocaleString('en-CA', { month: 'long', year: 'numeric' });

            const printContent = `
                <html>
                <head>
                    <title>PR Agent Commission Report - ${periodLabel}</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>PR Agent Commission Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Period: <strong>${periodLabel}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Agent Commissions (10%)</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue</th><th>Commission (10%)</th></tr></thead>
                            <tbody>
                                ${commissions.map(c => `
                                    <tr><td>${c.name}</td><td>${c.orders}</td><td>${formatCurrency(c.revenue)}</td><td>${formatCurrency(c.commission)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printYearlyCommissionReport() {
            const yearVal = document.getElementById('commissionYear')?.value;
            if (!yearVal) {
                showToast('Please enter a year to print.', 'warning');
                return;
            }
            const year = Number(yearVal);
            const start = new Date(year, 0, 1);
            const end = new Date(year, 11, 31);

            const commissions = getPRCommissionsInRange(start, end);
            const periodLabel = `${year}`;

            const printContent = `
                <html>
                <head>
                    <title>PR Agent Commission Report - ${periodLabel}</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>PR Agent Commission Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Year: <strong>${periodLabel}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Agent Commissions (10%)</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue</th><th>Commission (10%)</th></tr></thead>
                            <tbody>
                                ${commissions.map(c => `
                                    <tr><td>${c.name}</td><td>${c.orders}</td><td>${formatCurrency(c.revenue)}</td><td>${formatCurrency(c.commission)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printCommissionReport() {
            const { start, end } = appState.analyticsDateRange;
            const commissions = getFilteredPRCommissions();

            const printContent = `
                <html>
                <head>
                    <title>PR Agent Commission Report</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        .section h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>PR Agent Commission Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Report for period: <strong>${start}</strong> to <strong>${end}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Agent Commissions</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue</th><th>Commission (10%)</th></tr></thead>
                            <tbody>
                                ${commissions.map(c => `
                                    <tr><td>${c.name}</td><td>${c.orders}</td><td>${formatCurrency(c.revenue)}</td><td>${formatCurrency(c.commission)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printDailyCommissionReport() {
            const date = appState.dailyCommissionViewDate.toISOString().split('T')[0];
            const daily = getDailyPRCommissions(appState.dailyCommissionViewDate);

            const printContent = `
                <html>
                <head>
                    <title>Daily Commission Report - ${date}</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        .section h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Daily PR Commission Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Date: <strong>${date}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Agent Commissions</h2>
                        <table>
                            <thead><tr><th>Agent Name</th><th>Orders</th><th>Revenue</th><th>Commission (10%)</th></tr></thead>
                            <tbody>
                                ${daily.map(c => `
                                    <tr><td>${c.name}</td><td>${c.orders}</td><td>${formatCurrency(c.revenue)}</td><td>${formatCurrency(c.commission)}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printTopTestsReport() {
            const { start, end } = appState.analyticsDateRange;
            const topTests = getFilteredTopTests();

            const printContent = `
                <html>
                <head>
                    <title>Top Ordered Tests Report</title>
                    <style>
                        body { font-family: sans-serif; }
                        .report-header { text-align: center; margin-bottom: 2rem; }
                        .report-header h1 { margin: 0; }
                        .report-header p { margin: 5px 0; color: #555; }
                        .section { margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
                        .section h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 0.5rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Top Ordered Tests Report</h1>
                        <p><strong>${appState.companyProfile.name}</strong></p>
                        <p>Report for period: <strong>${start}</strong> to <strong>${end}</strong></p>
                    </div>

                    <div class="section">
                        <h2>Top 5 Most Ordered Tests</h2>
                        <table>
                            <thead><tr><th>Test Name</th><th>Times Ordered</th></tr></thead>
                            <tbody>
                                ${topTests.map(test => `
                                    <tr><td>${test.name}</td><td>${test.count}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function printDailyRecords() {
            const dailyRecords = getFilteredRecords(); // This now gets records for the selected day
            const viewDate = appState.recordFilters.searchAllRecords ? 'All Records' : appState.recordsViewDate.toLocaleDateString('en-CA');

            if (dailyRecords.length === 0) {
                alert('No records to print for this day.');
                return;
            }

            const printContent = `
                <html>
                <head>
                    <title>Daily Records for ${viewDate}</title>
                    <style>
                        @media print { body { -webkit-print-color-adjust: exact; } }
                        body { font-family: sans-serif; margin: 0; background: #f3f4f6; }
                        .print-container { max-width: 900px; margin: 20px auto; background: #fff; border: 1px solid #ddd; padding: 18px; box-sizing: border-box; }
                        .report-header { text-align: center; margin-bottom: 1rem; }
                        .report-header .logo img { height: 60px; width: auto; display: block; margin: 0 auto 8px; }
                        .report-header h1 { margin: 0; font-size: 1.25rem; }
                        .report-header p { margin: 4px 0; color: #444; }
                        .table-wrapper { overflow: hidden; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.95rem; table-layout: auto; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; word-break: break-word; }
                        th { background-color: #f8fafc; }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <div class="report-header">
                            <div class="logo"><img src="${appState.companyProfile.logo}" alt="Company Logo"></div>
                            <h1>Patient Records</h1>
                            <p><strong>${appState.companyProfile.name}</strong></p>
                            <p>Records for: <strong>${viewDate}</strong></p>
                        </div>
                        <div class="table-wrapper">
                        <table>
                            <thead><tr><th>Patient Name</th><th>PID</th><th>Services</th><th>Total</th><th>Status</th><th>Staff</th><th>Time</th></tr></thead>
                            <tbody>
                                ${dailyRecords.map(order => `
                                    <tr><td>${order.patientName}</td><td>${order.pid}</td><td>${(order.services || []).map(s => typeof s === 'string' ? s : s.name).join(', ')}</td><td>${formatCurrency(order.total)}</td><td>${order.status}</td><td>${order.staffName}</td><td>${order.time || 'N/A'}</td></tr>
                                `).join('')}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function renderMainContent() {
            let content = '';

            if (appState.currentView === 'login') {
                content = components.Login.render({ companyProfile: appState.companyProfile });
            } else if (appState.currentView === 'dashboard') {
                content = renderDashboard();
            } else if (appState.currentView === 'billing') {
                content = renderBilling();
            } else if (appState.currentView === 'drafts') {
                content = renderDrafts();
            } else if (appState.currentView === 'inventory') {
                content = renderInventory();
            } else if (appState.currentView === 'pr-management') {
                content = renderPRManagement();
            } else if (appState.currentView === 'analytics') {
                content = renderAnalytics();
            } else if (appState.currentView === 'history') {
                content = renderHistory();
            } else if (appState.currentView === 'staff-management') {
                content = renderStaffManagement();
            } else if (appState.currentView === 'records') {
                content = renderRecords();
            } else if (appState.currentView === 'settings') {
                content = renderSettings(); // Added settings view rendering
            }

            return content;
        }

        // Store interval ID to prevent memory leaks
        let headerDateTimeInterval = null;

        function renderApp() {
            try {
                const isLoggedIn = appState.currentUser !== null;
                const appContainer = document.getElementById('app');

                if (isLoggedIn) {
                    appContainer.innerHTML = `
                        ${components.Sidebar({ currentUser: appState.currentUser, currentView: appState.currentView, sidebarCollapsed: appState.sidebarCollapsed })}
                        <div class="main-container ${appState.sidebarCollapsed ? 'sidebar-collapsed' : ''}">
                            ${components.Header({ currentUser: appState.currentUser, companyProfile: appState.companyProfile, sidebarCollapsed: appState.sidebarCollapsed })}
                            <div class="main-content">
                                ${renderOrderDetailsModal()}
                                ${renderMainContent()}
                            </div>
                        </div>
                    `;
                } else {
                    appContainer.innerHTML = renderMainContent();
                }

                // Save draft if user is on billing page and navigates away
                if (appState.currentView !== 'billing' && appState.billingData.patientName) saveDraft();
                
                if (isLoggedIn) {
                    updateHeaderDateTime();
                    // Clear old interval before creating new one
                    if (headerDateTimeInterval !== null) {
                        clearInterval(headerDateTimeInterval);
                    }
                    headerDateTimeInterval = setInterval(updateHeaderDateTime, 1000);
                }

                // Always re-attach event listeners after a render
                // This needs to be called AFTER the DOM is updated by innerHTML
                attachEventListeners();

                // Special case for inventory page autocomplete
                if (appState.currentView === 'inventory') {
                    attachInventorySearchAutocomplete();
                }
            } catch (error) {
                console.error('renderApp error:', error);
                setTimeout(() => {
                    showModal('An error occurred. Please refresh the app.', 'error').catch(e => console.error(e));
                }, 100);
            }
        }

        // Safe modal system to replace alert/confirm - non-blocking
        function showModal(message, type = 'info') {
            return new Promise((resolve) => {
                try {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.5); z-index: 9999;
                        display: flex; align-items: center; justify-content: center;
                        pointer-events: all;
                    `;
                    
                    const colors = {
                        info: '#0e4a7c',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        success: '#10b981'
                    };
                    
                    const color = colors[type] || colors.info;
                    
                    modal.innerHTML = `
                        <div style="background: var(--surface); border-radius: 0.5rem; padding: 2rem; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); color: var(--text-primary);">
                            <p style="margin: 0 0 1.5rem 0; font-size: 1rem; line-height: 1.5;">${String(message).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            <button onclick="this.closest('[data-silhouette-modal]').remove()" style="background: ${color}; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.25rem; cursor: pointer; font-weight: 600; width: 100%;" data-modal-close>OK</button>
                        </div>
                    `;
                    modal.dataset.silhouetteModal = 'true';
                    document.body.appendChild(modal);
                    
                    const btn = modal.querySelector('[data-modal-close]');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            modal.remove();
                            resolve();
                        });
                    }
                } catch (e) {
                    console.error('showModal error:', e);
                    resolve();
                }
            });
        }

        // Small non-blocking toast for status messages
        function showToast(message, type = 'info', duration = 1200) {
            try {
                const colors = { info: '#0e4a7c', warning: '#f59e0b', error: '#ef4444', success: '#10b981' };
                const color = colors[type] || colors.info;
                const toast = document.createElement('div');
                toast.style.cssText = `position: fixed; right: 20px; bottom: 20px; background: ${color}; color: white; padding: 0.6rem 1rem; border-radius: 6px; z-index: 10000; box-shadow: 0 6px 18px rgba(0,0,0,0.15); font-weight: 600;`;
                toast.textContent = String(message).slice(0, 200);
                document.body.appendChild(toast);
                setTimeout(() => { try { toast.remove(); } catch(e){} }, duration);
            } catch (e) { console.error('showToast error:', e); }
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                try {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.5); z-index: 9999;
                        display: flex; align-items: center; justify-content: center;
                        pointer-events: all;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: var(--surface); border-radius: 0.5rem; padding: 2rem; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); color: var(--text-primary);">
                            <p style="margin: 0 0 1.5rem 0; font-size: 1rem; line-height: 1.5;">${String(message).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button data-modal-cancel style="background: var(--border); color: var(--text-primary); border: none; padding: 0.5rem 1.5rem; border-radius: 0.25rem; cursor: pointer; font-weight: 600;">Cancel</button>
                                <button data-modal-confirm style="background: var(--primary); color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.25rem; cursor: pointer; font-weight: 600;">Confirm</button>
                            </div>
                        </div>
                    `;
                    modal.dataset.silhouetteModal = 'true';
                    document.body.appendChild(modal);
                    
                    const confirmBtn = modal.querySelector('[data-modal-confirm]');
                    const cancelBtn = modal.querySelector('[data-modal-cancel]');
                    
                    if (confirmBtn) {
                        // Prevent propagation and add a mousedown blocker to avoid click bleed-through
                        confirmBtn.addEventListener('mousedown', (ev) => { ev.stopPropagation(); ev.preventDefault(); }, { passive: false });
                        confirmBtn.addEventListener('click', (ev) => {
                            ev.preventDefault(); ev.stopPropagation(); try { document.activeElement && document.activeElement.blur(); } catch(e) {}
                            // Delay removal/resolution more conservatively to avoid click bleed-through
                            setTimeout(() => {
                                try { modal.remove(); } catch(e) {}
                                resolve(true);
                            }, 300);
                        });
                    }
                    
                    if (cancelBtn) {
                        cancelBtn.addEventListener('mousedown', (ev) => { ev.stopPropagation(); ev.preventDefault(); }, { passive: false });
                        cancelBtn.addEventListener('click', (ev) => {
                            ev.preventDefault(); ev.stopPropagation();
                            setTimeout(() => {
                                try { modal.remove(); } catch(e) {}
                                resolve(false);
                            }, 300);
                        });
                    }
                } catch (e) {
                    console.error('showConfirm error:', e);
                    resolve(false);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', async () => {
            loadPreferences();
            await loadData();
            renderApp();

            // Add an event listener to save drafts before the app closes
            window.addEventListener('beforeunload', (e) => {
                if (appState.currentView === 'billing' && appState.billingData.patientName) {
                    saveDraft();
                }
            });

            window.addEventListener("message", event => {
                if (event.data === "force-save") {
                    saveData();
                }
            });

            // If the app regains focus (e.g., user restores/minimizes), attempt to recover UI
            window.addEventListener('focus', () => {
                try {
                    console.info('Window focused - running recoverUI');
                    recoverUI();
                } catch(e) { console.error(e); }
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    try {
                        console.info('Visibility changed to visible - running recoverUI');
                        recoverUI();
                    } catch(e) { console.error(e); }
                }
            });

            // Monitor DOM for suspicious large-scale disabling of inputs and auto-recover
            try {
                const observer = new MutationObserver(mutations => {
                    let disabledCount = 0;
                    mutations.forEach(m => {
                        if (m.type === 'attributes' && (m.attributeName === 'disabled' || m.attributeName === 'style')) {
                            const target = m.target;
                            if (target && (target.disabled === true || (window.getComputedStyle(target).pointerEvents === 'none'))) {
                                // increment if many elements are disabled
                                disabledCount++;
                            }
                        }
                    });
                    if (disabledCount > 5) {
                        console.warn('MutationObserver detected multiple disabled elements, running recoverUI');
                        try { recoverUI(); clearAllEventListeners(); renderApp(); } catch(e) { console.error(e); }
                    }
                });
                observer.observe(document.body, { subtree: true, attributes: true, attributeFilter: ['disabled', 'style'] });
            } catch(e) { console.error('Observer init failed:', e); }
        });
    </script>
</body>
</html>